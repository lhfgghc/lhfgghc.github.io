<!doctype html><html itemscope lang=en-us itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=theme-name content="hugoplate"><link rel="shortcut icon" href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_96x0_resize_lanczos_3.png type=image/x-icon><link rel=icon href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_96x0_resize_lanczos_3.png type=image/x-icon><link rel=icon type=image/png sizes=48x48 href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_48x0_resize_lanczos_3.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_96x0_resize_lanczos_3.png><link rel=apple-touch-icon sizes=144x144 href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_144x0_resize_lanczos_3.png><link rel=manifest href=/manifest.webmanifest><meta name=msapplication-TileColor content="#ddd"><meta name=theme-color content="#ffffff"><base href=https://lhfgghc.github.io/en/blog/thds/><title>【项目笔记】基于MQTT和ESP的温湿度监测系统</title>
<meta name=keywords content="Boilerplate,Hugo"><meta name=description content="this is meta description"><meta name=author content="zeon.studio"><meta property="og:image" content="https://lhfgghc.github.io/images/og-image.png"><meta name=twitter:image content="https://lhfgghc.github.io/images/og-image.png"><meta name=twitter:card content="summary_large_image"><meta property="og:image:width" content="900"><meta property="og:image:height" content="600"><meta property="og:image:type" content="image/
        .png
      "><meta property="og:title" content="【项目笔记】基于MQTT和ESP的温湿度监测系统"><meta property="og:description" content="this is meta description"><meta property="og:type" content="website"><meta property="og:url" content="https://lhfgghc.github.io/en/blog/thds/"><meta name=twitter:title content="【项目笔记】基于MQTT和ESP的温湿度监测系统"><meta name=twitter:description content="this is meta description"><script>let indexURL="https://lhfgghc.github.io/en/searchindex.json",includeSectionsInSearch=["blog"],search_no_results="未找到结果",search_initial_message="输入内容以搜索"</script><meta http-equiv=x-dns-prefetch-control content="on"><link rel=preconnect href=https://use.fontawesome.com crossorigin><link rel=preconnect href=//cdnjs.cloudflare.com><link rel=preconnect href=//www.googletagmanager.com><link rel=preconnect href=//www.google-analytics.com><link rel=dns-prefetch href=https://use.fontawesome.com><link rel=dns-prefetch href=//ajax.googleapis.com><link rel=dns-prefetch href=//cdnjs.cloudflare.com><link rel=dns-prefetch href=//www.googletagmanager.com><link rel=dns-prefetch href=//www.google-analytics.com><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//connect.facebook.net><link rel=dns-prefetch href=//platform.linkedin.com><link rel=dns-prefetch href=//platform.twitter.com><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600&family=Signika:wght@500;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><link href="/css/style.min.4c1d4c3120637c4b33d33d38988a2525a8e15057b5ab0cfa95ce5147d4c95adc.css" integrity="sha256-TB1MMSBjfEsz0z04mIolJajhUFe1qwz6lc5RR9TJWtw=" rel=stylesheet><link defer async rel=stylesheet href="/css/style-lazy.min.ec14d2549e8e0fbaf9af20dcc88fad37fb352e5bd5978a801dc1c3f5a5922174.css" integrity="sha256-7BTSVJ6OD7r5ryDcyI+tN/s1LlvVl4qAHcHD9aWSIXQ=" media=print onload='this.media="all",this.onload=null'></head><body><header class="header sticky top-0 z-30"><nav class="navbar container"><div class=order-0><a class="navbar-brand block" href=/en/><img fetchpriority=high decoding=async class="img logo-light" width=160 height=32 src=/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_lanczos_3.png"'>
<img fetchpriority=high decoding=async class="img logo-dark" width=160 height=32 src=/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_lanczos_3.png"'></a></div><input id=nav-toggle type=checkbox class=hidden>
<label for=nav-toggle class="order-3 cursor-pointer flex items-center lg:hidden text-dark dark:text-white lg:order-1"><svg id="show-button" class="h-6 fill-current block" viewBox="0 0 20 20"><title>Menu Open</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0V0z"/></svg><svg id="hide-button" class="h-6 fill-current hidden" viewBox="0 0 20 20"><title>Menu Close</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></label><ul id=nav-menu class="navbar-nav order-3 hidden lg:flex w-full pb-6 lg:order-1 lg:w-auto lg:space-x-2 lg:pb-0 xl:space-x-8"><li class=nav-item><a class=nav-link href=/en/>主页</a></li><li class=nav-item><a class=nav-link href=/en/blog/>学习笔记</a></li><li class=nav-item><a class=nav-link href=/en/about/>个人信息</a></li><li class="nav-item nav-dropdown group relative"><span class="nav-link
inline-flex items-center">其它<svg class="h-4 w-4 fill-current" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg></span><ul class="nav-dropdown-list lg:group-hover:visible lg:group-hover:opacity-100"><li class=nav-dropdown-item><a class=nav-dropdown-link href=/en/elements/>样式Draft</a></li><li class=nav-dropdown-item><a class=nav-dropdown-link href=/en/privacy-policy/>相关说明</a></li><li class=nav-dropdown-item><a class=nav-dropdown-link href=/en/categories/>笔记分类</a></li></ul></li></ul><div class="order-1 ml-auto flex items-center md:order-2 lg:ml-0"><button aria-label=search class="border-border text-dark hover:text-primary dark:border-darkmode-border mr-5 inline-block border-r pr-5 text-xl dark:text-white dark:hover:text-darkmode-primary" data-target=search-modal>
<i class="fa-solid fa-search"></i></button><div class="theme-switcher mr-5"><input id=theme-switcher data-theme-switcher type=checkbox>
<label for=theme-switcher><span class=sr-only>theme switcher</span>
<span><svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 opacity-100 dark:opacity-0" viewBox="0 0 56 56" fill="#fff" height="16" width="16"><path d="M30 4.6c0-1-.9-2-2-2a2 2 0 00-2 2v5c0 1 .9 2 2 2s2-1 2-2zm9.6 9a2 2 0 000 2.8c.8.8 2 .8 2.9.0L46 13a2 2 0 000-2.9 2 2 0 00-3 0zm-26 2.8c.7.8 2 .8 2.8.0.8-.7.8-2 0-2.9L13 10c-.7-.7-2-.8-2.9.0-.7.8-.7 2.1.0 3zM28 16A12 12 0 0016 28a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0028 16zm23.3 14c1.1.0 2-.9 2-2s-.9-2-2-2h-4.9a2 2 0 00-2 2c0 1.1 1 2 2 2zM4.7 26a2 2 0 00-2 2c0 1.1.9 2 2 2h4.9c1 0 2-.9 2-2s-1-2-2-2zm37.8 13.6a2 2 0 00-3 0 2 2 0 000 2.9l3.6 3.5a2 2 0 002.9.0c.8-.8.8-2.1.0-3zM10 43.1a2 2 0 000 2.9c.8.7 2.1.8 3 0l3.4-3.5c.8-.8.8-2.1.0-2.9s-2-.8-2.9.0zm20 3.4c0-1.1-.9-2-2-2a2 2 0 00-2 2v4.9c0 1 .9 2 2 2s2-1 2-2z"/></svg><svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 opacity-0 dark:opacity-100" viewBox="0 0 24 24" fill="none" height="16" width="16"><path fill="#000" fill-rule="evenodd" clip-rule="evenodd" d="M8.2 2.2c1-.4 2 .6 1.6 1.5-1 3-.4 6.4 1.8 8.7a8.4 8.4.0 008.7 1.8c1-.3 2 .5 1.5 1.5v.1A10.3 10.3.0 0112.4 22 10.3 10.3.0 013.2 6.7c1-2 2.9-3.5 4.9-4.4z"/></svg></span></label></div><script>var darkMode=!1,themeSwitch;window.matchMedia("(prefers-color-scheme: dark)").matches&&(darkMode=!0),localStorage.getItem("theme")==="dark"?darkMode=!0:localStorage.getItem("theme")==="light"&&(darkMode=!1),darkMode&&document.documentElement.classList.toggle("dark"),themeSwitch=document.querySelectorAll("[data-theme-switcher]"),document.addEventListener("DOMContentLoaded",()=>{[].forEach.call(themeSwitch,function(e){e.checked=!!darkMode,e.addEventListener("click",()=>{document.documentElement.classList.toggle("dark"),localStorage.setItem("theme",document.documentElement.classList.contains("dark")?"dark":"light")})})})</script></div></nav></header><div class=search-modal aria-hidden=true style=--color-primary:#121212><div data-target=close-search-modal class=search-modal-overlay></div><div class=search-wrapper data-image=true data-description=true data-tags=true data-categories=true><div class=search-wrapper-header><label for=search-modal-input style=margin-top:-1px><span class=sr-only>search icon</span>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="18" width="18" class="search-icon" data-type="search"><path fill="currentcolor" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8.0 45.3s-32.8 12.5-45.3.0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9.0 208S93.1.0 208 0 416 93.1 416 208zM208 352a144 144 0 100-288 144 144 0 100 288z"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="18" width="18" class="search-reset" data-type="reset"><path fill="currentcolor" d="M256 512A256 256 0 10256 0a256 256 0 100 512zM175 175c9.4-9.4 24.6-9.4 33.9.0l47 47 47-47c9.4-9.4 24.6-9.4 33.9.0s9.4 24.6.0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6.0 33.9s-24.6 9.4-33.9.0l-47-47-47 47c-9.4 9.4-24.6 9.4-33.9.0s-9.4-24.6.0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6.0-33.9z"/></svg>
</label><input id=search-modal-input type=text data-search-input autocomplete=off aria-label=Search placeholder=搜索></div><div class=search-wrapper-body><div class=search-result data-search-result></div><span class=search-result-empty>输入内容以搜索</span></div><div class=search-wrapper-footer><span><kbd><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentcolor" viewBox="0 0 16 16"><path d="M3.204 11h9.592L8 5.519 3.204 11zm-.753-.659 4.796-5.48a1 1 0 011.506.0l4.796 5.48c.566.647.106 1.659-.753 1.659H3.204a1 1 0 01-.753-1.659z"/></svg>
</kbd><kbd><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentcolor" style="margin-top:1px" viewBox="0 0 16 16"><path d="M3.204 5h9.592L8 10.481 3.204 5zm-.753.659 4.796 5.48a1 1 0 001.506.0l4.796-5.48c.566-.647.106-1.659-.753-1.659H3.204a1 1 0 00-.753 1.659z"/></svg>
</kbd>导航
</span><span><kbd><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentcolor" style="display:inline-block" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M14.5 1.5a.5.5.0 01.5.5v4.8a2.5 2.5.0 01-2.5 2.5H2.707l3.347 3.346a.5.5.0 01-.708.708l-4.2-4.2a.5.5.0 010-.708l4-4a.5.5.0 11.708.708L2.707 8.3H12.5A1.5 1.5.0 0014 6.8V2a.5.5.0 01.5-.5z"/></svg>
</kbd>选择
</span><span class=search-result-info></span>
<span data-target=close-search-modal><kbd>ESC</kbd> 关闭</span></div></div></div><main><section class="section pt-7"><div class=container><div class="row justify-center"><article class=lg:col-10><h1 class="h2 mb-4">【项目笔记】基于MQTT和ESP的温湿度监测系统</h1><ul class=mb-4><li class="mr-4 inline-block"><a href=/en/authors/liang-hangfeng/><i class="fa-regular fa-circle-user mr-2"></i>Liang Hangfeng</a></li><li class="mr-4 inline-block"><i class="fa-regular fa-folder mr-2"></i>
<a href=/en/categories/%e9%a1%b9%e7%9b%ae%e7%ac%94%e8%ae%b0/>项目笔记</a></li><li class="mr-4 inline-block"><i class="fa-regular fa-clock mr-2"></i>
January 5, 2024</li></ul><div class="content mb-10"><h4 id=摘要>摘要</h4><p>环境温湿度监测在许多行业中具有重要意义，包括农业、物流、仓储、医疗等众多重要领域，因此本次课程设计选定的主题是基于NB-IoT的无线温湿度监测系统设计与实现。在项目中，我们团队着眼于无线监测节点的设计，通过整合ESP8266、SIM7020模块和DHT22模块，成功实现了NB-IoT联网和温湿度数据的获取。此外，前后端的协同工作也是项目中不可或缺的一部分，我们实现了从硬件到前后端的全面开发，包括数据的存储与渲染，并实现了一系列功能需求，体现了系统功能的复杂性与可用性。</p><p>在硬件设计方面，ESP8266的编程为监测节点提供了智能控制和数据处理功能。而SIM7020模块的选择使得监测节点能够实现NBIoT联网，为远程通信提供了高效且可靠的手段。结合DHT22模块，成功实现了环境温湿度信息的高精度采集，为系统提供了全面感知环境变化的能力。这一节点设计不仅是系统的核心，也为整个监测系统的稳定运行提供了可靠保障。</p><p>在软件平台的选择上，我们采用了Visual Studio Code、ArduinoIDE和IDEA等工具，分别用于前端代码的编写与测试，硬件代码的编写与烧录，以及后端代码的编写。这些工具的灵活运用使得我们能够高效地实现系统的各个模块，体现了团队在物联网开发技巧上的熟练掌握。与此同时，我们成功配置了云服务器，安装了数据库，并搭建了MQTT服务器用于消息汇总与传递。这一系列操作使得我们更深刻地理解了云计算和物联网的结合，为系统的可扩展性和数据处理提供了强大支持。</p><p>最后，通过对整个设计过程的总结，我们团队获得了丰富的物联网开发经验。从硬件到前后端，我们不仅掌握了各类开发技巧，还培养了解决实际问题的能力。项目的成功实施不仅是对所学知识的应用，更是对团队整体实际能力的全面提升。</p><p>Environmental temperature and humidity monitoring holds significant importance in various industries, including agriculture, logistics, warehousing, healthcare, and many other critical sectors. Therefore, the chosen theme for this course project is the design and implementation of a wireless temperature and humidity monitoring system based on NB-IoT (Narrowband Internet of Things). In this project, our team focused on the design of wireless monitoring nodes, successfully integrating the ESP8266, SIM7020 module, and DHT22 module to achieve NB-IoT connectivity and temperature-humidity data acquisition. Additionally, the collaboration between the frontend and backend was an integral part of the project. We accomplished comprehensive development from hardware to frontend and backend, including data storage and rendering, implementing a series of functional requirements that showcase the complexity and usability of the system.</p><p>In terms of hardware design, the programming of the ESP8266 provides intelligent control and data processing capabilities for the monitoring nodes. The selection of the SIM7020 module enables NB-IoT connectivity, offering an efficient and reliable means for remote communication. Combining the DHT22 module, we successfully achieved high-precision collection of environmental temperature and humidity information, providing the system with the ability to comprehensively perceive changes in the environment. This node design is not only the core of the system but also ensures the stable operation of the entire monitoring system.</p><p>For the software platform selection, we used tools such as Visual Studio Code, Arduino IDE, and IDEA for frontend code writing and testing, hardware code writing and burning, and backend code writing, respectively. The flexible use of these tools allowed us to efficiently implement various modules of the system, demonstrating the team&rsquo;s proficiency in IoT development skills. At the same time, we successfully configured a cloud server, installed a database, and set up an MQTT server for message aggregation and transmission. This series of operations deepened our understanding of the integration of cloud computing and IoT, providing robust support for the system&rsquo;s scalability and data processing.</p><p>In conclusion, through summarizing the entire design process, our team gained rich experience in IoT development. From hardware to frontend and backend, we not only mastered various development skills but also cultivated the ability to solve practical problems. The successful implementation of the project is not only an application of acquired knowledge but also a comprehensive enhancement of the overall capabilities of the team.</p><h3 id=1-设计背景与目标>1. 设计背景与目标</h3><h4 id=11-设计背景>1.1 设计背景</h4><p>环境温湿度监测在许多行业中具有重要意义，包括农业、物流、仓储、医疗等众多重要领域。通过实时监测环境的温度和湿度，可以提前预警并及时采取措施，保证设备的正常运行，提高生产效率，防止质量问题的发生。除此之外，全球气候变化和环境问题引起了广泛关注，气温升高、极端天气和自然灾害频发成为不容忽视的现实。</p><p>在当下，许多企业和机构依然采用传统的手工监测模式，投入数量有限的监测点，并投入一定量的人力，导致监测数据出现获取不及时、准确性低等状况。这类方式存在一定的弊端，包括高昂的成本、效率低下、难以实现全面覆盖等问题。但随着对环境温湿度的要求不断提高，许多行业迫切需要一种可靠且智能化的环境温湿度监测报警系统。</p><p>这种系统将基于物联网技术，通过部署一定数量的传感器设备，在关键位置实时监测环境的温度和湿度，通过数据采集和处理，不仅可以实时监测环境参数，还可以根据预设条件自动触发报警机制，实现对温湿度的全面监测和分析，为用户提供实时的环境状态信息、报警提示和环境状态预测，帮助用户尽早发现异常情况并采取相应的措施。</p><h4 id=12-设计目标>1.2 设计目标</h4><p>本次课程设计题目为《基于NB-IoT的无线温湿度监测系统设计与实现》，包含以下若干需要实现的设计目标。</p><ol><li>基于NB-IoT技术进行应用开发，实现一个完善的智能温湿度监测系统；</li><li>掌握基本的物联网开发技术，包括无线节点的代码设计与写入、通过无线信道进行信息传输；</li><li>熟悉NB-IoT的基本原理与常见硬件模块的使用方式；</li><li>熟悉各类常见传感器的电气特性与使用方法，例如DHT系列传感器、蜂鸣器等；</li><li>掌握基础全栈开发技术，学习常用前后端框架，以完成应用平台的开发；</li></ol><h3 id=2-课程设计器材>2. 课程设计器材</h3><p>选择合适的硬件平台和软件平台可以为本次课程设计提供极大的设计便利，利于最终的智能温湿度监测系统的实现。</p><h4 id=21-硬件平台>2.1 硬件平台</h4><p>硬件平台的选用将综合考虑性能、稳定性、成本、使用门槛、平台拓展性等方面。节点的开发板方面，本次实验选用ESP8266模块，NB-IoT联网方面选用SIM7020模块，温湿度监测方面选用DHT22模块。这些器件的主要特点如下。</p><ol><li>ESP8266：ESP8266是一款低成本、低功耗的开发模组，具有高性能的Wi-Fi模块，内部集成MCU以实现串口通信。选用该模块的原因包括：成本较低，试验代价较小；具有Wi-Fi模块，联网方便，便于开发过程中的信息传输调试。</li><li>SIM7020：SIM7020模块是一种低功耗、小型化的NB-IoT模块，专为物联网应用设计，可以用于远程设备的低功耗、长距离通信。具有低功耗、广覆盖、高连接性的特点。选用SIM7020模块可以实现设备与云端的可靠、高效的通信，使得温湿度监测系统可以在不同地点进行数据传输。</li><li>DHT22：DHT22是一种数字温湿度传感器，能够测量环境中的温度和湿度，并通过数字信号输出这些数据，是一种成本效益高且易于使用的温湿度传感器。它提供了对环境条件的准确监测，是制作低成本、高效率温湿度监测系统的理想选择。</li></ol><h4 id=22-软件平台>2.2 软件平台</h4><ol><li>Arduino IDE：Arduino是一种开源电子原型平台，包括硬件和软件，它使用简单的C/C++语言编写，为物联网和嵌入式系统提供了一种易于使用的开发环境。使用其集成开发环境（IDE）能够非常快速地开发并测试物联网设备的硬件代码，故本次课程设计主要使用Arduino作为硬件的开发平台。</li><li>IDEA：IntelliJ IDEA是一款由JetBrains开发的Java集成开发环境，适用于后端的代码编写、测试、打包，有助于后端的开发效率。</li><li>Visual Studio Code：VSCode是一款轻量级的开源代码编辑器，支持多种编程语言，本次课程设计主要使用其进行前端代码的开发，它提供了丰富的前端插件，简化了开发流程。</li><li>EMQX：EMQX是一个开源的分布式物联网消息中间件，支持MQTT协议，适用于大规模物联网应用。EMQX作为消息队列服务器，为各节点提供了可靠的消息传递机制，且可以自主进行EMQX服务器的搭建，因而本次实验也选用了EMQX服务器作为消息传输的载体。</li></ol><h3 id=3-设计方案>3. 设计方案</h3><h4 id=31-思路分析>3.1 思路分析</h4><p>对于无线智能温湿度监测系统，需要考虑以下若干方面：不同位置的温湿度信息获取、温湿度信息的汇总与存储、数据的合理处理与呈现。</p><p>对于温湿度信息的获取，需要使用相关的温湿度信息监测模块，并连接到某一节点上，节点需要通过温湿度传感器获取温湿度信息，并对信息进行合理的处理，包括异常值的筛选、监测时间的记录。且每个节点之间是独立且可分辨的，可以互不干扰地进行温湿度信息的获取，通过多节点实现不同空间位置上的监测。</p><p>对于温湿度信息的汇总，需要考虑节点之间的信息共享，因此需要网络的建立，本次课程设计需要使用窄带物联网进行通信，因此各节点需要配备NB-IoT的通信模块。除此之外，各传感节点中获取的信息各不相同，且具有异步特性，故考虑使用消息队列服务器进行信息的汇总处理，本次设计采用EMQX服务器作为消息汇总的中心，各节点共同订阅某一主题，并在获取到温湿度数据后将数据进行打包（添加节点编号、时间戳等信息），并统一通过NB-IoT发送至EMQX服务器的特定主题，以实现信息的共同发布与汇总。</p><p>对于数据的存储，考虑使用后端程序（本次课程设计选用springboot框架）实现，与各传感节点类似，后端程序也应作为用户订阅EMQX服务器中的指定主题，但应作为信息的接收者，在接收到传感器的信息发布后进行消息的接收，并连接数据库（选用MySQL）进行数据的存储。</p><p>对于数据的处理与呈现，考虑使用前端Web应用进行报表的呈现，同时提供给用户操作数据的接口，包括阈值设定，动态报表呈现，数据的导出等，前端代码需向后端进行数据的请求，后端程序也应当根据前端的需求提供合理可用的接口。</p><h4 id=32-系统架构>3.2 系统架构</h4><p>根据3.1节中所述的设计思路，可以进行系统整体的架构图的呈现，大致结构如图3.1所示。</p><p>【图3.1 系统整体逻辑结构】</p><p><img alt=image-1 src=/images/THDS/image-1.png></p><p>为更好地说明系统整体的运行方式，考虑对以下过程进行流程分析：从某一节点采集数据开始直至数据呈现于用户。流程图如图3.2所示。</p><p>【图3.2 系统运行流程图】</p><p><img alt=image-2 src=/images/THDS/image-2.png></p><p>可以确定，硬件端与软件端之间的运行相对独立，即前文所提及的硬件端的信息发布具有异步性，因此软件段需要在运行后持续等待硬件层面的数据传输。</p><h4 id=33-功能设计>3.3 功能设计</h4><p>在正式进行课程设计的开发前，我们进行了系统的系列需求分析，确定了一系列面向用户的功能。</p><p>该系统的核心功能包括：实时监测、数据分析与渲染呈现、异常报警设置与通知、历史数据查询、日志报告导出等部分。具体的功能描述如下表3.1所示。</p><table><thead><tr><th style=text-align:center>功能概述</th><th style=text-align:center>描述</th></tr></thead><tbody><tr><td style=text-align:center>实时监测</td><td style=text-align:center>系统具备实时监测环境温湿度的功能，具有时效性。</td></tr><tr><td style=text-align:center>数据分析与渲染呈现</td><td style=text-align:center>系统能够对采集到的温湿度数据进行分析，提供直观的趋势展示，例如二维折线、三维热力图等。</td></tr><tr><td style=text-align:center>异常报警设置与通知</td><td style=text-align:center>系统支持自定义的报警规则设置。温湿度数据超出设定的阈值将触发报警机制，并以短信、电子邮件等形式通知相关人员。</td></tr><tr><td style=text-align:center>历史数据查询</td><td style=text-align:center>系统将保存一定时间范围内的历史数据，可以通过用户界面查询历史温湿度数据</td></tr><tr><td style=text-align:center>日志报告导出</td><td style=text-align:center>系统根据指定的时间间隔进行报告的生成，并提供导出服务器，包括数据分析表、异常情况统计</td></tr><tr><td style=text-align:center>设备管理</td><td style=text-align:center>系统提供对所有监测设备的统一管理服务平台，供管理员进行设备管理、系统设置</td></tr></tbody></table><h4 id=34-技术栈选型>3.4 技术栈选型</h4><p>本次课程设计选用的技术栈列举如下。</p><ul><li><p>服务器端</p><p>Spring boot、MyBatis、Spring Security、Mysql、Redis、EMQX</p></li><li><p>Web端</p><p>ES6、Vue、Vuex、Vue-router、Vue-cli、Axios、Element-ui</p></li><li><p>硬件端</p><p>ESP、Arduino、SIM、DHT</p></li></ul><h3 id=4-设计过程>4. 设计过程</h3><p>设计实现包括以下若干步骤：服务器搭建、硬件端设计实现、前端页面设计、后端接口提供。</p><h4 id=41-服务器搭建>4.1 服务器搭建</h4><h5 id=411-服务器选用>4.1.1 服务器选用</h5><p>考虑到数据库的配置、MQTT服务器的搭建需要对外提供便捷的接口，同时方便对其进行维护，本次课设考虑将上述内容部署于云服务器中。选用的云服务器来自于华为云ECS，配置4核CPU与8G内存，预装操作系统为CentOS7.6 64位。如图4.1所示。</p><p>【图4.1 云服务器选用规格信息】</p><p><img alt=image-3 src=/images/THDS/image-3.png></p><h5 id=412-数据库搭建>4.1.2 数据库搭建</h5><p>考虑到无线节点获取的温湿度数据需要在数据库中进行存储，因此需要在ECS上进行数据库的配置与安装，本次设计选用的数据库版本为MySQL8.0.35 for Linux on aarch64。在云服务器上进行数据库的安装，并保证数据库服务启动并能够通过3306端口进行访问，如图4.2所示，数据库服务启动。</p><p>【图4.2 MySQL安装与服务启动】</p><p><img alt=image-4 src=/images/THDS/image-4.png></p><p>由于给定的云服务器具有公网IP，因此可以远程对该数据库进行访问连接，本次实验采用HeidiSQL作为数据设计的管理工具，使用HeidiSQL连接至云端数据库，首先通过root用户创建了一个名为mysql_mqtt的数据库，以存储后续的数据表，并作为后端连接的主数据库，进行数据表的设计，考虑到这类应用场景数据类型单一，只考虑设置两张数据表，分别为记录record与硬件信息表hardware。</p><p>对于硬件信息表，其中包含字段为：硬件ID（主键）、温度阈值上下限、湿度阈值上下限、硬件类型、硬件状态、收集数据总数、硬件描述，如图4.3所示。</p><p>【图4.3 硬件信息表hardware内容】</p><p><img alt=image-5 src=/images/THDS/image-5.png></p><p>对于记录表，其中包含字段为：记录ID（主键）、来源设备（依赖于硬件信息表）、时间戳信息、温度信息、湿度信息，如图4.4所示。</p><p>【图4.4 记录表record内容】</p><p><img alt=image-6 src=/images/THDS/image-6.png></p><h5 id=413-mqtt服务器搭建>4.1.3 MQTT服务器搭建</h5><p>本次课设选用MQTT服务器作为消息队列服务器，考虑到维护和测试的方便，故自主进行MQTT服务器的搭建，与数据库服务器类似对外提供EMQX服务，接受各用户的订阅与消息共享。选用的EMQX服务的版本为5.1.6，在云服务器上完成EMQX服务的安装后，确认EMQX服务运行，如图4.5所示。</p><p>【图4.5 EMQX服务运行】</p><p><img alt=image-7 src=/images/THDS/image-7.png></p><p>使用EMQX服务提供的18083端口可以访问MQTT服务器的管理后台，便于对集群信息进行查看，例如连接数目、连接状况、数据传输量等，便于后续的设计。后台内容概览如图4.6所示。为方便对具体的消息内容进行查看与确认，我们选用了MQTTX客户端进行服务器的连接与主题的监测，从而能够更好地确定消息发布状态。</p><p>【图4.6 EMQX服务的管理后台】</p><p><img alt=image-8 src=/images/THDS/image-8.png></p><h4 id=42-硬件端搭建>4.2 硬件端搭建</h4><h5 id=421-nb-iot联网>4.2.1 NB-IoT联网</h5><p>使用SIM7020模块进行，选用合适的NB-IoT的SIM卡，插入SIM7020模块中，按照图4.7的形式将SIM7020模块与ESP8266开发板进行连接。</p><p>【图4.7 ESP8266模块与SIM7020连接】</p><p><img alt=image-9 src=/images/THDS/image-9.png></p><p>通过AT指令集对SIM7020模块进行控制，通过ESP8266模块进行AT指令集的发送，相关代码内容如图4.8所示。</p><p>【图4.8 通过AT指令集进行NB-IoT联网并连接至MQTT服务器】</p><p><img alt=image-10 src=/images/THDS/image-10.png></p><h5 id=422-dht22模块安装>4.2.2 DHT22模块安装</h5><p>DHT22模块仅包含VCC、GND和一个单线的数据IO口，将其连接到ESP8266上（引脚4，对应的代码编号为2）。代码层面，加载DHT相关的库，并定义一个DHT对象，设置DHT类型与DHT的IO端口号。完成连接后可以通过DHT对象的readHumidity()和readTemperature()函数获取温湿度信息，若温湿度信息异常，则返回NaN，需要对其异常值进行处理。代码内容如图4.9所示。通过getTH函数可以获取环境的温湿度，并存储于全局变量中，以供其余功能函数进行数据的获取。</p><p>【图4.9 DHT22的连接与温湿度获取】</p><p><img alt=image-11 src=/images/THDS/image-11.png></p><h5 id=423-mqtt消息发布>4.2.3 MQTT消息发布</h5><p>通过代码设置模块对某个主题进行订阅，这里选用的主题名称为“eps8266-1912”，将messageBuff中的内容通过窄带物联网发送至MQTT服务器的指定主题中，其中messageBuff数组中的内容为getJson函数生成的，该函数用于将一系列硬件与温湿度信息封装成Json格式存储到messageBuff之中。代码内容如图4.10所示。</p><p>【图4.10 通过NB-IoT进行信息订阅与发布】</p><p><img alt=image-12 src=/images/THDS/image-12.png></p><h5 id=424-wifi版本编写>4.2.4 WiFi版本编写</h5><p>在设计过程中，发现NB-IoT相关组件的连接不良，考虑编写一份使用WiFi联网的硬件代码，仅与NB-IoT版本在联网部分的部分代码有所差异。因此在测试过程中，也使用了基于WiFi联网的硬件获取方式。该部分内容主要进行了联网函数connectWiFi()函数的编写，其中设置了WiFi信息以供ESP8266进行循环连接。主函数内容如图4.11所示。由于篇幅受限，不对每一个函数的细节进行展示，以注释的形式说明其功能。</p><p>【图4.11 WiFi版本的主函数】</p><p><img alt=image-13 src=/images/THDS/image-13.png></p><h5 id=425-子功能测试>4.2.5 子功能测试</h5><p>以上的内容实现了无线节点的温湿度信息获取，并能够通过窄带物联网进行MQTT服务器的连接，从而进行数据的发布，为测试该子功能的正确性，考虑使用MQTTX客户端进行同一主题的订阅，并观察获取的数据准确性。如图4.12所示，可以看到成功实现了节点环境温度的监测，并以Json格式将其发布到了MQTT服务器中，且其余订阅该主题的模块或软件均能够获取该信息。</p><p>【图4.12 数据发布功能的测试】</p><p><img alt=image-14 src=/images/THDS/image-14.png></p><h4 id=43-前端设计>4.3 前端设计</h4><h5 id=431-页面布局>4.3.1 页面布局</h5><p>基于表3.1中所列的各项功能模块，使用VSCode与Vue.js前端框架进行前端界面的代码编写，并使用了ElementUI辅助进行页面的美化与设计。</p><p>网页界面的前端布局大体如图4.13所示。包含侧边导航栏，其中包含了系统主页、设备管理、数据分析、历史数据等子组件。</p><p>【图4.13 前端网页布局】</p><p><img alt=image-15 src=/images/THDS/image-15.png></p><p>对于页面的跳转，采用vue-router实现，路由信息如下图4.14所示，通过导航栏的点击，跳转到不同的路径，从而显示不同的组件内容。</p><p>【图4.14 使用vue-router实现页面跳转】</p><p><img alt=image-16 src=/images/THDS/image-16.png></p><h5 id=432-数据请求>4.3.2 数据请求</h5><p>如图4.13所示，数据尚未进行显示，需要前端向后端发送数据请求，并在前端使用vue的双向绑定功能进行数据渲染，数据请求层面，使用axios进行异步请求。具体地，首先进行axios的二次封装，设置请求的地址与端口（后端服务的地址与端口），再进行api接口的设置，需要定义请求方式（get、put、post、delete）与请求路径，如图4.15所示，为部分数据请求函数。</p><p>在各组件中，只需引入相应的数据请求函数，即可通过axios向指定的后端发送数据请求，并能够在request中获取数据的内容。后续需要在后端中依次提供这类数据的请求接口。</p><p>【图4.15 前端部分数据请求】</p><p><img alt=image-17 src=/images/THDS/image-17.png></p><h5 id=433-设备管理>4.3.3 设备管理</h5><p>在设备管理界面，进行了所有导入系统的无线节点信息的显示，包括唯一标识的设备ID、设备型号、设备状态、发送数据流、温度阈值上下限、湿度阈值上下限、设备描述等，如图4.16所示。同时对每一个设备信息可以进行编辑、删除操作，在此界面中进行设备的添加操作，需注意设备ID需要非重复，系统将会自动监测是否存在该ID的设备发送的信息，若有则进行存储与整合，并实施渲染到前端以提示用户。</p><p>对于该部分的实现，主要采用ElementUI组件进行，数据主要来自于hardware表，其中发送数据量的值筛选自record表。</p><p>【图4.16 设备管理界面设计】</p><p><img alt=image-18 src=/images/THDS/image-18.png></p><h5 id=434-数据分析>4.3.4 数据分析</h5><p>在数据分析界面，以动态报表的形式呈现所有正在工作的监测节点处的温湿度信息，并在图线中给出阈值范围，使得用户能够清晰地观察到温湿度所处的范围，如图4.17所示。具体地，该部分采用echarts组件进行报表的呈现，前端每个一段时间（1s）向后端发送数据请求，查询数据库中新增的数据条目，并添加到显示队列即可实现报表的动态更新，且请求到数据后需要进行数据的筛选，以实现多个设备之间的工作独立性。</p><p>【图4.17 数据分析界面设计】</p><p><img alt=image-19 src=/images/THDS/image-19.png></p><h5 id=435-历史数据>4.3.5 历史数据</h5><p>在该界面中实现的内容较为简单，即将所有records表中的数据以表格的形式在前端进行呈现，并提供排序和筛选操作，使用户可以按照时间或者设备ID等信息查询指定时间段的数据信息，此外提供了报表导出与异常数据导出的功能，能够实现所有数据或异常数据的excel表格导出，方便后续的数据处理。该部分界面设计效果如图4.18所示。</p><p>【图4.18 历史数据界面设计】</p><p><img alt=image-20 src=/images/THDS/image-20.png></p><h4 id=44-后端开发>4.4 后端开发</h4><p>前端的待渲染数据通过axios向后端请求，因此后端程序需要提供合理的数据请求接口，具体地，后端程序需要实现数据库的连接，以在获取温湿度信息后进行数据的转存，同时也需要进行MQTT服务器的连接与主题订阅，以消费者的形式进行消息的获取。</p><h5 id=441-数据库的连接>4.4.1 数据库的连接</h5><p>由于后端框架采用springboot实现，需要在资源文件中进行相关配置的设置（application.yml），包括对数据库的信息配置，在springboot项目的初始化时已经选用添加了MySQL Driver依赖。由于数据库来自于云服务器，根据4.1.2节中的数据库配置，在此需要设置IP为云服务器的公网IP，并设置数据库名为mysql_mqtt，连接到root用户，并给定密码，如图4.19所示。</p><p>在完成配置后springboot程序将在运行时连接至该数据库，且后续Mapper层中的SQL语句将被发送到该数据库中执行，以实现数据的存储与查询。</p><p>【图4.19 后端程序连接数据库】</p><p><img alt=image-21 src=/images/THDS/image-21.png></p><h5 id=442-mqtt服务器的配置>4.4.2 MQTT服务器的配置</h5><p>若想要springboot能够连接MQTT服务器，首先需要导入Maven依赖，具体的依赖名为：spring-integration-mqtt，重新加载Maven依赖后即可实现相关资源的加载。</p><p>与数据库连接类似，MQTT服务器的连接也需要在application.yml文件中进行相关配置的设置，包括服务器所在的IP与服务提供端口，对于MQTT服务端口，在TCP协议下均默认为1883，此外还需要设定连接的id信息，该id需要保证在所有连接到目标服务器的客户端中非重复，最后需要设置订阅的主题。具体配置如下图4.20所示。</p><p>需注意的是，本次课程设计过程中搭建的MQTT服务器并未进行节点的认证操作，因此这里的用户名和密码随机指定即可，服务器端并未对此进行认证。</p><p>【图4.20 后端程序连接MQTT服务器的相关配置】</p><p><img alt=image-22 src=/images/THDS/image-22.png></p><h5 id=443-服务器连接与数据获取>4.4.3 服务器连接与数据获取</h5><p>完成MQTT服务器的基本配置后，需要编写相关函数实现服务器的连接、主题订阅、消息监听与获取等操作，考虑设置一个MQTT消费者的控制类MqttConsumerComfig，提供一些基本的连接、重连函数。</p><p>在加载spring-integration-mqtt依赖后，可以导入MqttClient类，该类的对象实现了一个虚拟的MQTT客户，在实例化对象时，需要设置目标MQTT服务器的IP与端口信息，同时给定唯一标识的客户id，这类信息可以在图4.20中的配置信息中获取，可以通过springboot的@Configuration与@Value注解将配置信息加载到类中的私有变量中，以供类中函数的调用。</p><p>对于连接MQTT服务器的具体配置，可以通过MqttConnectOptions对象进行设置，包括用户名、密码、超时时长、保活时间、断开连接后的处理，最后通过MqttClient对象的connect函数进行配置的设置与连接操作执行即可完成连接。连接成功后再通过subscribe函数进行主题的订阅。</p><p>除此之外，最为重要的操作即为对MqttClient对象进行回调函数的设置，该依赖提供了完整的回调函数的设置格式，抽象于MqttCallback接口中，只需要实现其中的三个抽象函数即可，分别为connectionLost（用于连接丢失后的处理操作设置）、messageArrived（获取信息后的处理）、deliveryComplete（完成发送后的后续处理）。对于deliveryComplete函数，本次课程设置无需进行实现；对于connectionLost函数，通过MqttClient对象的isConnected函数获取连接状态，并调用reconnect函数进行重连，或者直接重新执行connect函数。</p><p>对于messageArrived函数，在主题中有新消息时，会以MqttMessage对象的形式将数据传入该回调函数，MqttMessage对象提供了getPayload函数来获取其中加载的信息内容字符串，随后通过一系列Java操作将其转换为Json格式并获取图4.12中所示的所有信息。</p><p>在获取到所需的所有的数据后，考虑将数据进行封装并存入数据库，这里使用了springboot的三层架构，首先设置了实体类Record，成员变量与数据表record中的字段一一对应，以用于数据的封装，后续定义Service层与Mapper层，在Service层中对外提供插入数据的服务，以insertRecord函数的形式呈现，具体在Mapper层中通过SQL语句进行数据的插入。SQL语句即为：insert into record (froms ,timestamp,temperature,humidty) values (froms ,timestamp,temperature,humidty)，其中values中的数据来自于封装好的Record对象。</p><p>综上完成了MQTT服务器的连接、主题的订阅、消息的监听、数据的存储操作。核心代码内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>connect</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//MQTT客户对象</span>
</span></span><span style=display:flex><span>        client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MqttClient(hostUrl,clientId,<span style=color:#66d9ef>new</span> MemoryPersistence());
</span></span><span style=display:flex><span>        <span style=color:#75715e>//连接配置信息</span>
</span></span><span style=display:flex><span>        MqttConnectOptions options <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MqttConnectOptions();
</span></span><span style=display:flex><span>        options.<span style=color:#a6e22e>setCleanSession</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>        options.<span style=color:#a6e22e>setUserName</span>(username);
</span></span><span style=display:flex><span>        options.<span style=color:#a6e22e>setPassword</span>(password.<span style=color:#a6e22e>toCharArray</span>());
</span></span><span style=display:flex><span>        options.<span style=color:#a6e22e>setConnectionTimeout</span>(100);
</span></span><span style=display:flex><span>        options.<span style=color:#a6e22e>setKeepAliveInterval</span>(20);
</span></span><span style=display:flex><span>        options.<span style=color:#a6e22e>setWill</span>(<span style=color:#e6db74>&#34;willTopic&#34;</span>,(clientId <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;与服务器断开连接&#34;</span>).<span style=color:#a6e22e>getBytes</span>(),0,<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//重写回调函数内容</span>
</span></span><span style=display:flex><span>        client.<span style=color:#a6e22e>setCallback</span>(<span style=color:#66d9ef>new</span> MqttCallback() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span> <span style=color:#75715e>//重连的处理方法</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>connectionLost</span>(Throwable throwable) {
</span></span><span style=display:flex><span>                System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;MQTT连接断开，发起重连......&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span>(client<span style=color:#f92672>!=</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>client.<span style=color:#a6e22e>isConnected</span>()) {
</span></span><span style=display:flex><span>                        client.<span style=color:#a6e22e>reconnect</span>();
</span></span><span style=display:flex><span>                        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;尝试重新连接&#34;</span>);
</span></span><span style=display:flex><span>                    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                        client.<span style=color:#a6e22e>connect</span>(options);
</span></span><span style=display:flex><span>                        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;尝试建立新连接&#34;</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>                    e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span> <span style=color:#75715e>//消息获取后的处理方法</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>messageArrived</span>(String topic, MqttMessage message) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>                String msg <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String(message.<span style=color:#a6e22e>getPayload</span>());
</span></span><span style=display:flex><span>                ObjectMapper objectMapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectMapper();
</span></span><span style=display:flex><span>                Map<span style=color:#f92672>&lt;</span>String,Object<span style=color:#f92672>&gt;</span> map <span style=color:#f92672>=</span> objectMapper.<span style=color:#a6e22e>readValue</span>(msg, Map.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>                <span style=color:#75715e>//获取消息中的关键信息</span>
</span></span><span style=display:flex><span>                String Timestamp <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>valueOf</span>(map.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;Timestamp&#34;</span>));
</span></span><span style=display:flex><span>                String from <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>valueOf</span>(map.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;ID&#34;</span>));
</span></span><span style=display:flex><span>                String Humidity <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>valueOf</span>(map.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;Humidity&#34;</span>));
</span></span><span style=display:flex><span>                String Temperature <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>valueOf</span>(map.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;Temperature&#34;</span>));
</span></span><span style=display:flex><span>                <span style=color:#75715e>//信息封装</span>
</span></span><span style=display:flex><span>                Record record <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Record();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>record</span><span style=color:#960050;background-color:#1e0010>.</span><span style=color:#a6e22e>setFroms</span>(from);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>record</span><span style=color:#960050;background-color:#1e0010>.</span><span style=color:#a6e22e>setTimestamp</span>(Timestamp);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>record</span><span style=color:#960050;background-color:#1e0010>.</span><span style=color:#a6e22e>setTemperature</span>(Temperature);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>record</span><span style=color:#960050;background-color:#1e0010>.</span><span style=color:#a6e22e>setHumidity</span>(Humidity);
</span></span><span style=display:flex><span>                <span style=color:#75715e>//处理异常数据</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span>(Long.<span style=color:#a6e22e>parseLong</span>(Timestamp)<span style=color:#f92672>&lt;</span>100) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>                <span style=color:#75715e>//调用服务以插入数据</span>
</span></span><span style=display:flex><span>                recordService.<span style=color:#a6e22e>insertRecord</span>(record);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deliveryComplete</span>(IMqttDeliveryToken iMqttDeliveryToken) {}
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#75715e>//设置连接配置，随后发送连接</span>
</span></span><span style=display:flex><span>        client.<span style=color:#a6e22e>connect</span>(options);
</span></span><span style=display:flex><span>        <span style=color:#75715e>//订阅主题</span>
</span></span><span style=display:flex><span>        client.<span style=color:#a6e22e>subscribe</span>(defaultTopic,0);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (MqttException e) {
</span></span><span style=display:flex><span>        e.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>运行springboot程序，同时进入到MQTT服务器的后端（18083端口），可以查看到springboot程序已连接至MQTT服务器，并显示了图4.20中指定的用户名和唯一标识的客户ID，如图4.21所示。至此实现了服务器的连接以及消息主题的订阅。</p><p>【图4.21 springboot连接MQTT】</p><p><img alt=image-23 src=/images/THDS/image-23.png></p><h5 id=444-接口设计>4.4.4 接口设计</h5><p>该部分实现后端对前端提供的各类api接口的代码编写，采用springboot的三层架构，在Controller层提供对外的请求接口。以增添设备操作为例，需要前端发送post请求，后端层面通过@PostMapping注解设置请求路径为&rsquo;/addIot&rsquo;，并在函数参数处通过@RequestBody获取请求数据，即为待插入的IoT信息，随后调用espService中的insertIot服务，将待插入的对象传入，在其中继续调用Mapper层的特定函数，最后在Mapper层使用SQL语句进行数据插入即可。</p><p>需要注意的是，插入操作需要保证完整性依赖，即设备的ID不能重复，否则数据库层面会拒绝插入操作并以Error的形式返回后端，故后端代码需要使用try-catch语句捕获该异常，并向前端返回异常代码，若插入正常则返回成功代码。</p><p>该部分的代码内容如下。以此为例实现了前端所需的所有请求接口，完成了所有的前后端互通操作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/addIot&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>@RequestBody</span> EspIoT iot) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        espService.<span style=color:#a6e22e>insertIot</span>(iot);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(e <span style=color:#66d9ef>instanceof</span> DuplicateKeyException) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Result.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Insert Wrong&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Result.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;System Wrong&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Result.<span style=color:#a6e22e>success</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=5-系统测试>5. 系统测试</h3><h4 id=51-系统部署>5.1 系统部署</h4><p>代码编写时均在本地进行测试运行，完成了系统的开发后，为方便测试系统功能的完整性与可用性，将前后端项目部署到云服务器中，该云服务器即为MySQL数据库和MQTT服务器所在的ECS，更改前端中axios的默认请求IP为127.0.0.1:9090或者具体的ECS公网IP，若使用localhost则无法被解析。打包前端项目生成dist文件，打包后端项目生成jar文件，将其上传至云服务器之中，配置nginx路径于该dist文件中，并通过nohup命令在后台运行该jar文件，即可实现使用公网IP访问系统。</p><p>后续的功能测试均在该部署完成的温湿度监测系统上进行。</p><h4 id=52-功能测试>5.2 功能测试</h4><p>该部分将对各功能模块进行效果呈现。</p><h5 id=521-主页视图>5.2.1 主页视图</h5><p>主页视图如图5.1所示。其中显示了连接设备数目、数据总条目数、平均温度、平均湿度、异常温度条数、异常湿度条数的概览信息，同时也提供了各设备实时温度的数值与简易视图，便于进行一些简单信息的查阅。</p><p>【图5.1 系统主页视图效果展示】</p><p><img alt=image-24 src=/images/THDS/image-24.png></p><h5 id=522-动态视图>5.2.2 动态视图</h5><p>数据分析模块中进行了动态视图的显示，由于环境室温较为稳定，难以看出视图的动态性，因此考虑变化硬件节点的所处环境，可以看到数据发生了明显变化，但略延迟于实际时间点约1s左右，这部分延迟来自于传感节点的信息发布周期以及信息发布、获取所消耗的时间。视图效果如图5.2所示。</p><p>除此之外可以看到视图中展示了阈值范围与平均温度线，便于进行数据的监测与进一步的分析。</p><p>【图5.2 动态视图效果展示】</p><p><img alt=image-25 src=/images/THDS/image-25.png></p><h5 id=523-报表导出>5.2.3 报表导出</h5><p>对于历史数据模块，呈现了所有存储于数据库中的温湿度信息，并记录了其来源设备、具体时间等信息，同时也告知用户总共的数据条数，该数据与系统主页中呈现的一致。点击”导出报表“按钮，系统会自动下载一个Excel文件，其中包含了所有的温湿度信息，如图5.3所示；点击”导出异常数据“按钮，系统会自动下载一个额外的Excel文件，其中内容如图5.4所示，Excel中包含了具体的时间、来源设备、温湿度信息、实际状态与正常的温湿度范围，以供使用者进行异常分析的参考。</p><p>【图5.3 所有数据信息的报表导出】</p><p><img alt=image-26 src=/images/THDS/image-26.png></p><p>【图5.4 异常数据的导出】</p><p><img alt=image-27 src=/images/THDS/image-27.png></p><h5 id=524-设备管理>5.2.4 设备管理</h5><p>设备管理模块中，由用户自行进行设备的添加，同时也可以进行基本的设备信息修改与删除操作，其中设备的修改界面如图5.5所示，其中设备ID、设备型号、设备状态、数据条数等内容不允许进行修改，用户仅能够进行设备描述的内容修改以及温湿度阈值上下限的修改。</p><p>当完成对上下限修改后，该设备所对应的动态报表中的阈值返回以及异常判断标准也会随着发生改变。需注意设备ID会与实际硬件烧录中的ID信息一一对应。</p><p>【图5.5 设备的信息修改】</p><p><img alt=image-28 src=/images/THDS/image-28.png></p><h4 id=53-效果分析>5.3 效果分析</h4><p>通过一系列的功能测试，效果符合需求分析中的各项功能要求，由于MQTT服务器为自我搭建且与后端代码、数据库等部件位于同一台云服务器中，运行效率较高，且硬件通过NB-IoT进行联网，信息传输稳定且受地域干扰较小。本次课程设计的开发在功能实现层面体现了一定的复杂性与较高的可用性，符合预期。</p><h3 id=6-心得与体会>6. 心得与体会</h3><p>在这次的项目设计中，我们团队获得了丰富的物联网开发经验，取得了一系列可喜的成果。首先，通过对ESP8266的编程、ArduinoIDE的灵活运用以及各类传感器模块的巧妙连接，我们深刻理解并掌握了物联网设备的开发技巧。这使得我们能够高效地实现温湿度监测系统的硬件层面，充分发挥了各种传感器的功能，为系统的数据采集提供了可靠的基础。</p><p>无线监测节点的设计为本次课设设计的重点，这一部分工作涉及到ESP8266、SIM7020模块以及DHT22模块的协同工作，为系统的NBIoT联网和MQTT服务器连接提供了可靠的基础。</p><p>首先，通过ESP8266的灵活编程，我们成功实现了监测节点的智能控制和数据处理功能。ESP8266作为微控制器，不仅令我们熟悉了硬件编程的精要，还为监测节点的智能化提供了可靠支持。其次，我们选用SIM7020模块，通过它实现了NBIoT的联网操作。这一步骤是整个监测系统的关键，使得监测节点能够远程连接至云端，实现了数据的远程传输。SIM7020模块的低功耗、高效性能为我们的系统提供了可靠的网络通信能力。同时，我们结合DHT22模块，实现了对环境温湿度信息的高精度采集。DHT22模块通过数字信号输出，为监测系统提供了可靠的环境数据，使得我们的智能监测节点能够更全面地感知环境的变化。最终，通过MQTT服务器的连接，我们成功将监测节点获取的数据整合并发送至云端。这不仅实现了监测功能，也为整个系统提供了远程信息采集的强大功能。通过这一设计，我们深刻体会到了无线监测节点在智能系统中的关键作用，以及其对于物联网应用的不可或缺性。</p><p>在软件方面，我们成功地熟悉和掌握了前后端的开发技巧。通过使用Visual Studio Code和ArduinoIDE，我们能够迅速进行前端代码的编写和硬件代码的烧录，确保系统的复杂功能能够被可靠实现。与此同时，对于后端的开发，我们通过使用IDEA，成功搭建了一个功能强大的系统后台，实现了数据的处理、存储和管理。这为系统的稳健性和可用性提供了有力的支持。</p><p>服务器的搭建是我们团队在这次设计中的一项关键任务。我们成功地配置了云服务器，安装了数据库，并搭建了MQTT服务器进行消息的汇总和传递。这一系列操作不仅加深了我们对服务器架构的理解，也为系统的远程通信提供了坚实的基础。通过这一过程，我们对于云计算和物联网的结合有了更深刻的认识。</p><p>总的来说，这次课程设计不仅让我们掌握了丰富的技术知识，更锻炼了我们解决问题的能力。我们学会了发现并解决各种工程开发中可能遇到的问题，培养了团队协作和沟通的能力。最终，我们能够顺利完成课程设计的要求，这不仅是对我们所学知识的巩固，也是对我们工程开发能力的一次全面提升。这次设计不仅是知识的积累，更是团队协作和实践的宝贵经验。</p><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style></div><div class="row items-start justify-between"><div class="lg:col-5 mb-10 flex items-center lg:mb-0"><h5 class=mr-3>标签 :</h5><ul><li class=inline-block><a class="bg-theme-light hover:bg-primary dark:bg-darkmode-theme-light dark:hover:bg-darkmode-primary dark:hover:text-dark m-1 block rounded px-3 py-1 hover:text-white" href=/en/tags/%e7%b3%bb%e7%bb%9f%e5%bc%80%e5%8f%91/>系统开发</a></li><li class=inline-block><a class="bg-theme-light hover:bg-primary dark:bg-darkmode-theme-light dark:hover:bg-darkmode-primary dark:hover:text-dark m-1 block rounded px-3 py-1 hover:text-white" href=/en/tags/%e7%89%a9%e8%81%94%e7%bd%91/>物联网</a></li></ul></div></div></article></div></div></section></main><footer class="bg-theme-light dark:bg-darkmode-theme-light"><div class=container><div class="row items-center py-10"><div class="lg:col-3 mb-8 text-center lg:mb-0 lg:text-left"><a class="navbar-brand inline-block" href=/en/><img fetchpriority=high decoding=async class="img logo-light" width=160 height=32 src=/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_lanczos_3.png"'>
<img fetchpriority=high decoding=async class="img logo-dark" width=160 height=32 src=/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_lanczos_3.png"'></a></div><div class="lg:col-6 mb-8 text-center lg:mb-0"><ul><li class="m-3 inline-block"><a href=/en/about/>个人信息</a></li><li class="m-3 inline-block"><a href=/en/blog/>学习笔记</a></li><li class="m-3 inline-block"><a href=/en/privacy-policy/>相关说明</a></li></ul></div><div class="lg:col-3 mb-8 text-center lg:mb-0 lg:mt-0 lg:text-right"><ul class=social-icons><li><a target=_blank aria-label=github rel="nofollow noopener" href=https://www.github.com/COOOIKX><i class="fab fa-github"></i></a></li><li><a target=_blank aria-label=csdn rel="nofollow noopener" href="https://blog.csdn.net/m0_59701064?spm=1000.2115.3001.5343"><i class="fas fa-home-lg"></i></a></li></ul></div></div></div><div class="border-border dark:border-darkmode-border border-t py-7"><div class="text-light dark:text-darkmode-light container text-center"><p>Designed by Zeon Studio and Developed by LHF</p></div></div></footer><script crossorigin=anonymous integrity="sha256-YQerunHGeT7hXzxweSqFUXgOHHxFceSjmMy/kmnAHWU=" src=/js/script.min.6107abba71c6793ee15f3c70792a8551780e1c7c4571e4a398ccbf9269c01d65.js></script><script defer async crossorigin=anonymous integrity="sha256-w+aS42D2+B+Jix+joZ7pAua1vbu/pRK/IhoP55b8n3w=" src=/js/script-lazy.min.c3e692e360f6f81f898b1fa3a19ee902e6b5bdbbbfa512bf221a0fe796fc9f7c.js></script><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js")</script></body></html>