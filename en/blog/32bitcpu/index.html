<!doctype html><html itemscope lang=en-us itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=theme-name content="hugoplate"><link rel="shortcut icon" href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_96x0_resize_lanczos_3.png type=image/x-icon><link rel=icon href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_96x0_resize_lanczos_3.png type=image/x-icon><link rel=icon type=image/png sizes=48x48 href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_48x0_resize_lanczos_3.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_96x0_resize_lanczos_3.png><link rel=apple-touch-icon sizes=144x144 href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_144x0_resize_lanczos_3.png><link rel=manifest href=/manifest.webmanifest><meta name=msapplication-TileColor content="#ddd"><meta name=theme-color content="#ffffff"><base href=https://lhfgghc.github.io/en/blog/32bitcpu/><title>【项目笔记】基于Quartus与FGPA的32位单周期硬布线CPU设计</title>
<meta name=keywords content="Boilerplate,Hugo"><meta name=description content="this is meta description"><meta name=author content="zeon.studio"><meta property="og:image" content="https://lhfgghc.github.io/images/og-image.png"><meta name=twitter:image content="https://lhfgghc.github.io/images/og-image.png"><meta name=twitter:card content="summary_large_image"><meta property="og:image:width" content="900"><meta property="og:image:height" content="600"><meta property="og:image:type" content="image/
        .png
      "><meta property="og:title" content="【项目笔记】基于Quartus与FGPA的32位单周期硬布线CPU设计"><meta property="og:description" content="this is meta description"><meta property="og:type" content="website"><meta property="og:url" content="https://lhfgghc.github.io/en/blog/32bitcpu/"><meta name=twitter:title content="【项目笔记】基于Quartus与FGPA的32位单周期硬布线CPU设计"><meta name=twitter:description content="this is meta description"><script>let indexURL="https://lhfgghc.github.io/en/searchindex.json",includeSectionsInSearch=["blog"],search_no_results="未找到结果",search_initial_message="输入内容以搜索"</script><meta http-equiv=x-dns-prefetch-control content="on"><link rel=preconnect href=https://use.fontawesome.com crossorigin><link rel=preconnect href=//cdnjs.cloudflare.com><link rel=preconnect href=//www.googletagmanager.com><link rel=preconnect href=//www.google-analytics.com><link rel=dns-prefetch href=https://use.fontawesome.com><link rel=dns-prefetch href=//ajax.googleapis.com><link rel=dns-prefetch href=//cdnjs.cloudflare.com><link rel=dns-prefetch href=//www.googletagmanager.com><link rel=dns-prefetch href=//www.google-analytics.com><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//connect.facebook.net><link rel=dns-prefetch href=//platform.linkedin.com><link rel=dns-prefetch href=//platform.twitter.com><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600&family=Signika:wght@500;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><link href="/css/style.min.4c1d4c3120637c4b33d33d38988a2525a8e15057b5ab0cfa95ce5147d4c95adc.css" integrity="sha256-TB1MMSBjfEsz0z04mIolJajhUFe1qwz6lc5RR9TJWtw=" rel=stylesheet><link defer async rel=stylesheet href="/css/style-lazy.min.ec14d2549e8e0fbaf9af20dcc88fad37fb352e5bd5978a801dc1c3f5a5922174.css" integrity="sha256-7BTSVJ6OD7r5ryDcyI+tN/s1LlvVl4qAHcHD9aWSIXQ=" media=print onload='this.media="all",this.onload=null'></head><body><header class="header sticky top-0 z-30"><nav class="navbar container"><div class=order-0><a class="navbar-brand block" href=/en/><img fetchpriority=high decoding=async class="img logo-light" width=160 height=32 src=/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_lanczos_3.png"'>
<img fetchpriority=high decoding=async class="img logo-dark" width=160 height=32 src=/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_lanczos_3.png"'></a></div><input id=nav-toggle type=checkbox class=hidden>
<label for=nav-toggle class="order-3 cursor-pointer flex items-center lg:hidden text-dark dark:text-white lg:order-1"><svg id="show-button" class="h-6 fill-current block" viewBox="0 0 20 20"><title>Menu Open</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0V0z"/></svg><svg id="hide-button" class="h-6 fill-current hidden" viewBox="0 0 20 20"><title>Menu Close</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></label><ul id=nav-menu class="navbar-nav order-3 hidden lg:flex w-full pb-6 lg:order-1 lg:w-auto lg:space-x-2 lg:pb-0 xl:space-x-8"><li class=nav-item><a class=nav-link href=/en/>主页</a></li><li class=nav-item><a class=nav-link href=/en/blog/>学习笔记</a></li><li class=nav-item><a class=nav-link href=/en/about/>个人信息</a></li><li class="nav-item nav-dropdown group relative"><span class="nav-link
inline-flex items-center">其它<svg class="h-4 w-4 fill-current" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg></span><ul class="nav-dropdown-list lg:group-hover:visible lg:group-hover:opacity-100"><li class=nav-dropdown-item><a class=nav-dropdown-link href=/en/elements/>样式Draft</a></li><li class=nav-dropdown-item><a class=nav-dropdown-link href=/en/privacy-policy/>相关说明</a></li><li class=nav-dropdown-item><a class=nav-dropdown-link href=/en/categories/>笔记分类</a></li></ul></li></ul><div class="order-1 ml-auto flex items-center md:order-2 lg:ml-0"><button aria-label=search class="border-border text-dark hover:text-primary dark:border-darkmode-border mr-5 inline-block border-r pr-5 text-xl dark:text-white dark:hover:text-darkmode-primary" data-target=search-modal>
<i class="fa-solid fa-search"></i></button><div class="theme-switcher mr-5"><input id=theme-switcher data-theme-switcher type=checkbox>
<label for=theme-switcher><span class=sr-only>theme switcher</span>
<span><svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 opacity-100 dark:opacity-0" viewBox="0 0 56 56" fill="#fff" height="16" width="16"><path d="M30 4.6c0-1-.9-2-2-2a2 2 0 00-2 2v5c0 1 .9 2 2 2s2-1 2-2zm9.6 9a2 2 0 000 2.8c.8.8 2 .8 2.9.0L46 13a2 2 0 000-2.9 2 2 0 00-3 0zm-26 2.8c.7.8 2 .8 2.8.0.8-.7.8-2 0-2.9L13 10c-.7-.7-2-.8-2.9.0-.7.8-.7 2.1.0 3zM28 16A12 12 0 0016 28a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0028 16zm23.3 14c1.1.0 2-.9 2-2s-.9-2-2-2h-4.9a2 2 0 00-2 2c0 1.1 1 2 2 2zM4.7 26a2 2 0 00-2 2c0 1.1.9 2 2 2h4.9c1 0 2-.9 2-2s-1-2-2-2zm37.8 13.6a2 2 0 00-3 0 2 2 0 000 2.9l3.6 3.5a2 2 0 002.9.0c.8-.8.8-2.1.0-3zM10 43.1a2 2 0 000 2.9c.8.7 2.1.8 3 0l3.4-3.5c.8-.8.8-2.1.0-2.9s-2-.8-2.9.0zm20 3.4c0-1.1-.9-2-2-2a2 2 0 00-2 2v4.9c0 1 .9 2 2 2s2-1 2-2z"/></svg><svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 opacity-0 dark:opacity-100" viewBox="0 0 24 24" fill="none" height="16" width="16"><path fill="#000" fill-rule="evenodd" clip-rule="evenodd" d="M8.2 2.2c1-.4 2 .6 1.6 1.5-1 3-.4 6.4 1.8 8.7a8.4 8.4.0 008.7 1.8c1-.3 2 .5 1.5 1.5v.1A10.3 10.3.0 0112.4 22 10.3 10.3.0 013.2 6.7c1-2 2.9-3.5 4.9-4.4z"/></svg></span></label></div><script>var darkMode=!1,themeSwitch;window.matchMedia("(prefers-color-scheme: dark)").matches&&(darkMode=!0),localStorage.getItem("theme")==="dark"?darkMode=!0:localStorage.getItem("theme")==="light"&&(darkMode=!1),darkMode&&document.documentElement.classList.toggle("dark"),themeSwitch=document.querySelectorAll("[data-theme-switcher]"),document.addEventListener("DOMContentLoaded",()=>{[].forEach.call(themeSwitch,function(e){e.checked=!!darkMode,e.addEventListener("click",()=>{document.documentElement.classList.toggle("dark"),localStorage.setItem("theme",document.documentElement.classList.contains("dark")?"dark":"light")})})})</script></div></nav></header><div class=search-modal aria-hidden=true style=--color-primary:#121212><div data-target=close-search-modal class=search-modal-overlay></div><div class=search-wrapper data-image=true data-description=true data-tags=true data-categories=true><div class=search-wrapper-header><label for=search-modal-input style=margin-top:-1px><span class=sr-only>search icon</span>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="18" width="18" class="search-icon" data-type="search"><path fill="currentcolor" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8.0 45.3s-32.8 12.5-45.3.0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9.0 208S93.1.0 208 0 416 93.1 416 208zM208 352a144 144 0 100-288 144 144 0 100 288z"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="18" width="18" class="search-reset" data-type="reset"><path fill="currentcolor" d="M256 512A256 256 0 10256 0a256 256 0 100 512zM175 175c9.4-9.4 24.6-9.4 33.9.0l47 47 47-47c9.4-9.4 24.6-9.4 33.9.0s9.4 24.6.0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6.0 33.9s-24.6 9.4-33.9.0l-47-47-47 47c-9.4 9.4-24.6 9.4-33.9.0s-9.4-24.6.0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6.0-33.9z"/></svg>
</label><input id=search-modal-input type=text data-search-input autocomplete=off aria-label=Search placeholder=搜索></div><div class=search-wrapper-body><div class=search-result data-search-result></div><span class=search-result-empty>输入内容以搜索</span></div><div class=search-wrapper-footer><span><kbd><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentcolor" viewBox="0 0 16 16"><path d="M3.204 11h9.592L8 5.519 3.204 11zm-.753-.659 4.796-5.48a1 1 0 011.506.0l4.796 5.48c.566.647.106 1.659-.753 1.659H3.204a1 1 0 01-.753-1.659z"/></svg>
</kbd><kbd><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentcolor" style="margin-top:1px" viewBox="0 0 16 16"><path d="M3.204 5h9.592L8 10.481 3.204 5zm-.753.659 4.796 5.48a1 1 0 001.506.0l4.796-5.48c.566-.647.106-1.659-.753-1.659H3.204a1 1 0 00-.753 1.659z"/></svg>
</kbd>导航
</span><span><kbd><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentcolor" style="display:inline-block" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M14.5 1.5a.5.5.0 01.5.5v4.8a2.5 2.5.0 01-2.5 2.5H2.707l3.347 3.346a.5.5.0 01-.708.708l-4.2-4.2a.5.5.0 010-.708l4-4a.5.5.0 11.708.708L2.707 8.3H12.5A1.5 1.5.0 0014 6.8V2a.5.5.0 01.5-.5z"/></svg>
</kbd>选择
</span><span class=search-result-info></span>
<span data-target=close-search-modal><kbd>ESC</kbd> 关闭</span></div></div></div><main><section class="section pt-7"><div class=container><div class="row justify-center"><article class=lg:col-10><h1 class="h2 mb-4">【项目笔记】基于Quartus与FGPA的32位单周期硬布线CPU设计</h1><ul class=mb-4><li class="mr-4 inline-block"><a href=/en/authors/liang-hangfeng/><i class="fa-regular fa-circle-user mr-2"></i>Liang Hangfeng</a></li><li class="mr-4 inline-block"><i class="fa-regular fa-folder mr-2"></i>
<a href=/en/categories/%e9%a1%b9%e7%9b%ae%e7%ac%94%e8%ae%b0/>项目笔记</a></li><li class="mr-4 inline-block"><i class="fa-regular fa-clock mr-2"></i>
November 5, 2023</li></ul><div class="content mb-10"><p>本次课程设计要求使用硬布线的方法设计并实现一个32位的单周期CPU，并设计一系列机器指令，从而实现CPU的基本运算处理能力。以此掌握CPU的工作原理、各组成部件的设计方法、数据通路的设计、指令集的设计、基于硬布线的控制信号生成方法等内容。</p><p>整个课程设计大致分为软件仿真与硬件运行两部分。软件仿真方面，本文采用Quartus II设计+ModelSim波形仿真的方法，使用基于原理图的方式进行CPU部件的设计，并通过波形图进行仿真运行与部件功能的检验；硬件运行方面，本文选用FPGA DE0开发板，在完成软件编写后将工程烧录至开发板中运行，以显式地检验CPU与指令设计的正确性。</p><p>具体地，本次课设完成了寄存器堆、存储器、程序计数器、算术逻辑单元、数据选择器、位拓展单元、控制单元、LED显示单元等模块的设计，并在此基础上进行了数据通路的设计，并设计了一系列控制信号，用于协调各模块之间的协作，控制信号由控制单元接收指令生成，采用硬布线的方法实现；指令层面，共设计了Clear、Set、ADD、SUB、JMP、LW、SW、BEQ、Mov等九条基本功能指令，以实现常见的数据输入、运算、转移、循环等功能。</p><p>完成基本的设计后，本文还基于设计的九条功能指令进行了测试程序的编写，以验证CPU功能与指令功能的正确性，包括加减法测试、数据转移测试、条件循环测试等，最终以波形图与开发板LED显示的方式进行正确性检验，结果均符合预期。</p><p>通过本次课程设计，对于计算机组成原理有了进一步的理解，尤其是CPU的内部构造与工作模式，并锻炼了问题分析与硬件设计的能力，对后续课程有较大的帮助。</p><p>This course design requires the use of a hardwired method to design and implement a 32-bit single-cycle CPU, and design a series of machine instructions, to achieve the basic computing processing capacity of the CPU. In this way, we can master the working principle of the CPU, the design method of each component, the design of the data path, the design of the instruction set, and the generation method of the control signal based on hard wiring.
The whole course design is roughly divided into software simulation and hardware operation two parts. In terms of software simulation, this paper adopts the Quartus II design +ModelSim waveform simulation method to design CPU components based on a schematic diagram and conducts simulation operation and component function inspection through a waveform diagram. In terms of hardware operation, this paper selects the FPGA DE0 development board and burns the project to the development board to run after software writing, to explicitly check the correctness of CPU and instruction design.
Specifically, this course has completed the design of the register pile, memory, program counter, arithmetic logic unit, data selector, bit expansion unit, control unit, LED display unit, and other modules. On this basis, the data path is designed, and a series of control signals are designed to coordinate the cooperation between the modules. The control signal is generated by the command received by the control unit, which is realized by hard wiring. At the instruction level, a total of nine basic function instructions such as Clear, Set, ADD, SUB, JMP, LW, SW, BEQ, and Mov are designed to achieve common data input, operation, transfer, circulation, and other functions.
After the completion of the basic design, this paper is also based on the design of nine functional instructions for the test program, to verify the correctness of CPU functions and instruction functions, including addition and subtraction test, data transfer test, conditional loop test, etc., the final waveform diagram and the development board LED display way for correctness test, the results are in line with expectations.
Through this course design, I have a further understanding of the principle of computer composition, especially the internal structure and working mode of CPU, and exercised the ability of problem analysis and hardware design, which will be of great help to the subsequent courses.</p><h3 id=一设计目的与目标>一、设计目的与目标</h3><h4 id=11-设计目的>1.1 设计目的</h4><ol><li>通过设计一个简易的32位单周期CPU，加深对计算机体系结构的理解，理解并掌握基本的数据通路设计、指令集设计以及硬布线控制器设计方法。</li><li>学习使用Quartus II软件进行硬件的描述与波形仿真，并基于FPGA开发板进行测试，验证CPU设计实现的功能与性能。</li><li>设计并实现简易的指令集，熟悉指令格式、流程控制、寻址与跳转、数据流向等基本概念。</li><li>培养在实践中发现问题与解决问题的能力。</li></ol><h4 id=12-设计目标>1.2 设计目标</h4><ol><li>设计一个简易的32位单周期的CPU架构，包括寄存器堆、算数逻辑单元、数据单元、硬布线控制器、存储器、数据拓展单元、程序计数单元。</li><li>自行设计几条简易的指令，组成最基本的指令集，包括加减法指令、存取数指令、程序跳转指令、条件判断指令、数据转移指令等。</li><li>基于自己已设计的指令，使用硬布线设计方法，进行程序控制信号、控制器的设计。</li><li>使用Quartus II+FPGA的方法，分别从软件和硬件层面进行CPU的基本设计与功能验证。</li></ol><h3 id=二课程设计器材>二、课程设计器材</h3><p>硬件平台和软件平台的选择能够为本实验提供丰富而强大的资源和工具支持，有利于进行单周期32位CPU的设计、实现和测试。</p><h4 id=21-硬件平台>2.1 硬件平台</h4><p>本实验使用的FPGA开发板是Cyclone III 系列的DE0 FPGA开发板。该开发板具有丰富的硬件资源，适合进行基于FPGA的数字电路设计和计算机组成原理实验。</p><p>硬件平台的主要特性如下：</p><ul><li>FPGA芯片：该开发板搭载了一颗Cyclone III 系列的FPGA芯片，该芯片提供了大量可编程逻辑单元（LEs）和内存单元（M9K），能够满足CPU设计的资源需求。</li><li>外设接口：DE0 FPGA开发板提供了多个外设接口，包括扩展插槽、GPIO口、七段数码管、开关和按键等，可以方便地进行与外部设备的交互，并进行输入输出的测试和验证。</li><li>连接接口：该开发板还提供了多种连接接口，如USB接口、VGA接口、音频接口、以太网接口等，可以适应不同的外部设备和通信需求。</li></ul><h4 id=22-软件平台>2.2 软件平台</h4><p>本实验使用的软件平台是Quartus II 13.1。Quartus II 是一款由Intel (Altera) 公司开发的集成电路设计软件，支持硬件描述语言（HDL）的编写、逻辑仿真、综合、布局和布线等功能。</p><p>软件平台的主要特性如下：</p><ul><li>集成开发环境：Quartus II 提供了完整的集成开发环境，包括工程管理、代码编辑、设计模拟、逻辑综合和布局布线等功能模块。用户可以在同一个软件平台中完成整个设计流程，方便快捷。</li><li>硬件描述语言支持：Quartus II 可以支持多种硬件描述语言，如VHDL和Verilog，用户可以根据自己的偏好选择合适的语言进行设计。</li><li>仿真功能：Quartus II 内置了仿真工具，可以对设计的硬件描述文件进行功能仿真和时序仿真，在仿真环境中测试和验证设计的正确性。</li><li>综合和布局布线工具：Quartus II 提供了综合工具，可以将设计的硬件描述文件综合成目标设备的门级网表，然后通过布局布线工具将逻辑网表映射到实际的硬件资源上，生成可下载到FPGA开发板的配置文件。</li></ul><h3 id=三cpu逻辑设计总体方案>三、CPU逻辑设计总体方案</h3><p>CPU由多个模块构成并相互协作，通过程序控制器读取指令并发出不同的控制信号，从而控制不同的模块进行数据的传输、存储、处理。</p><p>因此本次实验对于CPU的设计思路大致为：先进行大致的CPU架构梳理，对CPU的模块结构进行分析；进行指令集的设计，规划各指令的功能；进行数据通路的设计，从指令入手，规划需要进行操作的模块，并进行控制信号的设计；最后设计程序控制器，进行指令的解析与控制信号的产生。</p><p>完成以上部分的设计后，并将各模块之间进行通路连接，理论上即可完成CPU的基本功能实现。</p><h4 id=31-cpu组成模块>3.1 CPU组成模块</h4><p>本次课程设计计划实现的CPU包含控制单元、算术逻辑单元、寄存器堆、存储器、数位拓展单元、数据通路等基本模块，除此之外也包含如LED显示单元、数据选择器等功能部件。</p><h5 id=311-控制单元>3.1.1 控制单元</h5><p>控制单元（Control Unit）负责<strong>解释和执行指令</strong>，并协调其他模块的操作。它包含指令寄存器（用于存储当前执行的指令）、指令解码器（将指令转化为控制信号）和时钟（用于同步指令执行）等。控制单元基于指令解码器中的控制信号，控制其他模块的工作。</p><h5 id=312-算术逻辑单元>3.1.2 算术逻辑单元</h5><p>算术逻辑单元是执行计算机<strong>算术和逻辑运算</strong>的核心。它包括多个电子电路和逻辑门，可用于执行加法、减法、乘法和逻辑操作（如与、或、非、异或）。ALU接收来自寄存器的操作数，并根据控制信号执行相应的运算。本次实验中只考虑设计简单的加法器，作为ALU。</p><h5 id=313-寄存器堆>3.1.3 寄存器堆</h5><p>寄存器堆是一组用于<strong>存储临时数据</strong>的寄存器。这些寄存器用于存储ALU操作数、中间结果和其他重要数据。寄存器堆通常包含通用寄存器，可以存储多个位的数据，并允许对数据进行读写操作。</p><h5 id=314-存储器>3.1.4 存储器</h5><p>存储器是用于<strong>存储程序和数据</strong>的部件。计算机系统通常包括主存储器（如RAM）和辅助存储器（如硬盘或固态硬盘）。CPU与存储器之间通过地址总线和数据总线进行通信，以传输指令和数据。本次实验中将存储器划分为存储指令的ROM，其中计划存放设计好的指令程序，以及RAM，用于存放计算数据。</p><h5 id=315-数位拓展单元>3.1.5 数位拓展单元</h5><p>数位拓展单元用于<strong>扩展数据的位数</strong>，以满足指令要求。它接收来自指令以及寄存器的数据，并执行扩展操作，将数据从较小的位宽转化为较大的位宽，以便进行算术和逻辑运算。</p><h5 id=316-数据通路>3.1.6 数据通路</h5><p>数据通路是负责在CPU内部<strong>传输数据</strong>的路径。它由数据总线和控制总线组成，用于连接寄存器、ALU、存储器和其他组件。数据通路承载着数据的传输和操作，确保各个组件之间的连接和协调。</p><h4 id=32-指令集设计>3.2 指令集设计</h4><h5 id=321-指令执行流程>3.2.1 指令执行流程</h5><p>一般来说，一个CPU在处理指令时需要经过以下几个步骤：</p><p>（1）取指令（IF）：根据程序计数器 PC 中的指令地址，从存储器中取出一条指令，然后转到译码状态。同时，在 PC 中产生取下一条指令需要的指令地址。</p><p>（2）指令译码（ID）：对取指令操作中得到的指令进行译码，确定这条指令需要完成的操作，从而产生相应的控制信号，驱动执行状态中的各种动作。</p><p>（3）指令执行（EXE）：根据指令译码得到的控制信号，具体地执行指令动作，然后，转移到结果写回状态。</p><p>（4）存储器访问（MEM）：所有需要访问存储器的操作都将在这个步骤中执行，该步骤给出访问存储器的数据地址，把数据写入到存储器中数据地址所指示的位置或者从存储器中的得到数据地址所指示的数据。</p><p>（5）结果写回（WB）：该步骤负责把指令执行的结果或者访问存储器中得到的数据写回到相应的目的寄存器中。</p><h5 id=322-指令划分>3.2.2 指令划分</h5><p>对于32位指令，需要合理对其各位的含义进行分配，以实现对应的功能，例如其中最高六位将用作指令码，将被送往控制单元进行指令的译码，从而产生相应的控制信号。</p><p>本次课程设计中对于指令的划分方案如下图所示。</p><p><img alt=image-1 src=/images/32bitCPU/image-1.png></p><p>除指令码之外，指令的各部分被分别用作寄存器地址、运算立即数、PC值等，具体的功能将通过指令码译码产生的控制信号进行合理的控制与选择。</p><h5 id=323-指令格式及功能>3.2.3 指令格式及功能</h5><p>完成指令的格式划分后，将进行指令的具体格式定义与功能设计，本次实验共设计了9条指令，分别为：Clear、Mov、Set、ADD、SUB、JMP、LW、SW、BEQ。</p><p>其具体的格式与功能如下：</p><ol><li>Clear cd</li></ol><p><img alt=image-clear src=/images/32bitCPU/Design/Clear.png></p><p>功能：清空目标寄存器cd。</p><ol start=2><li>Mov rt rd</li></ol><p><img alt=image-mov src=/images/32bitCPU/Design/Mov.png></p><p>功能：将寄存器rt中的数据转移到寄存器rd。</p><ol start=3><li>Set rt</li></ol><p><img alt=image-set src=/images/32bitCPU/Design/Set.png></p><p>功能：将目标立即数data置入寄存器rt。</p><ol start=4><li>ADD rs rt rd</li></ol><p><img alt=image-add src=/images/32bitCPU/Design/Add.png></p><p>功能：将寄存器rs、rt中的内容取出相加，存储到rd寄存器之中。</p><ol start=5><li>SUB rs rt rd</li></ol><p><img alt=image-sub src=/images/32bitCPU/Design/Sub.png></p><p>功能：将寄存器rs、rt中的内容取出相减，存储到rd寄存器之中。</p><ol start=6><li>JMP target</li></ol><p><img alt=image-jmp src=/images/32bitCPU/Design/Jmp.png></p><p>功能：跳转到PC值为target的指令处。</p><ol start=7><li>LW base rt offset</li></ol><p><img alt=image-lw src=/images/32bitCPU/Design/LW.png></p><p>功能：取base值与offset相加，作为地址取数据并将其保存到rt寄存器之中。</p><ol start=8><li>SW base rt offset</li></ol><p><img alt=image-sw src=/images/32bitCPU/Design/SW.png></p><p>功能：取base值与offset相加，作为地址，并将rt寄存器的数据存入该地址所对应的内存空间中。</p><ol start=9><li>BEQ rs rt target</li></ol><p><img alt=image-beq src=/images/32bitCPU/Design/Beq.png></p><p>功能：条件判断，如果rs和rt寄存器中的值相同，则PC转移到target处，否则PC=PC+1。</p><h4 id=33-控制信号设计>3.3 控制信号设计</h4><h5 id=331-控制信号概述>3.3.1 控制信号概述</h5><p>控制单元对指令操作码进行译码，并发送各控制信号，从而控制各部件的工作状态，实现指定的要求。本次课程设计设计了9个控制信号，分别为PCSource、RegDst、ALUSrcB、ALUOp、Clear、MemToReg、RegWrite、MemWrite、Branch。</p><h5 id=332-控制信号功能>3.3.2 控制信号功能</h5><p>对于上述的各个控制信号，其具体功能如下表所示。</p><table><thead><tr><th style=text-align:center>信号名</th><th style=text-align:center>无效时作用0</th><th style=text-align:center>有效时作用1</th></tr></thead><tbody><tr><td style=text-align:center>PCSource</td><td style=text-align:center>PC=PC+1</td><td style=text-align:center>PC=立即数</td></tr><tr><td style=text-align:center>RegDst</td><td style=text-align:center>写Reg地址来自rt字段</td><td style=text-align:center>写Reg地址来自rd字段</td></tr><tr><td style=text-align:center>ALUSrcB</td><td style=text-align:center>ALUB来自寄存器堆D2</td><td style=text-align:center>符号拓展后的立即数</td></tr><tr><td style=text-align:center>ALUOp</td><td style=text-align:center>ALU减法操作</td><td style=text-align:center>ALU加法操作</td></tr><tr><td style=text-align:center>Clear</td><td style=text-align:center>正常读写</td><td style=text-align:center>寄存器堆WriteData为0</td></tr><tr><td style=text-align:center>MemToReg</td><td style=text-align:center>正常读写</td><td style=text-align:center>内存读写</td></tr><tr><td style=text-align:center>RegWrite</td><td style=text-align:center>无</td><td style=text-align:center>上升沿到来时进行写寄存器</td></tr><tr><td style=text-align:center>MemWrite</td><td style=text-align:center>无</td><td style=text-align:center>上升沿到来时进行写存储器</td></tr><tr><td style=text-align:center>Branch</td><td style=text-align:center>PC=PC+1</td><td style=text-align:center>PC=PC+offset</td></tr></tbody></table><h4 id=34-数据通路与控制线路>3.4 数据通路与控制线路</h4><p>控制信号最后通过控制线路影响到各个部件的工作状态，且数据也会随着控制信号的改变产生不同的转移方向。</p><p><img alt=image-data src=/images/32bitCPU/RD.png></p><h3 id=四模块详细设计>四、模块详细设计</h3><p>对于各模块的详细设计过程，大致可以分为主要硬件实现与控制单元的设计实现。完成各主要硬件模块的实现后，通过控制单元的控制信号对其进行统一控制。</p><p>设计主要由Quartus II软件进行，为简化设计过程并明细设计流程，采用原理图的形式进行设计，必要时采用Verilog HDL语言进行补充设计，特别注意的是，在原理图的设计过程中，可以通过对引脚进行命名同步的操作以替代直接连线，简化了文件的复杂度。</p><h4 id=41-主要硬件实现>4.1 主要硬件实现</h4><p>主要包含寄存器堆、存储器、数位拓展单元、程序计数单元、LED显示单元，其中LED显示单元是为了将二进制数据显示到数显板上而设计的。</p><h5 id=411-寄存器堆>4.1.1 寄存器堆</h5><p>寄存器堆用于数据的临时存储，采用D触发器实现。由于本次课程设计均为32位，故每一个存储单元需要由32个D触发器组成，考虑到设计的复杂性，本次设计过程中先实现了8位寄存器，再由4个8位寄存器级联组成32位计算器。如下图所示。</p><p><img alt=image-reg1 src=/images/32bitCPU/Reg1.png></p><p>完成32位寄存器的实现后，考虑到寄存器的寻址地址为5位，因此将32个32位寄存器进行组合，通过数据选择器控制指定的寄存器的写使能端，以实现数据的读写功能。数据的读操作也可以通过数据选择器实现，通过对给定的地址的译码操作，选中特定的寄存器输出信号作为整个寄存器堆的输出，这里可以设计成双端口读取。</p><p><img alt=image-reg2 src=/images/32bitCPU/Reg2.png></p><p>至此完成了对于寄存器堆的软件仿真实现，通过ModelSIM进行波形图仿真模拟，检测其功能的正确性。为简化设计过程，并体现模块化的设计理念，将以上整个寄存器堆导出为一个模块，便于后续的使用，如下图所示。</p><p><img alt=image-reg3 src=/images/32bitCPU/Reg3.png></p><h5 id=412-存储器单元>4.1.2 存储器单元</h5><p>本次课程设计采用将数据与指令分离的方法，将指令专门置于只读存储器ROM中，后续通过内存初始化文件MIF对其进行指令的写入，并将数据专门置于随机存储器RAM中，可在程序的任意时刻对其中的内存单元进行数据的读写操作。</p><p>其中存放指令的ROM仅包含时钟信号输入端，地址输入端，指令输出端；存放数据的RAM包含时钟信号的同时，也包含了寻址地址端（共8位，寻址256个内存单元），写数据端，读数据端，读写控制信号。</p><p>最终的存储器集成模块如下图所示。</p><p><img alt=image-ram1 src=/images/32bitCPU/Ram1.png></p><h5 id=413-数位拓展单元>4.1.3 数位拓展单元</h5><p>由于其余模块的操作数、指令均为32位，对于指令中的立即数，需要进行符号拓展操作，本次设计中涉及到26位至32位以及16位至32位的拓展，采用带符号的拓展方式，将最高位向高位方向进行同步拓展，最终达到拓展需求，该部分可以使用多个与门实现。</p><p>以16位至32位的拓展为例，对于低15位采用直接输出的方法，最高位通过与门依次拓展补充，如下图所示。</p><p><img alt=image-exd1 src=/images/32bitCPU/exd1.png></p><p>同理可以完成26位至32位的符号拓展单元，整体模块如下图所示。</p><p><img alt=image-exd2 src=/images/32bitCPU/exd2.png></p><h5 id=414-程序计数器>4.1.4 程序计数器</h5><p>指令的执行需要程序计数器PC进行控制，正常的情况下PC自增，则按照顺序从指令存储器中进行指令的读取和执行，因此程序计数模块需要一个32位寄存器进行临时的指令存储，其中存储PC值，并连接一个加法器，在每次时钟上升沿时进行自增加一操作。</p><p>除此之外，PC值也受一些控制信号的影响，例如JMP指令给出的PCSource信号和Beq指令给出的Branch信号，进行PC值的跳转，故该模块也要添加一些数据选择器，配合数位拓展单元对PC值进行更改。具体实现如下图所示。</p><p><img alt=image-PC1 src=/images/32bitCPU/PC1.png></p><p>整体模块如下图x所示。</p><p><img alt=image-PC2 src=/images/32bitCPU/PC2.png></p><h5 id=415-led显示单元>4.1.5 LED显示单元</h5><p>本次设计使用的开发板上有4位7段数显管，考虑将四位二进制通过一位数显管进行十六进制显示，因此只需要通过一些组合逻辑电路将输入的四位二进制转化为指定的数显管7位信号即可。另外，本次设计中仅考虑整数的相关运算，故无视数显管的小数点信号。</p><p>通过查阅FPGA DE0开发板的用户手册可知，数显管的输入信号为低电平有效，该部分无明显的电路结构，仅在于逻辑转换，因此使用Verilog HDL代码实现。代码内容如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-v data-lang=v><span style=display:flex><span><span style=color:#f92672>module</span> <span style=color:#a6e22e>LEDHex</span>(<span style=color:#66d9ef>in</span>, <span style=color:#a6e22e>LED7S</span>) ;
</span></span><span style=display:flex><span>		 input [<span style=color:#a6e22e>3</span>:<span style=color:#e6db74>0</span>] <span style=color:#66d9ef>in</span> ;
</span></span><span style=display:flex><span>		 output reg [<span style=color:#a6e22e>6</span>:<span style=color:#e6db74>0</span>] <span style=color:#a6e22e>LED7S</span> ;
</span></span><span style=display:flex><span>		 always<span style=color:#f92672>@</span>(<span style=color:#66d9ef>in</span>)
</span></span><span style=display:flex><span>		 begin
</span></span><span style=display:flex><span>		      <span style=color:#a6e22e>case</span>(<span style=color:#66d9ef>in</span>)
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b0000:LED7S &lt;= 7&#39;</span>b1000000;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b0001:LED7S &lt;= 7&#39;</span>b1111001;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b0010:LED7S &lt;= 7&#39;</span>b0100100;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b0011:LED7S &lt;= 7&#39;</span>b0110000;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b0100:LED7S &lt;= 7&#39;</span>b0011001;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b0101:LED7S &lt;= 7&#39;</span>b0010010;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b0110:LED7S &lt;= 7&#39;</span>b0000010;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b0111:LED7S &lt;= 7&#39;</span>b1111000;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b1000:LED7S &lt;= 7&#39;</span>b0000000;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b1001:LED7S &lt;= 7&#39;</span>b0010000;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b1010:LED7S &lt;= 7&#39;</span>b0001000;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b1011:LED7S &lt;= 7&#39;</span>b0000011;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b1100:LED7S &lt;= 7&#39;</span>b1000110;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b1101:LED7S &lt;= 7&#39;</span>b0100001;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b1110:LED7S &lt;= 7&#39;</span>b0000110;
</span></span><span style=display:flex><span>					  <span style=color:#ae81ff>4</span><span style=color:#e6db74>&#39;b1111:LED7S &lt;= 7&#39;</span>b0001110;
</span></span><span style=display:flex><span>					  default :<span style=color:#a6e22e>LED7S</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>7</span><span style=color:#e6db74>&#39;b1000000;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>				endcase
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		 end
</span></span></span><span style=display:flex><span><span style=color:#e6db74>endmodule
</span></span></span></code></pre></div><p>最终将二进制数字转化为特定的控制信号，以便于后续将信号绑定至开发板的数显管上，实现内容的显示，整合的模块内容如下图所示。</p><p><img alt=image-led1 src=/images/32bitCPU/led1.png></p><h4 id=42-控制单元设计>4.2 控制单元设计</h4><p>该部分内容为对控制单元进行详细的设计，包括控制信号与指令的对应关系，并通过组合逻辑电路的方式对各种控制信号进行实现，并将各控制信号的逻辑电路组合，即可实现基本的控制单元。从而实现输入指令码时同步产生特定的控制信号的功能。</p><h5 id=421-控制信号与指令的对应关系>4.2.1 控制信号与指令的对应关系</h5><p>经过指令功能与数据通路的分析，容易知道各指令需要的数据通路，并推出指定的控制信号值，其存在一一对应关系，如表所示。</p><table><thead><tr><th style=text-align:center>指令</th><th style=text-align:center>OP</th><th style=text-align:center>PCSouces</th><th style=text-align:center>RegDst</th><th style=text-align:center>ALUSrcB</th><th style=text-align:center>ALUOp</th><th style=text-align:center>MemToReg</th><th style=text-align:center>RegWrite</th><th style=text-align:center>MemWrite</th><th style=text-align:center>Clear</th><th style=text-align:center>Branch</th></tr></thead><tbody><tr><td style=text-align:center>Clear</td><td style=text-align:center>000000</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td></tr><tr><td style=text-align:center>Mov</td><td style=text-align:center>000001</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td></tr><tr><td style=text-align:center>Set</td><td style=text-align:center>000010</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td></tr><tr><td style=text-align:center>ADD</td><td style=text-align:center>000011</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td></tr><tr><td style=text-align:center>SUB</td><td style=text-align:center>000101</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td></tr><tr><td style=text-align:center>JMP</td><td style=text-align:center>000110</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td></tr><tr><td style=text-align:center>LW</td><td style=text-align:center>000111</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td></tr><tr><td style=text-align:center>SW</td><td style=text-align:center>001000</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:center>0</td></tr><tr><td style=text-align:center>BEQ</td><td style=text-align:center>001001</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>1</td></tr></tbody></table><h5 id=422-各控制信号的实现>4.2.2 各控制信号的实现</h5><p>逻辑表达式及其实现电路图。</p><h5 id=423-控制单元的组合>4.2.3 控制单元的组合</h5><p>将各个控制信号的实现模块进行组合，实现整个控制单元，能够根据OP码为输入，解析出指定的控制信号。</p><p><img alt=image-Controller src=/images/32bitCPU/Controller.png></p><h4 id=43-模块间连接>4.3 模块间连接</h4><p>根据控制信号与数据通路，将各模块间进行线路连接。</p><p><img alt=image-CPU src=/images/32bitCPU/CPU.png></p><h3 id=五测试结果及分析>五、测试结果及分析</h3><p>本次课程设计编写了9条指令，在完成CPU软件部分的基本搭建后，将对其进行功能测试。首先通过设计好的指令进行若干测试程序的编写，随后在软件层面通过波形图进行仿真检验，完成以上工作后，将基于Quartus II的仿真软件写入FPGA DE0开发板，并将特定的信号绑定到对应的信号灯上，以检验CPU与指令功能的正确性。</p><h4 id=51-程序编写>5.1 程序编写</h4><p>为测试设计的指令与CPU本身的功能正确性与完备性，通过Clear、Mov、Set、ADD、SUB、JMP、LW、SW、BEQ等指令进行若干段程序的编写，尝试测试加减法操作、数据的转移、数据的比较、存储器的读写、条件循环语句等功能。</p><p>为方便表示，记寄存器ax的地址为00101，bx的地址为00110，cx的地址为00111，dx的地址为01000，ex的地址为01001。</p><h5 id=511-加减法测试>5.1.1 加减法测试</h5><p><strong>测试方案：</strong></p><p>将ax寄存器置数为6749H，bx寄存器置数为4238H，将ax与bx中的内容相加存于cx中，dx寄存器置数为1647H，将cx与dx中的内容相减存于ex中，最后使用JMP跳转指令回到程序开头并重复执行。</p><p><strong>编写程序：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Set ax 6749H：	<span style=color:#ae81ff>00001000000001010110011101001001</span>
</span></span><span style=display:flex><span>Set bx 4238H：	<span style=color:#ae81ff>00001000000001100100001000111000</span>
</span></span><span style=display:flex><span>Add ax bx cx：	<span style=color:#ae81ff>00001100101001100011100000000000</span>
</span></span><span style=display:flex><span>Set dx 1647H：	<span style=color:#ae81ff>00001000000010000001011001000111</span>
</span></span><span style=display:flex><span>Sub cx dx ex：	<span style=color:#ae81ff>00010100111010000100100000000000</span>
</span></span><span style=display:flex><span>JMP 0：			<span style=color:#ae81ff>00011000000000000000000000000000</span>
</span></span></code></pre></div><p><strong>期望结果：</strong></p><p>检测并显示ALU的输出结果，应当分别在两条Set指令时显示6749H与4238H，ADD指令后显示相加结果A981H，执行下一条Set指令时应当显示1647H，SUB指令后显示相减结果933AH。</p><h5 id=512-循环语句测试>5.1.2 循环语句测试</h5><p><strong>测试方案：</strong></p><p>计划实现for(int i=ax;i&lt;=bx;i+=cx)的循环功能，首先设置循环变量的初始值ax、终止值bx、循环步长cx，这里令ax为1，bx为9，cx为1。随后使用BEQ指令判断ax和bx中的值是否满足小于等于关系，若满足则PC顺序执行，执行ADD指令，将ax与cx中的内容相加并覆盖于ax中，再使用JMP指令跳转回BEQ指令处，当不满足条件时则PC值向后增加，从而跳出循环程序。</p><p><strong>编写程序：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Set ax 1H：	<span style=color:#ae81ff>00001000000001010000000000000001</span> 
</span></span><span style=display:flex><span>Set bx 9H：	<span style=color:#ae81ff>00001000000001100000000000001001</span> 
</span></span><span style=display:flex><span>Set cx 1H：	<span style=color:#ae81ff>00001000000001110000000000000001</span>
</span></span><span style=display:flex><span>BEQ ax bx：	<span style=color:#ae81ff>00100100101001100000000000001001</span> 
</span></span><span style=display:flex><span>	Add ax cx ax：	<span style=color:#ae81ff>00001100101001110010100000000000</span>
</span></span><span style=display:flex><span>	JMP 3：			<span style=color:#ae81ff>00011000000000000000000000000011</span>
</span></span><span style=display:flex><span>EXIT
</span></span></code></pre></div><h5 id=期望结果>期望结果：</h5><p>在设置初始变量时依次显示1、9、1，BEQ指令时不关注ALU的显示结果，ADD指令时查看ALU的结果，且此时应当隔两个上升沿再查看，应当显示ALU的结果依次从2到9，即实现简单的for循环功能。</p><h5 id=513-内存读写测试>5.1.3 内存读写测试</h5><p><strong>测试方案：</strong></p><p>将ax置数3456H，bx置数1H，作为基址，以bx为基址，3H为偏移量进行内存寻址，将ax中的值存储到对应的内存单元中，再以同样的寻址方式将该内存单元中的内容读取到寄存器cx当中，最后将ax和cx的值进行相加存储到dx当中。</p><p><strong>编写程序：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Set ax 3456H：	<span style=color:#ae81ff>00001000000001010011010001010110</span>
</span></span><span style=display:flex><span>Set bx 1H：		<span style=color:#ae81ff>00001000000001100000000000000001</span>
</span></span><span style=display:flex><span>SW bx ax 3H：	<span style=color:#ae81ff>00100000110001010000000000000011</span>
</span></span><span style=display:flex><span>LW bx cx 3H：	<span style=color:#ae81ff>00011100110001110000000000000011</span>
</span></span><span style=display:flex><span>ADD ax cx dx：	<span style=color:#ae81ff>00001100101001110100000000000000</span>
</span></span><span style=display:flex><span>JMP 0：			<span style=color:#ae81ff>00011000000000000000000000000000</span>
</span></span></code></pre></div><h5 id=期望结果-1>期望结果：</h5><p>检测ALU的输出值，在前两条指令时依次显示3456H和1H，SW时显示最终寻址到的内存地址，即为1H+3H=4H，LW指令也是如此，最后ADD指令时应当输出的结果为3456H*2的结果，即68AC。</p><h4 id=52-程序写入>5.2 程序写入</h4><p>完成程序的编写后，则需要将程序写入指令存储器中，本次课程设计采用MIF文件的方式，即内存初始化文件（Memory Initialization File），将每段程序处理成一个单独的MIF文件，并通过Quartus II软件将其设置到ROM中，即可完成程序的写入。</p><p>以循环语句测试程序为例，对应的MIF文件如图所示，可以看到涉及到的六条指令被依次存放于0-5内存单元中。在Quartus II软件中，MIF文件有指定的可视化填写界面，便于MIF文件的生成和程序指令的写入。</p><p><img alt=image-mif1 src=/images/32bitCPU/mif1.png></p><p>选中ROM模块，可以选择指定MIF文件，从而将程序指令预先写入到指令存储器当中，操作则如图所示。</p><p><img alt=image-mif2 src=/images/32bitCPU/mif2.png></p><h4 id=53-波形仿真>5.3 波形仿真</h4><p>在将仿真工程上传至开发板之前，需要进行一定程度的工程编译与模拟，这里使用了基于ModelSim的波形仿真方法，将几个常见的控制信号、指令以及ALU的计算结果进行监测，分析其运行结果。该部分内容以循环语句测试程序为例。</p><p>新建一个波形仿真文件vwf，将涉及到的节点均导入其中，这里仅以时钟信号clk为输入，各控制信号、当前指令、ALU结果为输出，并将其导入仿真文件，对时钟信号clk设置一定的周期信号，如图所示。</p><p><img alt=image-vwf1 src=/images/32bitCPU/vwf1.png></p><p>运行仿真，观察结果。</p><p>核对指令信息，如图所示。可以看到前三条指令（红色框）依次为Set指令，符合原先编写的代码内容，第四条指令为BEQ指令，值也与原先设置的指令内容一致，后面的指令则进入循环，这是由于BEQ指令的条件判断配合JMP指令的不断跳转使得程序进入循环，这也符合循环语句的实际功能。</p><p><img alt=image-vwf2 src=/images/32bitCPU/vwf2.png></p><p>核对ALU计算结果，如图所示，可以看到前三条SET指令所对应的值正确，并在每一条ADD指令执行后ALU显示一串自增的值，从2开始，以步长为1自增，最终达到9，这也符合原先的程序设定。</p><p><img alt=image-vwf3 src=/images/32bitCPU/vwf3.png></p><p>此外，检查控制信号，将其与表4.1进行核对比较，以检测控制单元的设计正确性。经检查，可以确认各指令的控制信号生成无误。</p><h4 id=54-硬件烧录>5.4 硬件烧录</h4><p>通过软件仿真，可以基本确定CPU以及各条指令的设计正确性，接下来将CPU设计文件编译并下载至开发板中，使用FPGA开发板进行CPU功能的实现。步骤整体包括引脚分配、程序编译、程序烧录。</p><h5 id=541-引脚分配>5.4.1 引脚分配</h5><p>分析设计的CPU可知，执行的指令已经预先写入到ROM之中，唯一的输入信号便是时钟信号，而输出信号可以有很多，可以将其中的运算过程数据绑定到输出引脚上，从而能够显式地观察到执行过程。</p><p>本次课程设计考虑将输入的时钟信号clk绑定到开发板的某一个按钮上，通过手动给与上升沿的方式控制指令的执行，开发板上自带的时钟信号频率过高，不易于执行过程的显示，但可以通过一个频率转换模块进行降频操作；输出信号部分，考虑将ALU的计算结果通过原先设计好的LED显示模块产生数显管信号，并依次绑定到开发板的指定引脚上，同时将控制信号绑定到LED等上，方便对指令的执行情况进行观察。</p><p>对于开发板的引脚名及其对应信号，可以通过查阅DE0开发板的用户手册得知，在此不做赘述。例如Button0所对应的引脚编号为PIN_H2。</p><p>使用Quartus II的Pin Planner工具即可完成对各输入输出信号的引脚分配，具体分配情况如图。</p><p><img alt=image-pin src=/images/32bitCPU/pin.png></p><h5 id=542-程序编译>5.4.2 程序编译</h5><p>软件层面此时已完成了所能涉及到的所有配置，对程序进行编译，编译后Quartus II会自动在outputfile文件夹中生成sof文件，这是一个可重配置的逻辑设备文件，它包含了对 FPGA（现场可编程门阵列）进行重新编程所需的逻辑配置信息。在编译项目期间，Quartus II 将会综合和布局设计，并生成一个可被 FPGA 加载并执行的二进制文件sof。文件如图所示。</p><p><img alt=image-sof1 src=/images/32bitCPU/sof1.png></p><h5 id=543-程序烧录>5.4.3 程序烧录</h5><p>使用Quartus II软件中的Programmer工具即可进行程序的烧录，选择上节中所提到的sof文件即可，在烧录之间，需要安装开发板的指定驱动，并使用串口连接线将其与项目所在的PC连接，启动开发板后Programmer工具即可自动识别开发板，选中sof文件后即可实现开发板的程序烧录。工具界面如图所示。</p><p><img alt=image-sof2 src=/images/32bitCPU/sof2.png></p><p>点击start，观察进度到达100%后，即完成了程序的烧录，开发板已进入了程序运行的状态，由于设置了时钟信号由按钮控制，需要按按钮方可进行指令的顺序执行。</p><h4 id=55-运行结果记录>5.5 运行结果记录</h4><p>本节将对5.1节中设计的若干段测试程序进行运行测试，并记录开发板的显示结果。</p><h5 id=551-加减法测试程序运行结果>5.5.1 加减法测试程序运行结果</h5><p>烧录程序，记录结果，如图所示，可以看到程序的运行结果与期望一致。包括加法后的结果与减法操作后的结果，均符合预计结果，6748H+4238H=A981H，A981H-1647H=933AH，由此判断CPU的基本运算功能无误，且程序进行了数据的读取转移，表现了寄存器堆寄存数据的功能的正确性。</p><p><img alt=image-Test1 src=/images/32bitCPU/Test/Test1.png></p><h5 id=552-循环语句测试程序运行结果>5.5.2 循环语句测试程序运行结果</h5><p>烧录程序，记录结果，如图所示，可以看到程序的运行结果与期望一致。寄存器ax中的内容不断自增，直到到达终止条件bx中的值9，最终程序跳出循环。</p><p><img alt=image-Test2 src=/images/32bitCPU/Test/Test2.png></p><h5 id=553-内存读写测试程序运行结果>5.5.3 内存读写测试程序运行结果</h5><p>烧录程序，记录结果，如图所示，可以看到程序的运行结果与期望一致。SW和LW之类执行时，ALU的结果为寻址地址，即为4H，与测试结果匹配，最后ADD指令会将两个3456H相加，得到结果68ACH，这可以说明通过内存进行数据的读写转移操作成功，数据3456H被顺利的复制。</p><p><img alt=image-Test3 src=/images/32bitCPU/Test/Test3.png></p><h3 id=六心得与体会>六、心得与体会</h3><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style></div><div class="row items-start justify-between"><div class="lg:col-5 mb-10 flex items-center lg:mb-0"><h5 class=mr-3>标签 :</h5><ul><li class=inline-block><a class="bg-theme-light hover:bg-primary dark:bg-darkmode-theme-light dark:hover:bg-darkmode-primary dark:hover:text-dark m-1 block rounded px-3 py-1 hover:text-white" href=/en/tags/%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%bb%84%e6%88%90%e5%8e%9f%e7%90%86/>计算机组成原理</a></li><li class=inline-block><a class="bg-theme-light hover:bg-primary dark:bg-darkmode-theme-light dark:hover:bg-darkmode-primary dark:hover:text-dark m-1 block rounded px-3 py-1 hover:text-white" href=/en/tags/%e7%a1%ac%e4%bb%b6%e8%ae%be%e8%ae%a1/>硬件设计</a></li></ul></div></div></article></div></div></section></main><footer class="bg-theme-light dark:bg-darkmode-theme-light"><div class=container><div class="row items-center py-10"><div class="lg:col-3 mb-8 text-center lg:mb-0 lg:text-left"><a class="navbar-brand inline-block" href=/en/><img fetchpriority=high decoding=async class="img logo-light" width=160 height=32 src=/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_lanczos_3.png"'>
<img fetchpriority=high decoding=async class="img logo-dark" width=160 height=32 src=/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_lanczos_3.png"'></a></div><div class="lg:col-6 mb-8 text-center lg:mb-0"><ul><li class="m-3 inline-block"><a href=/en/about/>个人信息</a></li><li class="m-3 inline-block"><a href=/en/blog/>学习笔记</a></li><li class="m-3 inline-block"><a href=/en/privacy-policy/>相关说明</a></li></ul></div><div class="lg:col-3 mb-8 text-center lg:mb-0 lg:mt-0 lg:text-right"><ul class=social-icons><li><a target=_blank aria-label=github rel="nofollow noopener" href=https://www.github.com/COOOIKX><i class="fab fa-github"></i></a></li><li><a target=_blank aria-label=csdn rel="nofollow noopener" href="https://blog.csdn.net/m0_59701064?spm=1000.2115.3001.5343"><i class="fas fa-home-lg"></i></a></li></ul></div></div></div><div class="border-border dark:border-darkmode-border border-t py-7"><div class="text-light dark:text-darkmode-light container text-center"><p>Designed by Zeon Studio and Developed by LHF</p></div></div></footer><script crossorigin=anonymous integrity="sha256-YQerunHGeT7hXzxweSqFUXgOHHxFceSjmMy/kmnAHWU=" src=/js/script.min.6107abba71c6793ee15f3c70792a8551780e1c7c4571e4a398ccbf9269c01d65.js></script><script defer async crossorigin=anonymous integrity="sha256-w+aS42D2+B+Jix+joZ7pAua1vbu/pRK/IhoP55b8n3w=" src=/js/script-lazy.min.c3e692e360f6f81f898b1fa3a19ee902e6b5bdbbbfa512bf221a0fe796fc9f7c.js></script><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js")</script></body></html>