<!doctype html><html itemscope lang=en-us itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=theme-name content="hugoplate"><link rel="shortcut icon" href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_96x0_resize_lanczos_3.png type=image/x-icon><link rel=icon href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_96x0_resize_lanczos_3.png type=image/x-icon><link rel=icon type=image/png sizes=48x48 href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_48x0_resize_lanczos_3.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_96x0_resize_lanczos_3.png><link rel=apple-touch-icon sizes=144x144 href=/images/favicon_hueb84ecec72665a83aae8c940dfe71474_1906_144x0_resize_lanczos_3.png><link rel=manifest href=/manifest.webmanifest><meta name=msapplication-TileColor content="#ddd"><meta name=theme-color content="#ffffff"><base href=https://lhfgghc.github.io/en/blog/network/><title>【课程笔记】计算机网络</title>
<meta name=keywords content="Boilerplate,Hugo"><meta name=description content="this is meta description"><meta name=author content="zeon.studio"><meta property="og:image" content="https://lhfgghc.github.io/images/og-image.png"><meta name=twitter:image content="https://lhfgghc.github.io/images/og-image.png"><meta name=twitter:card content="summary_large_image"><meta property="og:image:width" content="900"><meta property="og:image:height" content="600"><meta property="og:image:type" content="image/
        .png
      "><meta property="og:title" content="【课程笔记】计算机网络"><meta property="og:description" content="this is meta description"><meta property="og:type" content="website"><meta property="og:url" content="https://lhfgghc.github.io/en/blog/network/"><meta name=twitter:title content="【课程笔记】计算机网络"><meta name=twitter:description content="this is meta description"><script>let indexURL="https://lhfgghc.github.io/en/searchindex.json",includeSectionsInSearch=["blog"],search_no_results="未找到结果",search_initial_message="输入内容以搜索"</script><meta http-equiv=x-dns-prefetch-control content="on"><link rel=preconnect href=https://use.fontawesome.com crossorigin><link rel=preconnect href=//cdnjs.cloudflare.com><link rel=preconnect href=//www.googletagmanager.com><link rel=preconnect href=//www.google-analytics.com><link rel=dns-prefetch href=https://use.fontawesome.com><link rel=dns-prefetch href=//ajax.googleapis.com><link rel=dns-prefetch href=//cdnjs.cloudflare.com><link rel=dns-prefetch href=//www.googletagmanager.com><link rel=dns-prefetch href=//www.google-analytics.com><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//connect.facebook.net><link rel=dns-prefetch href=//platform.linkedin.com><link rel=dns-prefetch href=//platform.twitter.com><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600&family=Signika:wght@500;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><link href="/css/style.min.4c1d4c3120637c4b33d33d38988a2525a8e15057b5ab0cfa95ce5147d4c95adc.css" integrity="sha256-TB1MMSBjfEsz0z04mIolJajhUFe1qwz6lc5RR9TJWtw=" rel=stylesheet><link defer async rel=stylesheet href="/css/style-lazy.min.ec14d2549e8e0fbaf9af20dcc88fad37fb352e5bd5978a801dc1c3f5a5922174.css" integrity="sha256-7BTSVJ6OD7r5ryDcyI+tN/s1LlvVl4qAHcHD9aWSIXQ=" media=print onload='this.media="all",this.onload=null'></head><body><header class="header sticky top-0 z-30"><nav class="navbar container"><div class=order-0><a class="navbar-brand block" href=/en/><img fetchpriority=high decoding=async class="img logo-light" width=160 height=32 src=/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_lanczos_3.png"'>
<img fetchpriority=high decoding=async class="img logo-dark" width=160 height=32 src=/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_lanczos_3.png"'></a></div><input id=nav-toggle type=checkbox class=hidden>
<label for=nav-toggle class="order-3 cursor-pointer flex items-center lg:hidden text-dark dark:text-white lg:order-1"><svg id="show-button" class="h-6 fill-current block" viewBox="0 0 20 20"><title>Menu Open</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0V0z"/></svg><svg id="hide-button" class="h-6 fill-current hidden" viewBox="0 0 20 20"><title>Menu Close</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></label><ul id=nav-menu class="navbar-nav order-3 hidden lg:flex w-full pb-6 lg:order-1 lg:w-auto lg:space-x-2 lg:pb-0 xl:space-x-8"><li class=nav-item><a class=nav-link href=/en/>主页</a></li><li class=nav-item><a class=nav-link href=/en/blog/>学习笔记</a></li><li class=nav-item><a class=nav-link href=/en/about/>个人信息</a></li><li class="nav-item nav-dropdown group relative"><span class="nav-link
inline-flex items-center">其它<svg class="h-4 w-4 fill-current" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg></span><ul class="nav-dropdown-list lg:group-hover:visible lg:group-hover:opacity-100"><li class=nav-dropdown-item><a class=nav-dropdown-link href=/en/elements/>样式Draft</a></li><li class=nav-dropdown-item><a class=nav-dropdown-link href=/en/privacy-policy/>相关说明</a></li><li class=nav-dropdown-item><a class=nav-dropdown-link href=/en/categories/>笔记分类</a></li></ul></li></ul><div class="order-1 ml-auto flex items-center md:order-2 lg:ml-0"><button aria-label=search class="border-border text-dark hover:text-primary dark:border-darkmode-border mr-5 inline-block border-r pr-5 text-xl dark:text-white dark:hover:text-darkmode-primary" data-target=search-modal>
<i class="fa-solid fa-search"></i></button><div class="theme-switcher mr-5"><input id=theme-switcher data-theme-switcher type=checkbox>
<label for=theme-switcher><span class=sr-only>theme switcher</span>
<span><svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 opacity-100 dark:opacity-0" viewBox="0 0 56 56" fill="#fff" height="16" width="16"><path d="M30 4.6c0-1-.9-2-2-2a2 2 0 00-2 2v5c0 1 .9 2 2 2s2-1 2-2zm9.6 9a2 2 0 000 2.8c.8.8 2 .8 2.9.0L46 13a2 2 0 000-2.9 2 2 0 00-3 0zm-26 2.8c.7.8 2 .8 2.8.0.8-.7.8-2 0-2.9L13 10c-.7-.7-2-.8-2.9.0-.7.8-.7 2.1.0 3zM28 16A12 12 0 0016 28a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0028 16zm23.3 14c1.1.0 2-.9 2-2s-.9-2-2-2h-4.9a2 2 0 00-2 2c0 1.1 1 2 2 2zM4.7 26a2 2 0 00-2 2c0 1.1.9 2 2 2h4.9c1 0 2-.9 2-2s-1-2-2-2zm37.8 13.6a2 2 0 00-3 0 2 2 0 000 2.9l3.6 3.5a2 2 0 002.9.0c.8-.8.8-2.1.0-3zM10 43.1a2 2 0 000 2.9c.8.7 2.1.8 3 0l3.4-3.5c.8-.8.8-2.1.0-2.9s-2-.8-2.9.0zm20 3.4c0-1.1-.9-2-2-2a2 2 0 00-2 2v4.9c0 1 .9 2 2 2s2-1 2-2z"/></svg><svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 opacity-0 dark:opacity-100" viewBox="0 0 24 24" fill="none" height="16" width="16"><path fill="#000" fill-rule="evenodd" clip-rule="evenodd" d="M8.2 2.2c1-.4 2 .6 1.6 1.5-1 3-.4 6.4 1.8 8.7a8.4 8.4.0 008.7 1.8c1-.3 2 .5 1.5 1.5v.1A10.3 10.3.0 0112.4 22 10.3 10.3.0 013.2 6.7c1-2 2.9-3.5 4.9-4.4z"/></svg></span></label></div><script>var darkMode=!1,themeSwitch;window.matchMedia("(prefers-color-scheme: dark)").matches&&(darkMode=!0),localStorage.getItem("theme")==="dark"?darkMode=!0:localStorage.getItem("theme")==="light"&&(darkMode=!1),darkMode&&document.documentElement.classList.toggle("dark"),themeSwitch=document.querySelectorAll("[data-theme-switcher]"),document.addEventListener("DOMContentLoaded",()=>{[].forEach.call(themeSwitch,function(e){e.checked=!!darkMode,e.addEventListener("click",()=>{document.documentElement.classList.toggle("dark"),localStorage.setItem("theme",document.documentElement.classList.contains("dark")?"dark":"light")})})})</script></div></nav></header><div class=search-modal aria-hidden=true style=--color-primary:#121212><div data-target=close-search-modal class=search-modal-overlay></div><div class=search-wrapper data-image=true data-description=true data-tags=true data-categories=true><div class=search-wrapper-header><label for=search-modal-input style=margin-top:-1px><span class=sr-only>search icon</span>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="18" width="18" class="search-icon" data-type="search"><path fill="currentcolor" d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8.0 45.3s-32.8 12.5-45.3.0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9.0 208S93.1.0 208 0 416 93.1 416 208zM208 352a144 144 0 100-288 144 144 0 100 288z"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="18" width="18" class="search-reset" data-type="reset"><path fill="currentcolor" d="M256 512A256 256 0 10256 0a256 256 0 100 512zM175 175c9.4-9.4 24.6-9.4 33.9.0l47 47 47-47c9.4-9.4 24.6-9.4 33.9.0s9.4 24.6.0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6.0 33.9s-24.6 9.4-33.9.0l-47-47-47 47c-9.4 9.4-24.6 9.4-33.9.0s-9.4-24.6.0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6.0-33.9z"/></svg>
</label><input id=search-modal-input type=text data-search-input autocomplete=off aria-label=Search placeholder=搜索></div><div class=search-wrapper-body><div class=search-result data-search-result></div><span class=search-result-empty>输入内容以搜索</span></div><div class=search-wrapper-footer><span><kbd><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentcolor" viewBox="0 0 16 16"><path d="M3.204 11h9.592L8 5.519 3.204 11zm-.753-.659 4.796-5.48a1 1 0 011.506.0l4.796 5.48c.566.647.106 1.659-.753 1.659H3.204a1 1 0 01-.753-1.659z"/></svg>
</kbd><kbd><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentcolor" style="margin-top:1px" viewBox="0 0 16 16"><path d="M3.204 5h9.592L8 10.481 3.204 5zm-.753.659 4.796 5.48a1 1 0 001.506.0l4.796-5.48c.566-.647.106-1.659-.753-1.659H3.204a1 1 0 00-.753 1.659z"/></svg>
</kbd>导航
</span><span><kbd><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentcolor" style="display:inline-block" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M14.5 1.5a.5.5.0 01.5.5v4.8a2.5 2.5.0 01-2.5 2.5H2.707l3.347 3.346a.5.5.0 01-.708.708l-4.2-4.2a.5.5.0 010-.708l4-4a.5.5.0 11.708.708L2.707 8.3H12.5A1.5 1.5.0 0014 6.8V2a.5.5.0 01.5-.5z"/></svg>
</kbd>选择
</span><span class=search-result-info></span>
<span data-target=close-search-modal><kbd>ESC</kbd> 关闭</span></div></div></div><main><section class="section pt-7"><div class=container><div class="row justify-center"><article class=lg:col-10><h1 class="h2 mb-4">【课程笔记】计算机网络</h1><ul class=mb-4><li class="mr-4 inline-block"><a href=/en/authors/liang-hangfeng/><i class="fa-regular fa-circle-user mr-2"></i>Liang Hangfeng</a></li><li class="mr-4 inline-block"><i class="fa-regular fa-folder mr-2"></i>
<a href=/en/categories/%e8%af%be%e7%a8%8b%e7%ac%94%e8%ae%b0/>课程笔记</a></li><li class="mr-4 inline-block"><i class="fa-regular fa-clock mr-2"></i>
March 12, 2023</li></ul><div class="content mb-10"><h2 id=chapter1-计算机网络与因特网概述>Chapter1. 计算机网络与因特网（概述）</h2><h3 id=11-相关概念>1.1 相关概念：</h3><p>1.因特网服务提供者ISP（Internet Service Provider），提供IP地址，从而通过ISP接入因特网。</p><p>2.分组交换机（packet switch），如路由器（router）和链路层交换机（link-layer switch）。</p><p>3.主机（host）、端系统（end system），两者意义相同，主机可进一步被分为客户（client）和服务器（server）。</p><h3 id=12-网络边缘---接入网access-network>1.2 网络边缘 - 接入网（access network）</h3><h4 id=1定义>1.定义</h4><p>指端系统连接到其边缘路由器（edge router）的物理链路。边缘路由器是端系统到任何其它远程端系统的路径上的第一台路由器。</p><h4 id=2家庭接入网residential-access-nets>2.家庭接入网（residential access nets）</h4><p>常见类型：数字用户线（Digital Subscriber Line，DSL）和电缆因特网接入（cable Internet access）。</p><p>数字用户线：每个用户的DLS调制解调器（modem）使用现有的电话线（双绞铜线）与位于本地电话公司的本地中心局（center office，CO）中的数字用户接入复用器（DSL access multiplexer，DSLAM）来交换数据。</p><p>电缆接入：采用<strong>频分复用</strong>（frequency division multiplexing）。且这个系统中应用了光纤和同轴电缆，被称为混合光纤同轴（Hybrid Fiber Coax，HFC）。与DSL类似，电缆调制解调器（cable modem）与电缆调制解调器端接系统（Cable Modem Termination System，CMTS）进行数据交换。
光纤到户（Fiber to the home，FTTH）</p><h4 id=3企业接入网enterprise-access-networks->3.企业接入网（Enterprise access networks ）</h4><p>以太网（Ethernet），通过以太网交换机与机构路由器相连，用户通过双绞铜线与以太网交换机相连。</p><p>局域网（LAN）</p><h4 id=4无线接入网wireless-access-networks>4.无线接入网（Wireless access networks）</h4><p>wireless LANs（无线局域网） 与 wide-area wireless access（广域无线接入）</p><h4 id=5物理媒介physical-media>5.物理媒介（Physical media）</h4><p>引导型媒体（guided media）</p><p>双绞线（twisted pair ,TP）、同轴电缆（coaxial cable）：两个同心的铜导体、光缆（fiber optic cable）</p><p>非引导型媒体（unguided media）</p><p>地面微波（terrestrial microwave）、卫星无线电信道（satellite）</p><h4 id=6主机发送数据报文host-sends-packets-of-data><strong>6.主机发送数据报文（Host: sends packets of data）</strong></h4><p>将应用数据分成L bits长度的小块，称为包（packets）。</p><p>以R(bits/sec)的传输速率（transmission rate）将数据包送入接入网。</p><p>链路传输速率，也就是链路容量（link capacity），也就是链路带宽（bandwidth）。</p><p>报文传输时延（packet transmission delay）：将l位数据包传输到链路所需的时间。计算式为L/R。</p><h3 id=13-网络核心>1.3 网络核心</h3><h4 id=1分组交换网络包交换网络packet-switching>1.分组交换网络（包交换网络）Packet-switching</h4><p>主机将应用层消息分解成<strong>包</strong>，数据块种有目的地址、源地址等辅助信息。</p><p>单个分组传递到相邻节点，存储后查找转发表，转发到下一个节点。</p><p>在源和目的地之间，每个分组都通过通信链路和<strong>分组交换机（packet switch）</strong>，分组交换机有两类：路由器和链路层交换机。</p><p>关键为<strong>存储与转发</strong>（<em>store and forward</em>）。对于路由器，在对输出链路传输当前分组的第一个比特之前，需要接收到整个分组。</p><p>则对于长度为L bits的分组，需要L/R的时间完成源到路由器之间的传输，该时间过后路由器接收到整个分组，再进行下一次传输，总时延为2L/R。</p><p><strong>排队时延和分组丢失</strong>（queue delay and loss）</p><p>分组丢失（丢包）（packet lost）：输出缓存（output buffer）或称输出队列（output queue）容量有限。</p><p>两个关键的网络核心功能：<strong>路由、转发</strong>（routing and forwarding）</p><p>每台路由器具有一个转发表（forwarding table），用于将目的地地址映射成输出链路。</p><h4 id=2电路交换网络-circuit-switching>2.电路交换网络 circuit switching</h4><p>包含以下三个步骤：（1）建立连接；（2）通话；（3）释放连接。效率较低，线路上真正用来传输的时间往往不到10%。</p><h4 id=3报文交换网络>3.报文交换网络</h4><p>报文交换是分组交换的前身。报文被整个地交换而非拆分成若干个分组。</p><h3 id=14-计算机网络的分类>1.4 计算机网络的分类</h3><h4 id=1按网络的覆盖范围分类>1.按网络的覆盖范围分类</h4><p>广域网(Wide Area Network，WAN)</p><p>城域网(Metropolitan Area Network，MAN)</p><p>局域网(Local Area Network，LAN)</p><p>个域网(Personal Area Network，PAN)</p><h4 id=2按网络的使用者分类>2.按网络的使用者分类</h4><p>公用网（Public Network）</p><p>专用网（Private Network）</p><h4 id=3按其它角度分类>3.按其它角度分类</h4><p>传输介质分类：无线和有线</p><p>网络拓扑分类：总线型、星型、环形、网状型</p><p>交换方式分类：电路交换、报文交换、分组交换</p><p>传输技术分类：点对点、广播</p><h3 id=15-计算机网络的性能指标>1.5 计算机网络的性能指标</h3><h4 id=1速率>1.速率</h4><p>指数据的传送速率，每秒传送多少个比特，也称为数据率（Data Rate）和比特率（Bit Rate）。单位为bps。</p><p>**注意：**数据量单位中的K、M、T、G为2的10次、20次、30次、40次幂；速率单位中的k、M、G、T为10的3次、6次、9次、12次。</p><h4 id=2带宽bandwidth>2.带宽Bandwidth</h4><p>在模拟信号在中带宽的单位为HZ，指某个信号所包含的各种不同频率成分所占的频率范围。</p><p>计算机网络中表示线路的<strong>数据传输能力</strong>，单位和速率单位一致。</p><p>传输速率从主机接口速率、线路带宽、交换器或者路由器接口速率中取最小值。（木桶效应）</p><h4 id=3吞吐量throughput>3.吞吐量throughput</h4><p>单位时间通过某个网络或者接口的实际数据量。常被用于对于实际网络的测量。</p><p>通信相关的应用程序增多时、吞吐量也会随之增大，但是受到网络带宽的限制。</p><h4 id=4时延delaylatency>4.时延delay/latency</h4><p>由<strong>传输时延</strong>（transmission delay ，发送时延）、<strong>传播时延</strong>（propagation delay）、排队时延（queuing delay）、处理时延（processing delay）四部分组成。</p><h5 id=传输时延>传输时延</h5><p>或称发送时延，指主机或者路由器发送路由器所耗费的时间，从发送分组的第一个比特开始到最后一个比特发送完毕的时间。
$$
发送时延=\frac{分组长度(b)}{发送速率(b/s)}
$$</p><h5 id=传播时延>传播时延</h5><p>指电磁波在链路上传播一定距离所耗费的时间。
$$
传播时延=\frac{链路长度(m)}{电磁波在链路上的传播速率(m/s)}
$$</p><h5 id=排队时延>排队时延</h5><p>分组进入路由器后，在路由器的输入队列中排队缓存并等待处理。</p><p>网络通信量很大时，可能会造成路由器的队列溢出，使分组丢失，这时候排队时延相当于无穷大。</p><h5 id=处理时延>处理时延</h5><p>例如检查分组首部是否误码、提取地址、查找转发接口等。</p><h4 id=5时延带宽积>5.时延带宽积</h4><p>$$
时延带宽积=传播时延(s)×链路带宽(b/s)
$$</p><p>表示该链路能够容量的比特数目。也成为以比特为单位的链路长度。</p><h4 id=6往返时间>6.往返时间</h4><p>往返时间（Round-Trip Time，RTT）指从发送端发送数据分组开始，到发送端受到从接收端发来的相应的确认分组的耗费时间。</p><h3 id=16-计算机网络体系结构>1.6 计算机网络体系结构</h3><h4 id=1开放系统互连参考模型>1.开放系统互连参考模型</h4><p>国际标准化组织（International Organization for Standardization，ISO）提出开放系统互连参考模型（Open Systems Interconnection Reference Model，OSI/RM，简称OSI）。是一个七层协议的体系结构：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层。</p><h4 id=2tcpip参考模型>2.TCP/IP参考模型</h4><p>是一个四层协议的体系结构，网络接口层、网际层、运输层、应用层。核心协议是<strong>网际协议IP</strong>。</p><p>传输控制协议（Transmission Control Protocol，TCP）和用户数据报协议（User Datagram Protocol，UDP）是TCP/IP体系结构传输层中的两个重要协议。</p><h4 id=3原理参考模型>3.原理参考模型</h4><p>五层协议的体系结构：物理层、数据链路层、网络层、传输层、应用层。</p><h4 id=4各层的任务>4.各层的任务</h4><p>应用层：解决通过应用进程的交互来实现特定网络应用的问题</p><p>运输层：解决进程之间基于网络的通信问题</p><p>网络层：解决数据包在多个网络之间传输和路由的问题</p><p>数据链路层：解决数据包在一个网络或者一段链路上传输的问题</p><p>物理层：解决使用何种信号来表示比特0和1的问题</p><h3 id=17-专用术语>1.7 专用术语</h3><h4 id=1对等实体和实体>1.对等实体和实体</h4><p>实体是指任何可发送或者接收信息的硬件或者软件进程。</p><p>对等实体就是通信双方相同层次中的实体。</p><h4 id=2协议>2.协议</h4><p>协议是控制两个对等实体在“水平方向”进行“逻辑通信”的规则的集合。</p><p>计算机网络协议由三个要素：语法、语义、同步</p><h5 id=语法>语法</h5><p>用来定义通信双方所交换信息的格式</p><h5 id=语义>语义</h5><p>用来定义通信双方所要完成的操作。</p><h5 id=同步>同步</h5><p>用来定义通信双方的时序关系。</p><h4 id=3服务>3.服务</h4><p>在协议的控制下，两个对等实体在水平方向上的逻辑通信使得本层能够向上一层提供服务。要实现本层协议，还要使用下一层所提供的服务。</p><p>在同一系统中相邻两层的实体交换信息的逻辑接口被称为服务访问点。服务访问点用于区别不同的服务类型。</p><p>数据链路层的服务访问点为帧的“类型”字段；网络层的服务访问点为IP数据包的“协议”字段；传输层的服务访问点为“端口号”字段。</p><p>上层要使用下层提供的服务，必须通过与下层交换一些命令，成为服务原语。</p><h4 id=4数据包术语>4.数据包术语</h4><p>对等实体之间传送的数据包被称为该层的协议数据单元（Protocol Data Unit，PDU）。</p><p>物理层：比特流（bit stream）</p><p>数据链路层：帧（frame）</p><p>网络层：分组（packet）；如果是IP协议，也成为IP数据报</p><p>运输层：使用TCP协议，为TCP报文段（segment）；使用UDP协议，为用户数据报（datagram）</p><p>应用层：应用报文（message）</p><h2 id=chapter2-应用层>Chapter2. 应用层</h2><h3 id=21-网络应用体系结构>2.1 网络应用体系结构</h3><h4 id=1-客户服务器方式>1. 客户/服务器方式</h4><p>客户和服务器是指通信中所涉及的两个应用进程。客户/服务器方式（Client/Server，CS）所描述的是进程之间服务和被服务的关系。</p><p>基于C/S方式的应用服务通常是服务集中型的。</p><h4 id=2-对等方式>2. 对等方式</h4><p>没有固定的服务请求者和服务提供者，分布在网络边缘的各端系统中的应用进程是对等的，被称为对等方。</p><p>基于P2P的应用是服务分散型 ，突出的特征之一就是它的可拓展性。</p><h3 id=22-动态主机配置协议>2.2 动态主机配置协议</h3><h4 id=1dhcp的作用>1.DHCP的作用</h4><p>网络中的主机开机后自动启动DHCP程序，向DHCP服务器请求网络配置参数，包括IP地址、子网掩码、默认网关、DNS服务器。</p><p>DHCP可为计算机自动配置网络参数，使得计算机“即插即联网”（Plug-and-Play Networking）。</p><h4 id=2dhcp工作过程>2.DHCP工作过程</h4><h5 id=下层协议>下层协议</h5><p>使用UDP提供的服务</p><h5 id=udp端口号>UDP端口号</h5><p>DHCP服务器使用67；DHCP客户使用68</p><h5 id=工作流程>工作流程</h5><h6 id=1dhcp-discover>（1）DHCP DISCOVER</h6><p>DHCP客户端广播DHCP发现报文（DHCP DISCOVER）。</p><p>源IP为0.0.0.0，目的IP为255.255.255.255。</p><h6 id=2dhcp-offer>（2）DHCP OFFER</h6><p>DHCP服务器发现DHCP发现报文后，根据封装的MAC地址来查找数据库，查看是否有针对该MAC的配置信息。</p><p>如果有则采用这些配置信息发送DHCP提供报文（DHCP OFFER）；如果没有，则采用默认配置信息进行发送。</p><p>源IP为DHCP服务器的IP地址，目的IP仍为255.255.255.255。</p><p>网络中的所有设备都会接收到DHCP OFFER，对于服务器会丢弃报文；对于主机则会进行检验是否为本主机发出的请求。</p><p>Tips：DHCP服务器从自己的IP地址池中挑选待租用给主机的IP地址时，会使用ARP来确保所选的IP地址从未被网络中的其它主机占用。</p><h6 id=3dhcp-request>（3）DHCP REQUEST</h6><p>DHCP客户向所选择的DHCP服务器发送一个DHCP请求报文（DHCP REQUEST）。</p><p>源IP为0.0.0.0，目的IP为255.255.255.255。以告知网络中的DHCP服务器是否被选择。</p><p>DHCP REQUEST中封装事务ID、DHCP客户端的MAC地址和接收的租约中的IP地址，提供租约的服务器IP等信息。</p><h6 id=4dhcp-ack>（4）DHCP ACK</h6><p>服务器向DHCP客户端发送DHCP确认报文（DHCP ACK）。</p><p>源IP为服务器的IP地址，目的IP仍为广播。</p><p>DHCP客户收到该ACK报文段后，就可以使用所租用到的IP地址了。</p><p>Tips：在使用租用的IP地址之前，主机还会通过ARP检测该IP地址是否被网络中的其他主机占用。若被占用，则发送DHCP谢绝报文（DHCP DECLINE），并重新发送DHCP DISCOVER。</p><h6 id=5更新租用期>（5）更新租用期</h6><p>当IP的租期过半，DHCP客户会向DHCP服务器发送DHCP REQUEST来请求更新租用期。</p><p>这里的REQUEST报文的源IP为原先租用到的IP地址，目的IP为DHCP服务器的地址。</p><h6 id=6续租响应>（6）续租响应</h6><p>1.DHCP服务器同意续租，发送DHCP ACK。</p><p>2.DHCP服务器拒绝续租，发送DHCP否认报文（DHCP NACK）。DHCP服务器收到NACK后，需要立即停止使用该租用的IP地址，并重新发送DHCP DISCOVER来获取IP地址。</p><p>3.DHCP服务器未响应，在租用期过了87.5%后，DHCP客户必须重新发送DHCP REQUEST，若未响应，则在租用期到期后立即停止使用IP并重新获取IP地址。</p><h6 id=7dhcp-release>（7）DHCP RELEASE</h6><p>DHCP客户可以随时提前终止DHCP服务器所提供的租用期，发送DHCP释放报文（DHCP RELEASE）。</p><p>源IP为0.0.0.0，目的IP为255.255.255.255。</p><h5 id=备注>备注</h5><p>DHCP为了增强协议的健壮性，规定：如果TCP/IP协议栈在初始化的过程中不接受单播IP数据包，则对于DHCP DISCOVER和DHCP REQUEST报文中，通过设置”BROADCAST“标志位为1，告知DHCP服务器，之后使用广播形式进行通信；反之”BROADCAST“标志位设置为0，并在报文中填入自己的MAC地址，则DHCP服务器在数据链路层封装帧的时候可以填入该MAC地址。</p><h4 id=3dhcp中继代理>3.DHCP中继代理</h4><p>DHCP DISCOVER广播报文不会被路由器进行转发，需要给路由器配置DHCP服务器的IP地址并使之成为DHCP中继代理。</p><p>当成为DHCP中继代理的路由器收到广播的DHCP发现报文后，会将其单播给DHCP服务器。</p><h3 id=23-域名系统>2.3 域名系统</h3><p>DNS使用UDP，熟知端口号为53.</p><h4 id=1因特网的域名结构>1.因特网的域名结构</h4><p>域名的结构由若干分量组成，各分量之间用.隔开，分别代表不同级别的域名。每一级的域名都由英文字母和数字组成，不超过63个字符，也不区分大小写。完整的域名不超过255个字符。</p><p>如：&mldr;三级域名.二级域名.顶级域名。eecs.nbu.edu.cn。</p><p>cn是顶级域名，代表中国；edu是在其下注册的二级域名，代表教育机构；nbu是在edu下注册的三级域名，代表宁波大学；eecs代表该校自行管理的四级域名，为信息学院。</p><h5 id=顶级域名>顶级域名</h5><p>顶级域名（Top Level Domain，TLD）分为以下三类。</p><p>1.国家顶级域名(nTLD)</p><p>2.通用顶级域名(gTLD)：com代表公司企业；net代表网络服务机构；org代表非营利性组织；int代表国际组织；edu代表美国教育机构；gov代表美国政府部门；mil代表美国军事部门</p><p>3.反向域(arpa)：用于反向域名解析。</p><h5 id=二级域名>二级域名</h5><p>在国家顶级域名下注册的二级域名由该国家自行确定。</p><p>我国将二级域名划分为以下两类：</p><p>1.类别域名：共七个，ac科研机构；com工商金融等企业；edu教育机构；gov政府部门；net提供网络服务的机构；mil军事机构；org非营利性组织。</p><p>2.行政区域名：共34个，适用于我国各省、自治区、直辖市。</p><p>Tips：名称相同的域名其等级未必相同。</p><h4 id=2-因特网上的域名服务器>2. 因特网上的域名服务器</h4><p>域名系统DNS使用分布在各地的域名服务器来实现域名到IP地址的转换。</p><p>分为以下四个类型：</p><h5 id=根域名服务器>根域名服务器</h5><p>最高层次的域名服务器，每个根域名服务器都知道所有的顶级域名服务器的域名和IP地址。</p><p>因特网上共有13个不同IP地址的根域名服务器，但每台服务器实际上是分布在世界各地的计算机组成的服务器群集。</p><h5 id=顶级域名服务器>顶级域名服务器</h5><p>这些域名服务器负责管理在其下注册的所有二级域名。</p><p>当收到DNS查询请求时就会给出响应的回答，这可能是最终的查询结果，也可能是下一级权限域名服务器的IP地址。</p><h5 id=权限域名服务器>权限域名服务器</h5><p>负责管理某个区的域名，每个主机的域名都必须在某个权限域名服务器所在处注册登记。</p><p>权限域名服务器知道其管辖的域名和IP地址的映射关系。也知道其下级域名服务器的地址。</p><h5 id=本地域名服务器>本地域名服务器</h5><p>主机发送DNS请求报文时首先会被送往该主机的本地域名服务器。</p><p>本地域名服务器有代理的作用，会将报文转发给上述的域名服务器的等级结构中。</p><p>本地域名服务器也叫默认域名服务器，其IP地址需要直接配置在需要域名解析的主机中。</p><h4 id=3域名解析过程>3.域名解析过程</h4><p>因特网有两种域名查询方式：递归查询和迭代查询。</p><p>递归查询主要是各级域名服务器接受上一级的委托后直接对下一级的域名服务器发起查询请求。</p><p>迭代查询通过本地域名服务器依次访问根域名服务器、顶级域名服务器、权限域名服务器，对应的服务器地址由上一级域名服务器给出。</p><p>Tips：对于含有CDN的服务器的访问，在权威服务器处可能不会直接返回对应的IP地址，而是返回其对应的CDN服务器的权威域名服务器的域名。（重定向）</p><h4 id=4域名系统高速缓存>4.域名系统高速缓存</h4><p>高速缓存用来存放最近查询过的域名以及从何处获得域名映射信息的记录。（记录时间通常为2天）</p><p>不但在本地域名服务器中需要高速缓存，在用户主机中也需要。许多用户主机在启动时则从其本地域名服务器下载所有映射信息，只有在查询信息不存在时则向本地域名服务器发出查询请求。</p><h4 id=5dns记录和报文>5.DNS记录和报文</h4><p>DNS服务器存储了资源记录（Resource Record，RR），RR提供了从主机名到IP地址的映射。</p><p>RR是一个四元组：{name，value，type，ttl}。</p><p>TTL是该记录的生存时间，记录了应当从缓存中删除的时间。</p><h5 id=type-a>Type A</h5><p>此时Name是主机名，value是对应的IP地址。</p><p>一条类型为A的RR提供了从标准主机名到IP地址的映射。</p><h5 id=type-ns>Type NS</h5><p>对该域中的主机来说Name是域（如foo.com），Value是一个知道如何获取该域中主机IP地址的权威域名服务器的主机名。</p><p>例如(foo.com dns.foo.com NS)就是一条类型为NS的RR。</p><h5 id=type-cname>Type CNAME</h5><p>Value是主机别名（host aliasing）Name对应的规范主机名（canonical hostname）。</p><p>该记录能够向查询的主机提供一个主机对应的规范主机名。</p><p>主机别名要比规范主机名来的容易记忆。</p><h5 id=type-mx>Type MX</h5><p>Value是一个别名为Name的邮件服务器的规范主机名。</p><p>MX记录允许邮件服务器主机名具有简单的别名。通过MX记录，一个公司的邮件服务器和其他服务器（例如它的Web服务器）可以拥有相同的别名。</p><h5 id=dns报文格式>DNS报文格式</h5><h6 id=首部区域>首部区域</h6><p>第一个字段（标识符）是一个16bit的数，用于标识该查询。会被复制到对查询的回答报文中，以便让客户用来匹配发送的请求和接收的回答。</p><p>标识字段含有若干标识：1.查询/回答 2.权威的 3.希望递归 4.递归可用。</p><p>首部中也包含一些有关数量的字段：问题数、回答RR数、权威RR数、附加RR数。</p><h6 id=问题区域>问题区域</h6><p>包含Name字段和Type字段</p><h6 id=回答区域>回答区域</h6><p>包含了对最初请求的名字的资源记录。再回答区域可以包含多条RR，因此一个主机名能有多个IP地址。</p><h6 id=权威区域>权威区域</h6><p>权威区域包含了其它权威服务器的记录</p><h6 id=附加区域>附加区域</h6><p>附加区域包含了其他有用的记录。例如：一条MX请求的查询，回答区域包含了一个RR，提供了规范主机名，在附加区域中，该记录也提供了对于邮件服务器的规范主机名所对应的IP地址。</p><h3 id=24-文件传输协议>2.4 文件传输协议</h3><p>FTP提供交互式的访问，允许客户明确文件类型与格式，并允许文件具有存取权限。</p><p>FTP常见的用途是在计算机之间传输文件，尤其是用于批量传输文件。FTP的另一个用途是让网站的设计者将构成的网站内容的大量文件批量上传到他们的Web服务器。</p><h4 id=1ftp的工作原理>1.FTP的工作原理</h4><p>FTP采用C/S方式，由主动模式和被动模式。</p><h5 id=主动模式>主动模式</h5><p>FTP服务器主动连接FTP客户。</p><p>（1）FTP服务器监听监听端口号21，FTP客户随机选择一个临时端口号与其建立<strong>TCP连接</strong>，这条TCP连接用于FTP客户和服务器之间传送FTP的相关控制命令。</p><p>（2）有数据要传输时，FTP客户通过命令通道告知FTP服务器，让FTP服务器和FTP客户的另一个临时端口号建立TCP连接，为数据通道。</p><p>（3）FTP服务器使用20端口和FTP客户告知的临时端口号建立TCP连接，用于文件的传输。</p><h5 id=被动模式>被动模式</h5><p>其余步骤与主动模式类似，在数据通路的建立过程中，为客户向服务器发起TCP连接。即在FTP服务器协商好临时端口后被动地等待FTP客户的TCP连接。</p><h3 id=25-电子邮件>2.5 电子邮件</h3><h4 id=1电子邮件的组成>1.电子邮件的组成</h4><h5 id=用户代理>用户代理</h5><p>用户代理是用户和电子邮件系统的接口，又称为电子邮件客户端软件。</p><h5 id=邮件服务器>邮件服务器</h5><p>邮件服务器是电子邮件系统的基础设施。因特网上所有的ISP都有邮件服务器，其功能是发送和接受邮件，还要维护用户的邮箱。</p><h5 id=电子邮件协议>电子邮件协议</h5><p>发送方使用用户代理通过邮件发送协议（例如SMTP），将邮件发送给发送方的服务器；发送方服务器通过邮件发送协议将邮件发送到接收方的服务器；接收方使用用户代理通过邮件读取协议（例如POP3和IMAP）从接收方服务器中读取邮件。</p><h4 id=2-电子邮件的发送和接受过程>2. 电子邮件的发送和接受过程</h4><p>（1）发送方作为SMTP客户，与发送方邮件服务器中的SMTP服务器进行TCP连接，端口号为25。</p><p>（2）发送方邮件服务器中的SMTP客户和接收方邮件服务器中的SMTP服务器进行TCP连接，端口号为25。</p><p>（3）接收方的用户代理作为POP3客户，从接收方邮件服务器中的POP3服务器进行TCP连接，端口号为110。</p><h4 id=3-smtp的基本工作过程>3. SMTP的基本工作过程</h4><p>SMTP使用C/S方式通信，负责发送邮件的SMTP进程为SMTP客户，负责接收邮件的SMTP进程为SMTP服务器。</p><p>SMTP客户给SMTP服务器发送14条命令，SMTP服务器收到命令后给SMTP客户发送21种应答。</p><p>（1）TCP连接建立后，服务器推送”服务就绪“给用户。</p><p>（2）客户使用”HELO“命令向服务器说明身份，告知自己的域名。</p><p>（3）服务器认为身份有效，发送应答代码250，否则发送其它错误代码（如421服务不可用）</p><p>（4）客户收到应答后，使用”MAIL FROM”命令告知邮件来自何处。</p><p>（5）服务器若认为合法则发送250。</p><p>（6）客户收到应答后，使用命令“RCPT To“来告诉服务器去往何处。</p><p>（7）服务器若由该收件人邮箱，则发送250。</p><p>（8）客户收到应答后，发送”DATA”命令告知服务器准备进行内容的发送。</p><p>（9）服务器若准备接收则发送代码354。</p><p>（10）客户收到应答后，开始发送数据。</p><p>（11）客户完成数据发送后，还要发送结束符&rsquo;.&rsquo;。</p><p>（12）服务器若收件成功，则发送250。</p><p>（13）客户收到应答后，使用命令“QUIT”请求断开连接。</p><p>（14）服务器发回响应代码221表示接受请求并主动断开TCP连接。</p><h4 id=4电子邮件的信息格式>4.电子邮件的信息格式</h4><p>首部包含From、To、Cc、subject，其中From和To是必填的。</p><h5 id=from>From</h5><p>填入发件人的电子邮件地址，一般由邮件系统自动填入。</p><h5 id=to>To</h5><p>填入一个或者多个收件人的电子邮件地址。</p><h5 id=cc>Cc</h5><p>抄送人的地址。</p><h5 id=subject>Subject</h5><p>邮件的主题，反应的是邮件的内容。</p><h4 id=5多用途因特网邮件拓展>5.多用途因特网邮件拓展</h4><p>SMTP只能传输ASCII码文本数据，通过多用途因特网邮件拓展（Multipurpose Internet Mail Extensions，MIME）将非ASCII码的数据转换为ASCII码数据。随后采用SMTP协议进行传输。</p><h4 id=6常用的邮件读取协议>6.常用的邮件读取协议</h4><h5 id=邮局协议>邮局协议</h5><p>邮局协议（Post Office Protocol，POP），POP3是其第三个版本。</p><p>POP3是个非常简单、功能有限的邮件读取协议。用户只能以下载并删除的方式或者下载并保留的方式对邮件服务器上的邮件进行简单管理，不能进行如创建文件夹、分类等操作。</p><p>TCP连接，熟知端口号为110。</p><h5 id=因特网邮件访问协议>因特网邮件访问协议</h5><p>因特网邮件访问协议（Internet Message Access Protocol，IMAP）是功能比POP3强大的邮件读取协议。用户在自己的计算机上可以操作邮件服务器的邮件，就像在本地操作一样。IMAP是一个联机协议。</p><p>TCP连接，熟知端口号为143。</p><h3 id=26-超文本传输协议>2.6 超文本传输协议</h3><h4 id=1万维网>1.万维网</h4><p>万维网是一个大规模的、联机式的信息存储所，是运行在因特网上的一个分布式应用。万维网通过网页之间的超链接，将不同网站的网页连接成一张逻辑上的信息网。</p><h4 id=2统一资源定位符>2.统一资源定位符</h4><p>万维网使用统一资源定位符（Uniform Resource Locator，URL）来指明因特网上的各种类型的“资源“的位置。</p><p>由协议、主机、端口、路径组成。&lt;协议>://&lt;主机>:&lt;端口>/&lt;路径></p><h4 id=3http简介>3.HTTP简介</h4><p>超文本传输协议（HyperText Transfer Protocol，HTTP）定义了以下功能的实现方法：1.浏览器（即万维网客户进程）向万维网服务器请求万维网文档；2.万维网服务器把万维网文档传输给浏览器。</p><p>基于TCP连接的，周知端口号为80.</p><h5 id=非持续连接方式>非持续连接方式</h5><p>HTTP/1.0采用非持续连接方式。在该方式下，每次浏览器进程请求一个文档都要与服务器建立TCP连接，收到响应后则关闭连接。</p><p>请求一个文档由接近2RTT的开销。</p><h5 id=持续连接方式>持续连接方式</h5><p>HTTP/1.1支持持续连接方式，万维网服务器在发送响应后仍然保持TCP连接，使同一个万维网客户和自己可以继续在这条TCP连接上传输后续的HTTP请求报文和响应报文。节省了很多RTT。</p><h4 id=4报文格式>4.报文格式</h4><h5 id=http请求报文格式>HTTP请求报文格式</h5><p>第一行是请求行。”方法“字段开始，后跟一个空格，后跟URL，后再跟一个空格，后跟”版本“字段，最后回车换行（CRLF）。</p><p>第二行开始是首部行。每一个首部行由”首部字段名“开始，后跟一个冒号，再跟一个空格，然后是该字段的取值。最后回车换行。</p><p>可以有很多首部行。</p><p>最后的首部行下面是一个空行。</p><h5 id=http响应报文格式>HTTP响应报文格式</h5><p>第一行是状态行。由”版本“字段开始，后跟空格，后跟”状态码“字段，后跟空格，最后跟”短语“字段，最后CRLF。</p><p>除状态行，其余部分和HTTP请求报文格式类似。</p><h6 id=状态码>状态码</h6><p>常见的状态码包括</p><p>200 OK：请求成功，信息返回在响应报文当中。</p><p>301 Moved Permanently：请求的对象被永久转移了，新的URL在响应报文当中的”Location“首部行中。</p><p>400 Bad Request：一个通用差错代码，表示该请求不能被服务器理解。</p><p>404 Not Found：被请求的文档不在服务器上。</p><p>505 HTTP Version Not Supported：服务器不支持请求报文使用的HTTP版本。</p><h4 id=5cookie>5.Cookie</h4><p>Cookie提供了一种机制，使得万维网服务器能够”记住“用户，而无须用户主动提供标识信息。</p><p>过程如下：</p><p>（1）浏览器初次向Web服务器发送HTTP请求报文，Web服务器回为其产生一个唯一的Cookie识别码，并以此为索引在Web服务器的后端数据库中创建一个项目，用来记录该用户访问该网站的各种信息。</p><p>（2）Web服务器给浏览器发回HTTP响应报文，包含一个首部字段”Set-Cookie“，该字段的取值就是Cookie识别码。浏览器收到响应报文后，就在特定的Cookie文件夹中添加一行，记录域名和识别码。</p><p>（3）再次访问时，每发出一个HTTP请求报文，浏览器都会从Cookie文件中取出该网站的Cookie识别码，放到HTTP请求报文的Cookie首部行中。</p><h4 id=6web缓存和代理服务器>6.Web缓存和代理服务器</h4><p>原始服务器会给每个响应对象设置一个”修改时间“字段（Last-Modified）和一个有效日期字段（Expires）。当主机需要请求原始服务器中的某个文档时，首先向代理服务器（Proxy server）发送请求，若代理服务器中该文档未过期，则直接将响应报文发送回给主机，否则该代理服务器就向原始服务器发送请求报文，其中包含首部行”If-modified-since“，取值即为该文档的修改日期。</p><p>原始服务器比较该字段值和该文档的修改时间，若一致则回送304 Not Modified。代理服务器更新有效时间，并向主机发回响应。</p><p>若不一致则原始服务器给代理服务器发送带有该文档的响应报文，则代理服务器也更新了该文档的内容和有效期，随后再将该文档响应发送会给主机。</p><h2 id=chapter3-运输层>Chapter3. 运输层</h2><h3 id=31-概述>3.1 概述</h3><p>运输层（Transport layer）协议为运行在不同主机上的应用进程提供了逻辑通信（logic communication）。</p><p>传输层协议是在端系统中而不是在路由器中实现的。</p><p>将主机间交付拓展到进程间交付被称为运输层的多路复用（multiplexing）和多路分解（demultiplexing）。</p><h3 id=32-多路复用和多路分解>3.2 多路复用和多路分解</h3><p>将传输层报文段中的数据交付到正确的套接字的工作被称为多路分解。</p><p>在源主机中将不同套接字中收集数据块，并为每个数据块封装上首部信息从而生成报文段，将报文段传输到网络层的工作为多路复用。</p><h4 id=1端口号>1.端口号</h4><p>TCP/IP体系的运输层使用端口号来区别应用层的不同应用进程。</p><p>端口号用16比特表示，取值为0~65535；</p><h5 id=熟知端口号>熟知端口号</h5><p>well-known port number, 0~1023，IANA（因特网号码分配管理局）将这些端口号指派给了TCP/IP协议中的一些重要的应用协议。</p><p>例如FTP使用21/20；HTTP使用80；DNS使用53；SMTP使用25；DHCP使用67/68；BGP使用179；HTTPS使用443；RIP使用520</p><h5 id=登记端口号>登记端口号</h5><p>1024~49151，为没有熟知端口号的应用程序使用，但需要进行手续登记以防重复。</p><h5 id=短暂端口号>短暂端口号</h5><p>49152~65535，留给客户进程选择暂时使用。当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号。</p><h4 id=2tcp的多路分解和复用>2.TCP的多路分解和复用</h4><p>TCP套接字是由一个四元组进行标识的：（源IP、源端口、目的IP、目的端口）【需要向源进行反馈】</p><p>发送方复用：IP数据报首部中协议字段为6，表示封装的是TCP报文段</p><p>接收方分解：网络层根据首部协议字段向上交付给UDP</p><h4 id=3udp的多路分解和复用>3.UDP的多路分解和复用</h4><p>UDP套接字是由一个二元组进行标识的：（目的IP、目的端口）</p><p>IP数据报首部中协议字段为17，表示封装的是UDP用户数据报</p><p>接收方分解：网络层根据首部协议字段向上交付给TCP</p><h4 id=4特例>4.特例</h4><p>OSPF报文并不使用运输层的UDP或者TCP进行封装，而是直接使用网络层的IP进行封装，封装时的协议字段值为89。</p><h3 id=33-udp和tcp的对比>3.3 UDP和TCP的对比</h3><p>UDP是无连接的；TCP是面向连接的</p><p>UDP支持广播、多播和广播；TCP仅支持单播</p><p>UDP是面向应用报文的，对应用进程交付下来的报文既不合并也不拆分，而是保留这些报文的边界。</p><p>TCP是面向字节流的，将应用进程交付下来的应用报文仅仅看作一连串的、无结构的字节流。TCP不保证接收方应用进程所接收到的数据块和发送方应用进程所发出的应用层报文之间具有对应大小的关系。</p><p>UDP用户数据报首部仅有8各字节；TCP报文段首部大小20~60字节不等。</p><h3 id=34-用户数据报协议udp>3.4 用户数据报协议UDP</h3><h4 id=1udp报文段结构>1.UDP报文段结构</h4><p>首部+应用数据报文</p><p>首部中包含：源端口号、目的端口号、长度、检验和</p><h4 id=2udp检验和>2.UDP检验和</h4><p>UDP校验和提供了差错检测功能，但是对差错恢复无能为力。</p><p>发送方的UDP对报文段中的所有16比特字的和进行反码运算，注意在求和时遇到的所有溢出都要进行回卷操作。</p><p>接收方将所有16比特字进行相加，包括检验和，如果没有差错结果必然为16个1。</p><h3 id=35-传输控制协议tcp>3.5 传输控制协议TCP</h3><h4 id=1tcp报文段首部格式>1.TCP报文段首部格式</h4><p>TCP发送数据时，从发送缓存中取出一部分或者全部字节并给其添加一个<strong>首部</strong>使其成为TCP报文段后再进行发送。</p><p>由20字节的固定首部和最大40字节的扩展首部组成。</p><p>源端口（Source Port）和目的端口（Destination Port）占16比特，标识发送该TCP报文段的应用进程。</p><p>序号（Sequence number）占32比特，当序号取到最后一个时，下一个序号回到0。指出本TCP报文段数据载荷的第一个字节的序号。</p><p>确认号（Acknowledgement number）占32比特，和序号类似，指出期望收到对方下一个TCP报文段的数据载荷的第一个字节的序号，同时也是对之前收到的所有数据的确认（comulative acknowledgment，累计确认）。</p><p>确认标志位ACK：取值为1时确认号字段才有效；取值为0时确认号字段无效。TCP规定在连接建立后传送的所有TCP报文段ACK需置1。</p><p>首部长度（Header Length）占4比特，并以4字节为单位，用来指出TCP报文段数据载荷部分的起始处距离TCP报文段起始位置的距离。首部固定长度为20字节，因此该字段最小为0101（5*4=20），最大为60，即该字段最大为1111（15*4=20）</p><p>保留字段：占6比特，目前应置为0</p><p>窗口（Window size value）占16比特，以字节为单位，指出发出本报文段的一方的接收窗口。</p><p>检验和（checksum）占16bit</p><p>紧急指针（urgent pointer）16bit，以字节为单位，指明紧急数据的长度。发送方有紧急数据时，可以将其插队到缓存最前面，并立刻封装进行发送。紧急指针会指出本报文段数据载荷包含了多长的紧急数据，紧急数据后面是普通数据。接收方也不必缓存直接上交。</p><p>同步标志位SYN：在TCP建立连接时用来同步序号。</p><p>终止标识位FIN：用来释放TCP连接。</p><p>复位标志位RST：用来复位TCP连接，当RST=1时，表明TCP连接出现了异常，必须释放连接后重连。还可以用来拒绝一个非法的报文段或者拒绝打开一个TCP连接。</p><p>推送标志位PSH：接收方的TCP接收到PSH为1的报文段回尽快上交应用进程，不必等到接收缓存都填满后再上交。</p><p>紧急标志位URG：和紧急指针字段配合使用。为1时紧急指针字段有效。</p><p><strong>选项字段</strong>包含：</p><p>最大报文段长度（Maximum Segment Size，MSS）用来指出TCP报文段数据载荷部分的最大长度。</p><p>窗口扩大选项：用来扩大窗口，提高吞吐率。</p><p>时间戳选项：用于计算RTT，处理序号超范围清空，防止序号绕回（Protect Against Wrapped Sequence Numbers，PAWS）</p><h4 id=2三次握手建立tcp连接>2.“三次握手”建立TCP连接</h4><p>TCP客户：</p><p>CLOSED状态&mdash;(发送SYN包,SYN=1,seq=x)&mdash;SYN-SENT状态&mdash;(接收SYN,ACK包,发送ACK=1,seq=y,ack=x+1)&mdash;ESTABLISHED</p><p>TCP服务器：</p><p>CLOSED状态&mdash;LISTEN监听&mdash;(接收SYN包,发送SYN=1,ACK=1,seq=y,ack=x+1)&mdash;-SYN-RCVD状态&mdash;(接收ACK=1,seq=x+1,ack=y+1)&mdash;ESTABLISHED</p><p><img alt=image-1 src=/images/network/image-1.png></p><p>Tips：</p><p>TCP请求报文段没有数据载荷（SYN=1的报文段不能携带数据，但是要消耗掉一个序号）；</p><p>对于最后一个ACK，TCP规定普通的TCP确认报文段可以携带数据，但如果不携带数据，则不会消耗序号，即如果该ACK不携带数据，客户端发送的下一个报文段的序号仍为x+1。</p><h4 id=3四次挥手释放tcp连接>3.”四次挥手“释放TCP连接</h4><p><img alt=image-2 src=/images/network/image-2.png></p><p>Tips：</p><p>TCP规定FIN等于1的TCP报文段即使不携带数据，但也要消耗掉一个序号。</p><p>MSL（Maximum Segment Lifetime）意思是最长报文段寿命，RFC建议为2分钟。进入时间等待是为了避免数据报丢失而导致服务器方不断地进行超时重传。也可以使得本次TCP连接所产生的报文段从网络中消失，从而使得新的TCP连接中不会出现旧连接的报文段。</p><h5 id=保活计时器>保活计时器</h5><p>当TCP服务器每次收到TCP客户进程的数据时，就重新设置并启动保活计时器（Keepalive Timer）。若保活计时器定时周期内未收到TCP客户进程发来的数据，到期后TCP服务器进程就向TCP客户进程发送一个探测报文段，反复发送10次若仍无响应则判断TCP客户进程所在主机出现故障，接着就关闭当前的TCP连接。</p><h4 id=4可靠数据传输协议rdt>4.可靠数据传输协议rdt</h4><h5 id=rdt10>rdt1.0</h5><p>经完全可信的信道传播</p><h5 id=rdt20>rdt2.0</h5><p>经有比特差错信道的可靠数据传输；</p><p>假定分组按序被接收</p><p>基于重传机制的rdt：自动重传请求（Automatic Repeat reQuest，ARQ）</p><p>ARQ中处理比特差错的功能：差错检测、接收方反馈、重传</p><p>它是一种<strong>停等协议</strong>（stop-and-wait）</p><p>概括以下就是：基于差错检测和反馈机制，根据反馈来判断是否进行重传</p><p>但是反馈的ACK和NAK也可能出错，sol：进行重传，并通过seq判断是重传的NAK（ACK）还是新发出的。</p><h5 id=rdt21>rdt2.1</h5><p>对seq进行模2操作，若接收新分组则模2结果发生变化</p><h5 id=rtd22>rtd2.2</h5><p>在ACK、NAK中将参数0、1带入，以减少一定的状态</p><h5 id=rdt30>rdt3.0</h5><p>经有比特差错和丢包可能的信道的可靠数据传输</p><p>发送方负责检测和恢复丢包工作</p><p>这里引入了倒计时定时器（countdown timer）[重传计时器]</p><p>但rdt3.0仍为停等协议，于是引出了流水线（pipelining）工作</p><p>对于流水线中的差错、超时、丢失，处理的两种基本方式是<strong>回退N步</strong>（Go-Back-N，GBN）和<strong>选择重传</strong>（Selective Repeat，SR）</p><h5 id=回退n步gbn>回退N步GBN</h5><p>GBN协议也常被成为滑动窗口协议（sliding-window protocol），N通常被成为窗口长度（window size）</p><p>GBN的发送方必须做到以下若干事件的响应：</p><h6 id=上层调用>上层调用</h6><p>发送方首先检查发送窗口是否已满，若未满则产生一个分组并将其发送，反之将数据返回给上层</p><h6 id=收到ack>收到ACK</h6><p>由于采用累计确认（cumulative acknowledgment），若收到序号为n的分组的确认，即ack=n+1，那么表明接收方已经正确的接收到了序号为n及其以前的所有分组。</p><h6 id=超时事件>超时事件</h6><p>如果出现超时，那么发送方将重传所有已经发送但还未被确认过的分组。</p><p>一个窗口中有一个计时器，它一般为最早已经发送但未被确认的分组的计时器。</p><p>如果收到ACK后，仍有已经发送但未被确认的分组，则计时器被重启，反之停止该计时器。</p><h5 id=选择重传sr>选择重传SR</h5><p>对于GBN，单个分组的差错可能引起GBN重传大量分组，而许多分组根本没有必要重传。</p><p>对于选择重传SR，通过让发送方仅重传那些它怀疑在接收方出错的分组而避免了不必要的重传。</p><h6 id=对于发送方>对于发送方</h6><p>SR接收方将确认一个正确接收的分组而不管其是否按序。失序的分组将被缓存直到所有丢失分组被收到为止。</p><p>[如果收到了一个ACK，倘若该ACK处于窗口之中，那么则标记该分组已被确认，如果该分组正好为send_base，即第一个已发送但未被确认，那么则进行窗口移动，基需要send_base移动到具有最小序号的未确认分组处。窗口移动后，如果有序号落在未发送分组中，则发送]</p><h6 id=对于接收方>对于接收方</h6><p>如果接收窗口内的分组被收到，那么则送回一个ACK。如果以前没有收到该分组，那么进行缓存。如果该分组的序号等于接收窗口的基序号rev_base，则该分组及其以前的缓存号连续，分组交付给上层。</p><p>如果序号是以前接受过的，那么则发送一个冗余ACK即可。</p><h5 id=tcp的选择确认>TCP的选择确认</h5><p>TCP的选择确认（selective acknowledgement，SACK）允许TCP接收方有选择地确认失序报文段，而不是累计确认最后一个正确接收的有序报文段。</p><h4 id=5tcp的流量控制>5.TCP的流量控制</h4><p>TCP未其应用提供了流量控制服务（flow-control service）以消除发送方使接收方缓存溢出的可能性。</p><p>注意：TCP发送方也可能因为IP网络的拥塞而被遏制，这种形式的发送方的控制被称为拥塞控制（congestion control）。</p><p>TCP让发送方维护一个成为<strong>接收窗口</strong>的变量rwnd。接收窗口给发送方一个指示，该接收方还有多少可用的缓存空间。</p><p>TCP发送方的发送窗口=min[自身拥塞窗口，TCP接收方的接收窗口]</p><p>当发送方接收到来自接收方的确认报文，则将发送窗口移动至ack处，随后根据确认报文中的接收窗口大小动态地调整发送窗口。</p><p>TCP发送方当接收到接收方的<strong>零窗口通知</strong>后，应启动<strong>持续计时器</strong>。持续计时器超时后，向接收方发送<strong>零窗口探测报文</strong>，以避免死锁。</p><h4 id=6tcp的拥塞控制>6.TCP的拥塞控制</h4><p>某段时间内，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就会变差，这种情况叫做<strong>拥塞</strong>（congestion）。</p><p>发送方要维护一个叫做拥塞窗口（Congestion Window）的状态变量cwnd，其值取决于网络的拥塞程度和所采用的TCP拥塞控制算法。</p><p>判断网络<strong>拥塞的依据</strong>是：没有按时收到应到达的确认报文段而产生了超时重传。</p><p>发送方维护的发送窗口（Sender Window）的状态变量swnd。swnd=min(cwnd,rwnd)。</p><p>发送方还要维护一个<strong>慢开始门限</strong>（SSThresh）的状态变量ssthresh：</p><p>cwnd&lt;ssthresh，使用慢开始算法；cwnd>ssthresh，停止使用慢开始算法而改用拥塞避免算法；等于则都可以使用。</p><h5 id=慢开始>慢开始</h5><p>slow-start</p><p>cwnd初始值为1个MSS（最大报文段长度）；ssthresh也有初始值，假设为16.</p><p>每当传输的报文段首次被确认就增加一个MSS，即每个确认报文段就将cwnd增加一个MSS。</p><p>相当于在一个传播轮次中cwnd翻倍。</p><p>当即将超过ssthresh时，继续翻倍显然不合理，当cwnd等于ssthresh时，进入拥塞避免。</p><h5 id=拥塞避免>拥塞避免</h5><p>congestion avoidance</p><p>每个RTT只将cwnd的值增加一个MSS。相当于对于每一个新到达的确认，cwnd增加一个MSS*（MSS/cwnd）字节。</p><p>例如MSS是1460字节并且cwnd是14600字节。则在一个RTT内发送10个报文段。每到达一个ACK就增加1/10MSS的cwnd，因此在收到对所有10个报文段的确认后，cwnd就增加了一个MSS。</p><p>是一种线性增长。</p><p>当重传计时器<strong>超时</strong>，则判断网络很有可能出现了拥塞，进行：</p><p>1.将ssthresh更新为发生拥塞时的<strong>cwnd的一半</strong>；2.<strong>将cwnd减少为1</strong>，重新开始执行慢开始算法。</p><h5 id=快速重传>快速重传</h5><p>fast retransmit</p><p>对于拥塞，对于发送方来说可以有两种指示方式：1.重传计时器超时，2.收到三个冗余的ACK</p><p>所谓快速重传就是发送方要尽快进行重传，而<strong>不是等待重传计时器超时后再进行重传</strong>。即收到<strong>三个冗余的ACK</strong>。这就要求了接收方要立即发送确认信息，即使受到了失序的报文段也要立即发出对已收到的报文段的重复确认（发出冗余ACK）。</p><p><img alt=image-3 src=/images/network/image-3.png></p><h5 id=快速恢复>快速恢复</h5><p>fast recovery</p><p>发送方一旦收到三个冗余ACK，就知道仅仅丢失了个别报文段。于是不启动慢开始算法，而执行快速恢复算法。</p><p>发送方将慢开始门限ssthresh和cwnd值调整为当前窗口的一半，开始执行拥塞避免算法。</p><p>也有的快速恢复是把快速恢复开始时的cwnd再增大一点，即等于新的ssthresh+3。（TCP Reno）[既然发送方收到三个冗余ACK，则代表有三个数据报文段已经离开了网络，在接收方的接收缓存中，网络中减少了三个报文段，因此可以将cwnd适当扩大一些]</p><p><img alt=image-4 src=/images/network/image-4.png></p><h4 id=7tcp可靠传输的实现>7.TCP可靠传输的实现</h4><p>滑动窗口机制（sliding window）</p><p>对于不按序到达的数据，TCP无明确规定，通常对不按序到达的数据先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，然后再按需交付上层的应用进程</p><p>TCP要求接收方必须有累积确认和捎带确认机制，这样可以减少传输开销。接收方不应过分推迟发送确认，否则会导致不必要的重传，TCP标准规定，确认推迟的时间不应超过0.5s。</p><h4 id=8tcp超时重传时间的选择>8.TCP超时重传时间的选择</h4><h5 id=指数加权移动平均>指数加权移动平均</h5><p>Exponential Weighted Moving Average，<strong>EWMA</strong></p><p>初始状态下：EstimatedRTT=SampleRTT；</p><p>当获取新的样本时：EstimatedRTT=(1-α)·EstimatedRTT+α·SampleRTT （RFC推荐α=0.125）</p><h5 id=偏差加权移动平均>偏差加权移动平均</h5><p>测量得到的样本RTT值：SampleRTT；RTT偏差：DevRTT；</p><p>初始状态下：DevRTT=SampleRTT/2；</p><p>在获取新的样本时：DevRTT=(1-β)·DevRTT+β·|SampleRTT-EstimatedRTT|（RFC推荐β=0.25）</p><h5 id=超时重传时间rto>超时重传时间RTO</h5><p>TimeoutInterval=EstimatedRTT+4·DevRTT</p><p>初始的TimeoutInterval的值为1秒。同时，当出现超时情况时，其值加倍；反之收到报文则通过上式进行计算。</p><h5 id=相关问题>相关问题</h5><p>当出现重传时，发送方极有可能无法判断收到的确认报文是对原发送报文的确认还是重传报文的确认，会导致对RTT的估计出错，因此Karn提出一个算法：在计算加权平均往返时间时，只要报文段重传了，就不采用其样本RTT。即重传时EstimatedRTT不被重新计算。</p><p>而如果报文段的时延突然上升且保持。在原来计算出的重传时间RTO中不会受到确认报文段，于是重传。根据Karn，重传不被重新计算，这样RTO无法被更新，导致重传不断进行。</p><p>对Karn算法进行修正，即重传一次，RTO则增大一些，一般是变成两倍。</p><h2 id=chapter4-网络层>Chapter4. 网络层</h2><h3 id=41-概述>4.1 概述</h3><h4 id=1-数据平面和控制平面>1. 数据平面和控制平面</h4><h5 id=数据平面>数据平面</h5><p>数据平面功能，即网络层中每台路由器的功能，该数据平面功能决定到达路由器输入链路之一的数据报（即网络层分组）如何转发到该路由器的输出链路之一。</p><h5 id=控制平面>控制平面</h5><p>控制平面功能，即网络范围的逻辑，该控制平面功能控制数据报沿着从源主机到目的主机的端到端路径中路由器之间的路由方式。</p><h4 id=2-分组转发和路由选择>2. 分组转发和路由选择</h4><h5 id=分组转发>分组转发</h5><p>forwarding</p><p>当一个分组到达某路由器的一条输入链路时，该路由器必须将该分组移动到适当的输出链路。</p><p>转发是在数据平面中实现的唯一功能。将一个分组从输入链路接口转移到适当的输出链路接口的路由器本地操作。</p><p>通常在几纳秒中完成，因此通常使用硬件来实现。</p><h5 id=路由选择>路由选择</h5><p>routing</p><p>网络层必须决定这些分组所采用的路由或者路径。计算这些路径的算法被称为路由选择算法（routing algorithm）。</p><p>是指确定分组从源到目的地所采取的端到端路径的网络范围处理过程。</p><h4 id=3-网络层向上层提供的服务>3. 网络层向上层提供的服务</h4><h5 id=面向连接的虚电路服务>面向连接的虚电路服务</h5><p>核心思想是“可靠通信应由网络自身来保障”</p><p>必须首先建立网络层连接—虚电路（Virtual Circuit，VC），以保证通信双方所需要的网络资源。</p><p>通信双方沿着已建立的虚电路发送分组。</p><p>这是一条逻辑上的连接，分组沿着这条逻辑链接按照存储转发的方式进行传送。</p><p>但不被使用。</p><h5 id=无连接的数据报服务>无连接的数据报服务</h5><p>核心思想是：可靠的通信应由用户主机来保障。</p><p>不需要建立网络层连接。每个分组可以走不同的路径。</p><p>通信结束后双方没有需要释放的连接。</p><p>分组可能误码、重复、失序。是一个尽最大努力（best effort）的分组交付功能。</p><h3 id=42-网际协议ip>4.2 网际协议IP</h3><p>网际协议（Internet Protocol，IP）是TCP/IP体系结构中网际层中的核心协议。</p><p>配合使用的四个协议：</p><p>地址解析协议（Address Resolution Protocol，ARP）</p><p>逆地址解析协议（Reverse Address Resolution Protocol，RARP）</p><p>网际控制报文协议（Internet Control Message Protocol，ICMP）</p><p>网际组管理协议（Internet Group Management Protocol，IGMP）</p><h4 id=1-异构网络互连>1. 异构网络互连</h4><p>网络根据其用户需求的不同拥有不同的拓扑、性能、协议，对于这些众多的异构网络，通过路由器进行互连。这些异构网络的网络层都使用相同的网际协议IP，从网络层看他们都好像一个统一的网络，即IP网。</p><h4 id=2ipv4地址概述>2.IPv4地址概述</h4><p><strong>32比特</strong>的唯一标识符，由因特网名字和数字分配机构（Internet Corporation for Assigned Names and Numbers，ICANN）进行分配。</p><h5 id=ipv4的表示方法>IPv4的表示方法</h5><p>采用点分十进制表示方法</p><h5 id=分类编址>分类编址</h5><p>包含网络号和主机号两个部分</p><p>网络号：用来标志主机（或路由器）的接口所连接到的网络。</p><p>主机号：用来标志主机（或路由器）的接口。</p><p>分类编址将IPv4地址分成以下五类：</p><p>A类地址：网络号8b，主机号24b，网络号最前面一位固定为0.</p><p>B类地址：网络号16b，主机号16n，网络号最前面两位固定10.</p><p>C类地址：网络号24b，主机号8b，网络号最前面三位固定110.</p><p>D类地址：多播地址，最前面四位固定1110.</p><p>E类地址：保留地址，最前面四位固定1111.</p><p>只有A、B、C类主机可以分配给网络中的主机（或路由器）的各接口。</p><p>主机号全0的地址是网络地址，不能分配给接口，主机号全1的是广播地址，不能分配。</p><h6 id=a类地址>A类地址</h6><p>网络号8b，第一位固定0</p><p>最小网络号0，保留</p><p>最大网络号127，用作本地环回测试地址，不指派</p><p>最小的本地环回测试地址为127.0.0.1，最大的本地环回测试地址为127.255.255.254</p><p>第一个可指派的网络号为1，网络地址为1.0.0.0</p><p>最后一个可以指派的网络号为126</p><p>可以指派的网络数量为126</p><p>每个网络可以分配的IP地址的数量为2^24-2 [24位主机号，减去全0和全1]</p><h6 id=b类地址>B类地址</h6><p>网络号16b，前两位固定10</p><p>最小可指派的网络号为128.0[2字节的网络号]</p><p>最大可指派的网络号为191.255</p><p>可指派的网络数量为2^(16-2)=16384</p><p>每个网络可以分配的IP地址的数量为2^16-2=65534</p><h6 id=c类地址>C类地址</h6><p>网络号24b，前三位固定110</p><p>最小可指派的网络号为192.0.0</p><p>最大可指派的网络号为223.255.255</p><p>可指派的网络数量为2^(24-3)=2097152</p><p>每个网络可以分配的IP地址的数量为2^8-2=254</p><p>通过左起第一个十进制数可以判断网络类别：</p><p>小于127的是A类，128~191的是B类，192~223的是C类</p><p>地址0.0.0.0是一个特殊的IPv4地址，只能作为源地址使用，表示“在本网络上的本主机”，比如DHCP DISCOVERY。</p><p>地址255.255.255.255只能作为目的地址使用，表示“只在本网络上进行广播（各路由器均不转发）”。</p><p><img alt=image-5 src=/images/network/image-5.png></p><p>对于网络的分配，需要考虑到其连接的路由器端口也需要IP地址，广播地址和网络地址各需要一个IP地址。</p><h5 id=划分子网>划分子网</h5><p>将原来分类编制后的网络号再进行一定的拓展，选取原本的若干主机号将其定位子网号，从而实现进一步的划分</p><p>子网掩码：将网络号和子网号的对应位置置为1，主机号置为0，这样将IP地址和子网掩码进行与操作可以获取网络号和子网号。</p><p>对于默认子网掩码，A类为255.0.0.0，B类为255.255.0.0，C类为255.255.255.0。</p><h5 id=无分类编址>无分类编址</h5><p>无分类域间路由选择（Classless Inter-Domain Routing，CIDR）消除了传统的A、B、C类地址以及划分子网的概念。</p><p>改为两级结构：网络号和主机号</p><p>原网络号在CIDR被称为网络前缀（Network-Prefix），是不定长的。</p><p>与子网掩码类似，CIDR采用了32位的地址掩码（Address Mask），它消除了划分子网的概念，但经常也被成为子网掩码。</p><p>采用斜线记法（Slash Notation）[亦称为CIDR记法]，在地址后面加上斜线"\"，表明其网络前缀的长度。</p><p>CIDR将网络前缀相同的IPv4地址组成一个“CIDR地址块”。</p><h5 id=路由聚合>路由聚合</h5><p>由于一个CIDR地址块可以包含多个地址，在路由表中可以利用CIDR地址块来查找目的网络。这种地址的聚合被称为路由聚合（route aggregation）。路由聚合也被称为构造超网（supernetting）。方法就是<strong>找最长的共同前缀</strong>。</p><p>网络前缀越长，地址块越小，路由就越具体，因此当有多条转发条目匹配时，应当选择最长前缀的[最具体的]，被称为最长前缀匹配。</p><h5 id=ipv4地址的应用规划>IPv4地址的应用规划</h5><p>将给定的IPv4地址块划分成几个更小的地址块（或子网）。分为使用定长的子网掩码（Fixed Length Subnet Mask，FLSM）和使用变长的子网掩码（Variable Length Subnet Mask，VLSM）。</p><p>对于变长的子网掩码，其通过已申请到的CIDR地址块中按需划分出更小的地址块，每个块的起始位置不能随意选取。最好连续。</p><h4 id=3地址解析协议>3.地址解析协议</h4><h5 id=ipv4地址和mac地址>IPv4地址和MAC地址</h5><p>MAC地址（Media Access Control Address，MAC，媒体存取控制位址）封装在帧首部（数据链路层的协议数据单元PDU）。IP地址在IP数据报的首部。</p><p>分组传递过程中，源IP和目的IP始终不变，而源MAC和目的MAC会逐链路不断变化。</p><p>路由器在收到IP数据报后，根据其首部中的目的IP地址的网络号部分，基于自己的路由表进行查表转发。查表转发的结果可以指明IP数据报的下一跳路由器的IP地址，但无法指明该IP地址所对应的MAC地址，因此引入了地址解析协议（Address Resolution Protocol，ARP）。</p><h5 id=arp>ARP</h5><p>每台主机都会维护一个ARP高速缓存表，记录IP地址和MAC地址的对应关系。</p><p>当ARP高速缓存表中找不到想要的MAC地址，那么主机就要发送ARP请求报文来获取对应的MAC地址。</p><p>ARP<strong>请求报文</strong>中包含源IP、源MAC、希望得到MAC的IP地址。被封装在MAC帧中进行发送，MAC帧的目的地址位广播地址（FF-FF-FF-FF-FF-FF）。</p><p>其它主机收到广播帧后，将其封装的ARP请求报文上交处理。上层的ARP进程进行解析，判断是否发出响应。ARP<strong>响应报文</strong>告知目标IP对应的MAC地址，将ARP响应报文封装在MAC帧中发送，目的地MAC为发出ARP请求的源MAC，即进行单播。</p><p>其它主机收到单播帧后，判断MAC地址，若不匹配则丢弃，匹配则上交ARP响应报文，上层进程解析，将其中的对应记录添加到ARP高速缓存表中。</p><p>高速缓存表中有动态和静态两种类型：动态类型是指主机通过ARP协议自动获取的，生命周期一般为2分钟。</p><p>Tips：ARP协议解决同一个局域网上的IP和MAC的映射问题，而不能跨网络使用。</p><p>除了ARP请求报文和响应报文，还有用于检查IP地址冲突的“无故ARP（或者免费ARP）（Gratuitous ARP）”</p><h4 id=4ip数据报>4.IP数据报</h4><h5 id=转发过程>转发过程</h5><h6 id=主机发送>主机发送</h6><p>源主机通过自己的IP和掩码相与得到自己所在的网络号，同时拿目的IP和自己的掩码进行相遇，得到的网络号如果不相等，那么判断不在同一个网络中。[考虑：如果在同一个网络中，那么使用同一个子网掩码与出来的结果必定相同]</p><p>在同一个网络中的网络设备之间可以直接访问。</p><p>每一个网络中存在一个<strong>默认网关</strong>，在间接交付时，源主机通过ARP获取默认网关的MAC。由默认网关代替源主机进行转发。</p><h6 id=路由器转发>路由器转发</h6><p>路由器根据IP数据报的目的IP进行查表，如果找得到条目则进行转发，反之向源主机发送ICMP差错报告。</p><p>通过给路由器接口配置IP和掩码，路由器能自行得出与该接口直连的网络号。</p><p>路由器不对广播IP数据报进行转发，否则容易导致巨大的广播风暴，浪费资源。（路由器可以隔离广播域和冲突域）</p><h5 id=首部格式>首部格式</h5><p><img alt=image-6 src=/images/network/image-6.png></p><p><strong>版本</strong>（Version）：占4b，表示IP协议的版本</p><p><strong>首部长度</strong>（Header Length）：占4b，以4字节为单位，最小取值为0101（5），表示IP数据报首部只有20字节的固定部分</p><p><strong>区分服务类型</strong>（Differentiated Services Field）：占8b，区分不同类型的IP数据报，提供不同等级的服务质量</p><p><strong>总长度</strong>（Total Length）：占16b，表示IP数据段的总长度（首部+数据载荷）最大取值为65535，以字节为单位</p><p>[每一种数据链路层协议规定了帧的数据载荷的最大长度MTU（Maximum Transmission Unit），因此有些IP数据报要进行分片操作，PPP和以太网协议一般取为1500字节。]</p><p><strong>标识</strong>（Identification）：占16b，属于同一个IP数据报的各分片应具有相同的标识，IP软件会维护一个计数器，每产生一个IPv4数据报，计数器的值就加一。</p><p><strong>标志</strong>（Flags）：占3b，最低位（More Fragment，MF），MF=1表示后面还有分片，反之表示本分片为最后一个分片；中间位（Don&rsquo;t Fragment，DF），表示是否允许分片，DF=1则不允许分片；最高位为保留位，设为0.</p><p><strong>片偏移</strong>（Fragment offset）：占13b，指出分片数据报的数据载荷部分偏移其在原数据报的位置有多少个单位。以8个字节为单位。</p><p><strong>生存时间</strong>（Time to live，TTL）：占8b，最初以秒为单位，最大生存周期为255秒。转发时，将该字段的值减去IP数据报在本路由器上耗费的时间，若不为0则转发，否则就丢弃。现在以跳数为单位，每次减一。[防止在路由环路中反复转发]</p><p><strong>协议</strong>（Protocol）：占8b，指明数据部分是何种协议数据单元：常用的有：ICMP1；IGMP2；TCP6；UDP17；IPv6（41）；OSPF89</p><p><strong>首部检验和</strong>（checksum）：占16bit，检测是否出现差错。每经过一个路由器，checksum重新计算。</p><p><strong>源IP地址</strong>（Source）：32bit，Destination也是如此。</p><h4 id=5ipv6地址>5.IPv6地址</h4><h5 id=ipv6基本首部>IPv6基本首部</h5><p>基本首部Base Header，40字节，是固定的，因此首部中取消了首部长度字段。</p><p><img alt=image-7 src=/images/network/image-7.png></p><p>拓展首部（Extension Header）不属于首部，和后面的数据部分组合起来构成有效载荷（payload），也成为净负荷。、</p><p>IPv6首部字段仅有8个。</p><p>取消了区分服务（服务类型）字段，其中通信量类和流标号字段实现了该功能。</p><p><img alt=image-8 src=/images/network/image-8.png></p><p><img alt=image-8-1 src=/images/network/image-8-1.png></p><p><strong>版本Version</strong>：4b，IPv6则为6</p><p><strong>通信量类Traffic Class</strong>：8b，区别数据报的类别</p><p><strong>流标签Flow Label</strong>：20b，属于同一个流的IPv6数据报具有同样的流标号。即流标号用于资源分配。对于传统的非实时数据，流标号没有什么作用，置为0即可。</p><p>[流就是因特网上从特定源点到特定终点的一系列IPv6数据报（如实时音视频数据的传输），流的路径上所有路由器保障指明的服务质量]</p><p><strong>有效载荷长度Payload length</strong>：16b，最大值为65535，有效载荷的字节数量（包括拓展首部和数据部分）</p><p><strong>下一个首部Next Header</strong>：8b，相当于IPv4中的协议字段。当IPv6没有拓展首部，则它指出了IPv6数据报封装的何种协议数据单元PDU。如果有扩展首部，那么其值标注后面第一个拓展首部的值。</p><p><strong>跳数限制Hop Limit</strong>：8b，即为TTL，最大255跳。</p><p><strong>源和目的（Source & Destination）</strong>：均为128b。</p><h5 id=扩展首部>扩展首部</h5><p>为了提高路由器处理数据报的速度，将原来IPv4的选项字段放到了拓展首部中。只有源和终点的主机处理，传输过程中的路由器均不处理这里的拓展首部。</p><p>拓展首部字段有六种类型：逐条选项；路由选择；分片；鉴别；封装安全有效载荷；目的站选项。每一个拓展首部都有若干个字段组成，他们的长度也各不相同。</p><p>每一个拓展首部的一个字段都是8b的”下一个首部“字段。</p><h5 id=表示方法>表示方法</h5><p>冒号十六进制记法：128个划分为8组，每组16个，16个可以变成4位十六进制。</p><p>不区别大小写。</p><p>在此基础上使用”左侧0省略“和”连续0压缩“。</p><p>左侧0省略：每一组之中最前面的0可以不写；</p><p>连续0压缩：两个冒号中间的一连串0可以省略，但只能进行一次压缩</p><p>还可以集合点分十进制的后缀。</p><p>CIDR斜线表示法也可以继续使用。</p><h5 id=地址分类>地址分类</h5><p>目的地址的三种基本类型：单播（unicast）、多播（multicast）、任播（anycast）</p><p>为指明地址：全0，只能用于还没一个配置到地址的主机作为源地址</p><p>环回地址：最低比特为1其余为0</p><p>多播地址：最高八位为1，即为FF00::/8</p><p>本地链路单播地址：最高十个比特为1111111010，即为FE80::/10</p><p>全球单播地址：剩余的即是，结构包含：48b的全球路由选择前缀(Global Routing Prefix)，相当于原来的网络号；16b的子网标识符(Subnet ID)，用于各共公司和机构构建子网；64b的接口标识符(Interface ID)，相当于主机号。</p><h5 id=从ipv4到ipv6的过渡>从IPv4到IPv6的过渡</h5><h6 id=双协议栈>双协议栈</h6><p>双协议栈（Dual Stack），一部分主机装有IPv4和IPv6两套协议栈；在不同协议栈的两部分分界处进行报文的转换。</p><h6 id=隧道技术>隧道技术</h6><p>隧道技术（Tunneling），当IPv6数据报要进入IPv4网络时，将IPv6数据报重新封装成IPv4数据报，即整个IPv6数据报称为IPv4数据报的数据载荷。</p><h3 id=43-路由配置和路由选择>4.3 路由配置和路由选择</h3><h4 id=1静态路由配置>1.静态路由配置</h4><p>路由器除了自行得出的<strong>直连路由</strong>和手动配置的<strong>非直连路由</strong>。还有一些特殊的路由：默认路由和特定主机路由。</p><h5 id=默认路由>默认路由</h5><p>默认路由条目中的目的网络填为0.0.0.0/0，其中0.0.0.0表示任意网络。由于最长前缀匹配，因此这里前缀为0的优先级最低。</p><h5 id=特定主机路由>特定主机路由</h5><p>网络前缀为/32，是最长的网络前缀，匹配优先级最高。</p><h4 id=2路由选择协议>2.路由选择协议</h4><p><img alt=image-9 src=/images/network/image-9.png></p><h5 id=分类>分类</h5><p>域间路由选择（Interdomain Routing）-对应协议为外部网关协议（External Gateway Protocol，EGP）：RIP OSPF</p><p>域内路由选择（Intradomain Routing）-对应协议为内部网关协议（Interior Gateway Protocol，IGP）：BGP</p><p>集中式路由选择算法（centralized routing algorithm）：需要全局网络信息&ndash;链路状态（Link state，LS）算法
分散式路由选择算法（decentralized routing algorithm）：通过迭代和信息交换的分布式计算&ndash;距离向量（Distance-vector,DV）算法</p><h5 id=路由信息协议>路由信息协议</h5><p>路由信息协议（Routing Information Protocol，RIP）是内部网关协议IGP。RIP报文信息封装在UDP中，端口号520。</p><p>AS内每个路由器都要维护一个距离向量，使用跳数（Hop Count）作为度量。</p><p>距离等于16时相当于不可达。因此RIP只能适用于小型网络。</p><p>当到达同一目的网络有多条RIP距离相等的路由时，可以进行等价负载均衡。</p><p>RIP的特点：</p><p>仅和相邻路由器交换信息；交换的信息是路由器的路由表；周期性交换（30S）</p><p>BellmanFord思想进行更新。同一目的网络下，如果新路由表的下一条信息相同，则进行更新[因为可以知道是网络拓扑发生了变化]，如果下一跳的信息不同，那么则取最优，如果RIP距离相等，则保留，可以进行等价负载均衡。</p><p>存在的问题：</p><p>无穷计数问题（更新消息传递不及时，导致被误导），更正方案：路由表发生变化时则立马发送路由更新报文；水平分割[不让信息从原接口反方向传输]。</p><h5 id=开放最短路径优先协议>开放最短路径优先协议</h5><p>开放最短路径优先协议（Open Shortest Path First，OSPF），OSPF报文直接封装在IP数据报中。协议字段为89。</p><p>基于链路状态并采用最短路径算法计算路由。</p><h6 id=链路状态>链路状态</h6><p>链路状态是指本路由器都和哪些路由器相邻，以及相应链路的代价，代价用来表示费用、距离、时延和带宽。</p><p>思科路由器中OSPF协议计算代价的方法是：100Mb/s除以链路带宽，结果小于1则取1。[带宽越小，代价值越大]。</p><h6 id=邻居关系维护>邻居关系维护</h6><p>通过问候（Hello）分组来建立和维护邻居关系。</p><p>OSPF分组封装在IP数据报中，协议号字段为89。</p><p>Hello分组的发送周期为10秒，若40秒没有收到来自邻居的问候分组，则认为该邻居不可达。因此每个路由器都会建立一张邻居表。该40秒倒计时通过一个判活计时器进行计时。</p><h6 id=链路状态通告>链路状态通告</h6><p>使用OSPF的每一个路由器都会产生链路状态通告（Link State Advertisement，LSA）。包含：直连网络的链路状态信息和邻居路由器的链路状态信息。</p><h6 id=链路状态更新分组>链路状态更新分组</h6><p>LSA被封装在链路状态更新分组（Link State Update，LSU）中，使用洪泛法（Flooding）发送。即通过自己的所有接口进行转发，最终整个区域中所有的路由器都获得信息。</p><h6 id=链路状态数据库>链路状态数据库</h6><p>使用OSPF的每个路由器都有一个链路状态数据库（Link State Database，LSDB），用于存储各路由器的LSA，各路由器的LSDB最终一致。</p><h6 id=最短路径计算>最短路径计算</h6><p>每个路由器根据LSDB可以得到一个带权有向图，执行Dijkstra可以得到以各自路由器为根的最短路径。</p><h6 id=ospf区域划分>OSPF区域划分</h6><p>为了使OSPF协议能够用于规模较大的网络，OSPF把一个AS再划分成若干个更小的范围，称为区域（area）。</p><p>每个区域都有一个32b的区域标识符，可以用点分十进制表示。主干区域的标识必须为0。每个区域一般包含的路由器不应超过200个</p><p>如果路由器的所有接口都在区域内，则为区域内路由器（internal router）；一个接口用于连接自身所在区域，另一个接口用于连接主干区域，则为区域边界路由器（area border router）；主干区域的路由器被称为主干路由器（backbone router）；在主干区域中有一个专门和本AS外的其它AS交换路由信息的路由器，成为自治区域边界路由器。</p><h5 id=边界网关协议>边界网关协议</h5><p>边界网关协议（Border Gateway Protocol，BGP），BGP报文基于179端口的TCP连接。</p><p>AS间的路由选择必须考虑相关政策，如政治，经济。</p><p>BGP力求寻找一条能够到达目的网络且比较好的路由。主要进行可达性信息的传播。</p><p>在BGP中，每对路由器[网关路由器]通过179端口的半永久TCP连接交换路由选择信息，即BGP连接（BGP connection）。</p><p>跨越两个AS的BGP连接为外部BGP连接（eBGP），反之为内部BGP连接（iBGP）。</p><h6 id=可达性信息传递>可达性信息传递</h6><p>AS3中一个网关路由器通过eBGP连接向其他路由器告知“AS3 x”，（x是AS3中一个网络）。则相当于告知x在AS3中，收到该可达性信息的路由器通过iBGP连接将信息转发给其所在AS的所有路由器，同时也通过eBGP连接向其它路由器告知"AS2 AS3 x"，这告知了x的位置，也告知了到达的路径。【TopDown的P263】</p><h6 id=确定最好的路由>确定最好的路由</h6><p>到达目的子网可能有多条路径，那么如何进行路径的选择？</p><p>可达性信息中告知的子网前缀中包含一些BGP属性（BGP attribute），比如<strong>AS-PATH</strong>和<strong>NEXT-HOP</strong>。</p><p>AS-PATH告知当前可达性信息中到达该AS所经过的所有AS；当某个子网前缀通过某个AS时，该AS将ASName加入到该AS-PATH的现有列表中。</p><p>NEXT-HOP是AS-PATH起始的路由器接口的IP地址。</p><p>从一个简单的路由选择算法开始，即<strong>热土豆路由选择</strong>（hot potato routing），意思是对于一个路由器，希望尽可能快的把分组送出当前AS，而不用担心其AS外部到目的地的余下部分的开销。因此它通过AS内部协议来找到多个网关（或者到NEXT-HOP）所需要的开销，并选择<strong>具有最小开销的那个网关</strong>进行转发。</p><p>实际上的路由选择算法较为复杂，路由器被指派一个本地偏好（local preference）作为其属性之一，路由选择优先选择属性值较高的，在余下具有相同最高本地偏好值的，将选择具有最短AS-PATH的路由，在余下的路由中（具有相同local preference和AS-PATH长度），使用hot potato，选择最靠近NEXT-HOP的路由进行跳转。</p><h4 id=3路由器的基本结构>3.路由器的基本结构</h4><p>路由器是一种具有多个输入端口和输出端口的专用计算机，其任务是转发分组。</p><p>路由选择部分：路由选择处理机[执行控制平面功能]，执行路由选择协议，计算路由表</p><p>分组转发部分：输入端口、输出端口、交换结构，通过转发表进行转发</p><p>路由表需要对网络拓扑变化的计算最优化，而转发表是从路由表得出的，转发表的结构应当使得查找过程最优化。</p><h5 id=输入端口>输入端口</h5><p>包含线路端接、数据链路拆封、查找、转发、排队</p><p>输入端口查找目的IP地址（“匹配”），然后将该分组送入交换结构（“操作”）。[匹配+操作]</p><h5 id=输出端口>输出端口</h5><p>包含排队（缓存管理）、链路数据处理、线路端接</p><h5 id=交换结构>交换结构</h5><p>交换结构switching fabrics</p><h6 id=经总线交换>经总线交换</h6><p>一次只有一个分组能够经过总线。</p><p>工作过程大致为：输入端口为分组预先计划一个交换机内部标签，指示本地输出端口，使分组在总线上传送和传输到输出端口，所有端口都能收到该分组，但只有标签匹配的端口才能保存。</p><h6 id=经内存交换>经内存交换</h6><p>在路由选择处理器的直接控制下完成。路由选择处理器从首部提取目的地址，在转发表中查找适当的输出端口，并将该分组复制到输出端口的缓存中。一个分组到达输入端口时，会通过中断方式向路由选择处理器发出信号。</p><h6 id=经互连网络交换>经互连网络交换</h6><p>Crossbar，也成为交叉开关矩阵或者纵横式交换矩阵，能够并行转发多个分组。</p><h3 id=44-网际控制报文协议icmp>4.4 网际控制报文协议ICMP</h3><p>网际控制报文协议（Internet Control Message Protocol，ICMP）</p><p>被封装在IP数据报发送。包含终点不可达、源点抑制、时间超过、参数问题、改变路由（重定向）。</p><h4 id=1差错报告报文>1.差错报告报文</h4><h5 id=终点不可达>终点不可达</h5><p>路由器发现无目的网络的转发条目则丢弃数据报并且往源主机发送ICMP差错报文，具体类型为终点不可达。</p><p>具体也包含：目的网络不可达（Type3 Code0）；目的主机不可达（Type3 Code1）；目的协议不可达（Type3 Code2）；目的端口不可达（Type3 Code3）；目的网络未知（Type3 Code6）；目的主机未知（Type3 Code7）</p><h5 id=源点抑制>源点抑制</h5><p>路由器由于网络拥塞而丢包，则往源主机发送该类型报文，以示减少发送速率。Type4。</p><h5 id=时间超过>时间超过</h5><p>路由器会将目的IP不为自己的IP数据报进行TTL减一，如果结果不为0，则转发，反之则丢弃并往回发送TTL过期，Type11.</p><h5 id=参数问题>参数问题</h5><p>路由器收到IP数据报后，进行checksum的检查，如果出现误码则丢弃并往回发送报文。Type12.</p><h5 id=改变路由>改变路由</h5><p>如果路由器发现更好的路由，则通过这种类型的ICMP报文告知主机变更路由。</p><h4 id=2icmp询问报文>2.ICMP询问报文</h4><h5 id=回送请求和回答>回送请求和回答</h5><p>即回显请求和回显回答（对ping的回答），收到回显请求的主机必须发送ICMP回显回答报文。可以用来判断目标是否可达。</p><h5 id=时间戳请求和回答>时间戳请求和回答</h5><p>用来请求某个主机或路由器回答当前的时期和时间。用来时钟同步和测量时间。</p><h4 id=3icmp的应用>3.ICMP的应用</h4><h5 id=ping>ping</h5><p>分组网间探测（Packet InterNet Groper，PING），主机向目标发送四个回显请求报文。由于往返的ICMP报文上都有时间戳，容易计算出RTT。</p><h5 id=traceroute>traceroute</h5><p>跟踪路由。windows版本的命令为tracert，UNIX版本的命令为traceroute。</p><p>基本原理：主机给目的发送ICMP回显请求报文，IP数据报字段的TTL值被设置为1.TTL递减，当为0时像源主机发送ICMP差错报告报文，类型为超时。接下来继续发送TTL值为2、3、4的ICMP回显请求报文</p><h3 id=45-vpn与nat>4.5 VPN与NAT</h3><h4 id=1-虚拟专用网>1. 虚拟专用网</h4><p>虚拟专用网（Virtual Private Network，VPN），利用公用的因特网作为机构专用网之间的通信载体。</p><p>由于很多机构所分配到的IP地址远小于其主机数目，可以进行专用地址（Private Address）的分配，不需要向因特网的管理机构申请。</p><p>专用地址在机构内部使用，因特网中的所有路由器，其对目的地址是专用网络的IP数据报一律不转发。</p><p>每个机构的专用网之中至少需要一个路由器具有合法的全球IP地址，这样经过VPN配置，各自的专用网才能利用公用因特网进行配置。</p><h5 id=专用网络>专用网络</h5><p>10.0.0.0~10.255.255.255（CIDR 10/8）</p><p>172.16.0.0~172.31.255.255（CIDR 172.16/12）</p><p>192.168.0.0~192.168.255.255（CIDR 192.168/16）</p><h5 id=工作过程>工作过程</h5><p>专用网内的主机向路由器发送IP数据报，路由器重新添加IP首部，将源和目的IP改为对应的专用网路由器的IP，同时加密原有IP报文。</p><p>也被称为IP隧道技术</p><p>同一机构不同部门的内部网络所构成的VPN称为内联网（Intranet或Intranet VPN，即内联网VPN）。</p><p>有外部机构则为外联网（Extranet或Extranet VPN，即外联网VPN）。</p><p>需要访问公司内部的专用网时，只需要在任何地点接入到因特网，运行VPN软件（进行IP的转换，否则专用网络的目标IP不会被转发），该PC和主机之间建立VPN隧道，可以访问到其中的资源。远程接入VPN（Remote Access VPN）。</p><h4 id=2-网络地址转换>2. 网络地址转换</h4><p>网络地址转换（Network Address Transition，NAT）。</p><p>IPv4地址面临被耗尽的风险。NAT使得大量使用内部专用网络的用户共享少量外部全球地址来访问因特网上的主机和资源。</p><p>通过网络地址和端口转换NAPT，维护一个NAT转换表。</p><p>将专用网内的各专用地址映射成一个公网地址和唯一的端口号。当生成一个新的源端口号时，NAT可以任意选择一个当前未在NAT转换表中的源端口号。</p><p>注意：专用地址不能充当服务器功能，即外网主机不能首先发起通信，这样当外网数据报到达NAT路由器时，在转换表中找不到对应的记录。需要网络应用自己使用一些特殊的NAT穿越技术。</p><h3 id=46-ip多播技术>4.6 IP多播技术</h3><h4 id=1基本概念>1.基本概念</h4><p>多播（Multicast）是实现“一对多”通信的技术。在因特网上进行的多播称为IP多播。</p><p><img alt=image-10 src=/images/network/image-10.png></p><h5 id=和ip任播的区别>和IP任播的区别</h5><p>IP任播（anycast）：考虑CDN，是指一组具有相同IP地址的设备中实际只有一个接收数据包。在IP任播中，多个设备共享同一个IP地址，但是不同设备有不同的物理位置，因此数据包只被发送到最近的一个设备。</p><p>IP多播（multicast）：在IP任播中，多个设备共享同一个IP地址，但是不同设备有不同的物理位置，因此数据包只被发送到最近的一个设备。</p><p>IP任播是一种<strong>点对点</strong>的通信方式，而IP多播是一种<strong>点对多点</strong>的通信方式。</p><h4 id=2多播地址>2.多播地址</h4><p>IPv4中，D类地址被作为多播地址。起始的四个比特固定为1110，剩余28比特任意变化。</p><p>最小的IPv4多播地址为224.0.0.0；最大的为239.255.255.255。只能用作目的地址，而不能用作源地址。</p><p>用每一个D类地址来标识一个<strong>多播组</strong>，使用同一个IP多播地址接收IP多播数据报的所有主机构成了一个多播组。</p><p>每个多播组的成员是可以随时变动的，一台主机可以随时加入或者离开多播组。</p><p>一台主机可以属于几个多播组。</p><p>非多播组成员可以向多播组发送IP多播数据报。</p><p>IP多播数据报也是best effort。</p><p>IP多播地址可以分为<strong>预留的</strong>多播地址（永久多播地址）、<strong>全球范围可用的</strong>多播地址以及<strong>本地管理的</strong>多播地址。</p><p><img alt=image-11 src=/images/network/image-11.png></p><h4 id=3多播类型>3.多播类型</h4><p>分为两种：只在本局域网上进行的硬件多播和在因特网上进行的多播。</p><p>而大部分主机都是通过局域网接入因特网，因此在多播的最后阶段一般都是局域网内的硬件多播。</p><h5 id=在局域网上进行硬件多播>在局域网上进行硬件多播</h5><p>由于MAC地址有多播MAC地址，只要将IPv4地址映射成局域网的硬件多播地址（即多播MAC地址）。MAC帧首部的MAC地址字段就设置为IPv4多播地址映射成的多播MAC地址。</p><p>《深入浅出》P239</p><h5 id=在因特网上进行多播>在因特网上进行多播</h5><p>必须考虑IP多播数据报经过多个多播路由器进行转发的问题。</p><p>多播路由器必须根据IP多播数据报首部的IP多播地址将其转发到有该多播组成员的局域网。</p><p>每个路由器则需要直到其接口所连局域网之中是否有某个多播组的成员。使用<strong>网际组管理协议</strong>（Internet Group Management Protocol，IGMP）。是网际层协议。作用是让连接在本地局域网上的多播路由器知道本局域网上的主机加入或者退出某个多播组。</p><p>IGMP只在本网络中有效，IGMP并不能知道多播组所包含成员的数量，也不知道多播组的成员都分布在哪些网络。</p><p>还需要使用<strong>多播路由选择协议</strong>。它建立了多播转发树。在多播转发树上进行洪泛，则所有多播组成员都能获取IP数据报。</p><p>不同的多播组需要维护不同的多播转发树，必须动态的知晓多播组的变化。</p><h4 id=4网际组管理协议>4.网际组管理协议</h4><p><strong>网际组管理协议</strong>（Internet Group Management Protocol，IGMP）。</p><p>《深入浅出》P243</p><h4 id=5多播路由选择协议>5.多播路由选择协议</h4><h3 id=47-移动ip技术>4.7 移动IP技术</h3><h4 id=1基本概念-1>1.基本概念</h4><p>移动IP（Mobile IP）使得移动主机在各网络之间漫游时，仍能改变其原来的IP地址不变。也向非移动主机提供了相应机制，使得他们能够将IP数据报正确的发送到移动主机。</p><p><img alt=image-12 src=/images/network/image-12.png></p><p>归属代理接收外来的IP报文段，并向外地代理发送，外地代理收到信息后转发给移动主机。</p><h3 id=48-软件定义网络>4.8 软件定义网络</h3><h4 id=1核心思想>1.核心思想</h4><p>把网络的控制层面和数据层面分离，而让控制层面利用软件来控制数据层面中的许多设备。</p><p>路由器中的路由表（匹配加操作表）由远程控制器计算、安装和更新。</p><h4 id=2openflow>2.OpenFlow</h4><p>OpenFlow协议是一个得到高度认可的标准，可以被看成是SDN体系结构中控制层面与数据层面之间的通信接口。</p><p>OpenFlow协议使得控制层面的控制器可以对数据层面中的物理设备进行直接访问和控制。</p><h4 id=3泛化转发>3.泛化转发</h4><p>转发分组可以分成以下两个步骤：</p><p>1.进行匹配：查找转发表中的网络前缀，进行最长前缀匹配；</p><p>2.执行动作：把分组从匹配结果指明的接口转发出去。</p><p>SDN对转发过程进行了扩充，广义转发分为以下两个步骤：</p><p>1.进行匹配：能够对网络体系结构中的各层首部中的字段进行匹配；</p><p>2.执行动作：不仅转发分组，还可以负载均衡、重写IP首部（类似NAT）、人为的阻挡或丢弃一些分组（类似防火墙）。</p><p>在SDN的广义转发中，完成”匹配+动作“的设备并不局限在网络层工作，因此不再称为路由器，而称为”OpenFlow交换机“或者”分组交换机“，或更简单地称为”交换机“。</p><h5 id=流表>流表</h5><p>在SDN中取代传统路由器中转发表（匹配加操作转发表）的是<strong>流表（Flow Table）</strong>，[一个流就是穿过网络中的一种分组序列，而在此序列中的每个分组都共享分组首部某些字段的值]，OpenFlow交换机中的流表是由SDN远程控制器来管理的。SDN远程控制器通过一个安全信道，使用OpenFlow协议来管理OpenFlow交换机中的流表。</p><p>每个OpenFlow交换机必须有一个或者多个流表。每个流表项包含：首部字段值、计数器、动作。</p><h6 id=首部字段值>首部字段值</h6><p>其中包含一组字段，用来使如分组（Incoming Packet）的对应首部与之匹配，因此又称为匹配字段。匹配不上字段分组被丢弃，或者被送到SDN远程控制器做更多的处理。</p><p><img alt=image-13 src=/images/network/image-13.png></p><h6 id=计数器>计数器</h6><p>一个计数器记录已经与该流表项匹配的分组数量的计数器；另一个计数器记录流表项上一次更新的时间。</p><h6 id=动作>动作</h6><p>动作字段是指一组动作，当分组匹配某个流表项时，执行该流表项中动作字段指明的动作。包括：把分组转发到指明的端口、丢弃分组、把分组进行复制后再从多个端口转发出去、重写分组的首部字段（包括数据链路层、网际层和传输层的首部）。</p><h4 id=4关键特征>4.关键特征</h4><p>1.基于流的转发</p><p>2.数据层面与控制层面分离</p><p>3.位于数据层面分组交换机之外的网络控制功能</p><p>4.可编程的网络</p><p><img alt=image-14 src=/images/network/image-14.png></p><h2 id=chapter5-数据链路层>Chapter5. 数据链路层</h2><h3 id=51-概述>5.1 概述</h3><h4 id=1相关概念>1.相关概念</h4><h5 id=链路>链路</h5><p>Link，是从一个节点到相邻节点的一段物理链路，中间没有其它交换节点。</p><h5 id=数据链路>数据链路</h5><p>Data Link，是基于链路的，把实现控制数据传输的协议的硬件和软件加到链路上，就成了数据链路。</p><h5 id=帧>帧</h5><p>Frame，是数据链路层对等实体之间再水平方向进行逻辑通信的PDU。</p><h4 id=2-提供服务>2. 提供服务</h4><h5 id=封装成帧>封装成帧</h5><p>封装成帧（framing），就是网络层交付下来的分组添加一个首部和尾部。其中包含一些重要的控制信息，包括：帧首部有帧开始符、源地址、目的地址；尾部有帧校验序列和帧结束符。每一种数据链路层协议规定了帧的数据载荷的长度上限，即<strong>最大传输单元</strong>（Maximum Transfer Unit，MTU），例如以太网的MTU为1500字节。</p><h5 id=差错检测>差错检测</h5><h5 id=可靠传输可靠交付>可靠传输（可靠交付）</h5><p>保障无差错地经过链路层移动每个网络层数据报文，但通常是通过确认和重传取得的，用于产生高差错率的链路，而对于低比特差错的链路，包括光纤，这种服务可能是不必要的开销，因此有些链路层协议不提供可靠交付服务。[考虑rdt]</p><h5 id=链路接入>链路接入</h5><p>介质访问控制（Medium Access Control，MAC）协议规定了帧在链路上的传输规则。对于点对点链路，MAC协议比较简单；对于多个节点共享单个广播电路，即所谓多路访问问题，MAC协议用于协调多个节点的帧传输。</p><h3 id=52-差错检测>5.2 差错检测</h3><h4 id=1奇偶校验>1.奇偶校验</h4><p>使用单个奇偶校验位（parity bit），如果信息D中有d比特，需要添加一个附加的比特（校验比特），满足d+1个比特中1的总数是偶数（偶校验）。</p><h4 id=2checksum>2.checksum</h4><p>同UDP的checksum</p><h4 id=3crc>3.CRC</h4><p>循环冗余检验（Cyclic Redundancy Check，CRC）。</p><h5 id=发送方>发送方</h5><p>给定最高次数为r的生成多项式G，共有r+1位。</p><p>在待发送信息最后添加r位的0。</p><p>进行除法运算，获得余数，余数个数需与r一致。</p><p>将r位余数添加到待发送信息末尾。</p><h5 id=接收方>接收方</h5><p>将接收信息直接进行除多项式操作，若余数不为0则发生了错误。</p><h3 id=53-多路访问链路和协议>5.3 多路访问链路和协议</h3><h4 id=0点对点协议>0.点对点协议</h4><p>由链路一端的单个发送方和链路的另一端的单个接收方组成。包括PPP和HDLC（high-level data link control，高级数据链路控制）</p><p>点对点协议<strong>PPP</strong>（Point-to-Point Protocol）为在点对点链路传输各自协议数据报提供了一个标准方法，包括：</p><p>1.对各种协议数据报的封装方法</p><p>2.链路控制协议LCP，用于建立、配置以及测试数据链路的连接</p><p>3.一套网络控制协议NCPs，其中的每一个协议支持不同的网络层协议</p><p>使用PPP的数据链路层向上不提供可靠传输服务。</p><p><img alt=image-15 src=/images/network/image-15.png></p><h5 id=ppp帧格式>PPP帧格式</h5><p><img alt=image-16 src=/images/network/image-16.png></p><p>其中FCS为Frame Check Sequence，取值为CRC计算出的校验位</p><p>多路访问协议用于协调多个发送和接收节点对一个共享广播信道的访问（多路访问问题，multiple access problem）。防止碰撞collide</p><p>包括<strong>信道划分协议</strong>（channel partitioning protocol）、<strong>随机接入协议</strong>（random access protocol）、<strong>轮流协议</strong>（taking-turns protocol）</p><h4 id=1信道划分协议>1.信道划分协议</h4><h5 id=时分多路复用tdm>时分多路复用TDM</h5><p>将时间划分为时间帧（time frame），并进一步划分每一个时间帧为N个时隙（slot）。然后把每个时隙分配给N个节点中的一个。通常选择的时隙长度应使一个时隙内能够传输单个分组。但节点被限制R/N bps的平均速率。</p><h5 id=频分多路复用fdm>频分多路复用FDM</h5><p>将信道划分为不同的频段，每个频段有R/N的带宽，并把每个频率分配给N个节点中的一个。</p><h5 id=码分多址cdma>码分多址CDMA</h5><p>码分多址（Code Division Multiple Access，CDMA）对每个节点分配一种不同的编码，然后每一个节点用它<strong>唯一的编码</strong>来对将要发送的数据进行编码操作。</p><p>CDMA将每个比特时间划分为m个更短的时间片，称为码片clip。每一个站点被指派一个唯一的<strong>码片序列</strong>，满足不同站点的码片序列正交，相同站点的码片内积为1，与自身反码的内积为-1.[以上内积均为规格化内积，即要除以码片长度m]</p><p>各站点若要发送1则发送码片序列，要发送0则发送码片序列的反码（乘-1的结果）。</p><p>各站点将<strong>接收到的码片向量</strong>与<strong>自身指派的码片序列</strong>进行规格化内积计算，为1则收到信息1，为-1则收到信息0，否则没有收到信息。</p><h4 id=2随机接入协议>2.随机接入协议</h4><h5 id=时隙aloha>时隙ALOHA</h5><p>每一个时隙等于传输一帧的时间，需要在每个时隙的起点进行帧的传输。</p><p>若发送碰撞，则有<strong>p的概率</strong>在之后的每一个时隙进行重新发送，直到该帧被成功传输。</p><p>时隙ALOHA是高度分散的，每个节点检测碰撞并独立地决定什么时候进行重传，需要在节点中对时隙进行同步。</p><p>效率为Np(1-p)^(N-1)，可计算最大效率为1/e=0.37 [效率定义为长期运行中有效发送时隙占总时隙的份额]</p><h5 id=aloha>ALOHA</h5><p>时隙ALOHA要求节点同步从每个时隙开始时进行传输，第一个ALOHA协议实际上是一个非时隙、完全分散的协议。</p><p>即在从上层接收到帧后，<strong>立即发送</strong>该帧，如果碰撞了，则立即在它完整的传输完该碰撞帧后重新以概率p再次传一次，1-p的概率等待一个帧传输时间。</p><p>最大效率仅为1/2e，是时隙ALOHA的一半。·</p><h5 id=载波侦听多路访问csma>载波侦听多路访问CSMA</h5><p>对于ALOHA，一个节点的传输独立于广播信道上的其他节点的活动。</p><p>载波侦听多路访问（Carrier Sense Multiple Access，CSMA）的关键在于载波侦听（carrier sensing），即一个节点在传输前先<strong>听信道</strong>，在信道空闲时再开始传输。</p><h6 id=碰撞检测cd>碰撞检测CD</h6><p>具有碰撞检测的载波监听多路访问（CSMA/CD，CSMA with Collision Detection）</p><p>当某节点执行碰撞检测时，一旦检测到碰撞将立即停止传播。[减少了无用的帧的干扰，提高性能]</p><p>由于站点必须”边发送帧边检测碰撞“，因此站点不可能同时发送和接收，即不可能进行全双工通信，只能进行半双工通信（双向交替通信）。</p><p><strong>协议过程</strong>：</p><p>1.从网络层获取数据报，装帧，并置于缓存中；</p><p>2.如果听到信道空闲，则开始传输，如果信道忙，则等待，直到侦听到没有能量信号才开始传输；</p><p>3.传输过程中，适配器监视来自其它使用该广播信道的适配器的信号能量的存在；</p><p>4.如果检测到其它适配器的能量，则终止传输（碰撞发生，停止传输帧）；</p><p>5.终止传输后，等待一个<strong>随机时间量</strong>，返回步骤2[其实这里需要等待一个96比特时间的空闲信道]。</p><p>当碰撞节点数量较小时。间隔时间较短，反之应较长。</p><p>对于随机时间量的选择，采用<strong>二进制指数后退</strong>算法（binary exponential backoff）</p><p><strong>随机时间量的选择</strong></p><p>当传输一个帧，其连续经历了n次碰撞，则节点随机从[0,1,2,&mldr;,2^n-1]中选择一个K值，连续碰撞越多，K的选择范围越大。</p><p>对于以太网，一个节点等待的实际时间量为512K比特时间，即发送512比特进入以太网所需时间量的K倍，n能够取得最大值为10</p><p><strong>强化碰撞</strong></p><p>发送帧的站点一旦检测到碰撞，除了立即停止发送帧外，还要再继续发送32b或者48b的人为干扰信号（Jamming Signal），以便有更多的碰撞信号使得所有站点都能够检测出碰撞。</p><h6 id=碰撞避免ca>碰撞避免CA</h6><h4 id=3轮流协议>3.轮流协议</h4><p>轮流协议(taking-turns protocol)，包含轮询协议（polling protocol）和令牌传递协议（token-passing protocol）等。</p><h5 id=轮询协议>轮询协议</h5><p>要求这些节点之一被指定为主节点。主节点以循环的方式轮询每个节点，并告知其能发送的帧的最多数量。以此进行循环</p><h5 id=令牌传递协议>令牌传递协议</h5><p>这种协议中没有主节点。一个称为令牌（token）的小的特殊的帧在节点之间以某种固定的次序进行交换。</p><p>当一个节点收到令牌时，仅当他有一个帧要发送时，它才持有该令牌，否则将向下一个节点传递令牌。</p><p>缺点就是一个节点的故障或者占用令牌可能会导致整个信道崩溃，需要某些恢复步骤来保障令牌返回到循环中。</p><h3 id=54-交换局域网>5.4 交换局域网</h3><h4 id=1mac地址>1.MAC地址</h4><p>要将计算机连接到局域网，需要使用相应的网络适配器（Adapter），简称为网卡NIC。</p><p>MAC（Medium Access Control，媒体接入控制）地址是数据链路层地址，作为唯一标志，由于广播信道天然的广播特性，需要通过MAC地址来进行判断帧是否发送给自己。</p><p>MAC地址也称为LAN地址、物理地址等。被固化在NIC的EEPROM中。</p><h5 id=mac地址格式>MAC地址格式</h5><p>MAC地址长度6字节，共48比特。</p><p>前24比特为组织统一标识符（Organization Unique Identifier，OUI），也成为公司标识符，后24位为网络接口标识符，由获得OUI的厂商自行分配。</p><p><img alt=image-17 src=/images/network/image-17.png></p><h5 id=处理方式>处理方式</h5><p>如果是广播地址，接收</p><p>如果目的MAC与NIC上固化的MAC相同，则接收</p><p>如果目的MAC是NIC支持的多播地址，则接收。</p><h5 id=安全问题>安全问题</h5><p>用户应确保自己拥有的全球单播MAC地址不被泄露，为了避免WIF连接时的MAC泄露问题，大多数移动设备已经采用了随机MAC技术。</p><h4 id=2以太网>2.以太网</h4><h5 id=以太网技术>以太网技术</h5><p>以太网是到目前为止最流行的有线局域网技术。是第一个广泛部署的高速局域网。</p><p>初始的以太局域网使用同轴电缆总线来互联节点，使用<strong>总线拓扑</strong>的以太网是一种广播局域网，即所有传输的帧传输到与该总线连接的所有适配器都会被处理。</p><p>20世纪90年代后期，大多数机构使用一种基于<strong>集线器</strong>（Hub）的<strong>星形拓扑</strong>以太网结构。[集线器工作在物理层]</p><p>集线器作用于各个比特而不作用于帧，当比特到达接口时，集线器重新生成这个比特，将其能量放大并从所有接口传输出去，因此该星型拓扑结构也为广播局域网。</p><p>21世纪处，以太网继续使用星型拓扑，但是位于中心的集线器被<strong>交换机</strong>（switch）所替代。[交换式以太网]</p><p>IEEE于1990年指定了<strong>10BASE-T</strong>星型以太网的标准802.3i，为以太网在局域网中的统治地位奠定了牢固的基础。</p><p>[每个站点到集线器的距离不超过100m，由于距离太远可能导致信号衰减到相关协议无法工作，例如CSMA/CD，在IEEE802.3标准中，两个网段可以使用转发器（repeater）进行连接，从而获得更长的运行距离]</p><p>标准中：10、100、1000、10G或40G分别代表该标准中的传输速率（Mbps）；BASE指的是基带以太网（意味着物理媒介仅承载以太网流量）；T代表物理媒介双绞铜线，F代表光纤。</p><h5 id=以太网帧>以太网帧</h5><h6 id=格式>格式</h6><p><img alt=image-18 src=/images/network/image-18.png></p><p>其中类型标志着数据载荷中的网络层协议，0x0800代表了IPv4协议、0x0806代表了ARP分组</p><p>FCS中为四字节的CRC字段</p><p>此外，以太网帧以一个8字节的前同步码（Preamble）字段开始，该字段的前七个字节为10101010，最后一个字节是10101011，前七个字节用于唤醒接收适配器，并且将它们的时钟和发送方进行同步。[这里可以理解成数据链路层帧在下放到物理层时还要加上一个前导码]</p><h6 id=最小帧长和最大帧长>最小帧长和最大帧长</h6><p><strong>最小帧长</strong>：若发送的帧过小，则可能检测不到实际产生的碰撞；为了能够检测出碰撞，帧的发送时延就不能少于端到端的往返时延，即一个争用期2t。对于10Mb/s的共享总线以太网，最小帧长为512b，即64B。[如果遭遇碰撞，一定在帧的前64B之前，在这个时间内，发送方一定能够检测出碰撞，而停止发送，因而接收端接收到的帧长会小于64，由此判断收到了因碰撞而损坏的帧]</p><p>就是在2t争用期中传输的比特长度：最小帧长=数据传输速率×争用期（往返时延）</p><p><strong>最长帧长</strong>：帧太长而过度占用信道，还可能使得接收方溢出。因此以太网V2的MAC帧的最大长度规定为1518B（数据载荷1500B）。此时数据载荷最小为46B，为了满足帧长大于64B。</p><h4 id=3链路层交换机>3.链路层交换机</h4><p>交换机的任务就是接收入链路层帧并将它们转发到出链路</p><h5 id=过滤和转发>过滤和转发</h5><p>过滤（filtering）是决定一个帧应该转发到某个接口还是应当将其丢弃的交换机功能。</p><p>转发（forwarding）是决定一个帧应该被导向哪个接口，并把该帧移动到那些接口。</p><p>交换机的过滤和转发借助于<strong>交换机表</strong></p><p>交换机表中包含某局域网上某些主机和路由器的表项，但不必是全部。</p><p>表项包含：MAC地址 通向该MAC地址的交换机接口 表项被放置在表中的时间</p><p><em>对于表项的处理</em></p><p>表中没有对于目的地址的表项，交换机则广播该帧</p><p>表中存在相关联的表项，则转发到对应的接口即可</p><p>若表中存在的表项的对应接口为传入接口， 则无需进行转发，丢弃该帧执行过滤功能即可。</p><h5 id=自学习>自学习</h5><p>交换机表是通过自学习（self-learning）进行自动、动态和自治地建立的。</p><p>对于每一个接口收到的入帧，该交换机在表中存储：1.该帧的源地址字段中的MAC地址；2.到达的接口；3.当前时间</p><p>如果在一段时间（老化期aging time）后，交换机没有收到以某个地址为源的帧，则在表中删除，以处理PC被替代的问题。</p><p>交换机是即插即用的设备（plug-and-play device）</p><h5 id=特点>特点</h5><p>消除碰撞</p><p>将异质的链路互连</p><p>易于进行网络的管理</p><p>全双工工作，在自身内部同时连通多对接口</p><p>也使用生成树协议STP，来产生能够连通全网而不产生环路的通信路径 [路由器没有生成树限制，允许丰富的网络拓扑，活跃链路可能有多条]</p><p>[交换机不会进行广播风暴的处理]</p><p><img alt=image-19 src=/images/network/image-19.png></p><p>对比：</p><table><thead><tr><th style=text-align:center></th><th style=text-align:center>集线器</th><th style=text-align:center>路由器</th><th style=text-align:center>交换机</th></tr></thead><tbody><tr><td style=text-align:center>流量隔离</td><td style=text-align:center>无</td><td style=text-align:center>有</td><td style=text-align:center>有</td></tr><tr><td style=text-align:center>即插即用</td><td style=text-align:center>有</td><td style=text-align:center>无</td><td style=text-align:center>有</td></tr><tr><td style=text-align:center>优化路由</td><td style=text-align:center>无</td><td style=text-align:center>有</td><td style=text-align:center>无</td></tr></tbody></table><h4 id=4虚拟局域网vlan>4.虚拟局域网VLAN</h4><p>虚拟局域网（Virtual Local Area Network，VLAN）是一种将局域网内的设备划分成和物理位置无关的逻辑组的技术，这些逻辑组具有某些共同的需求。</p><p>同一个VLAN内可以广播通信，不同VLAN之间不能广播通信。</p><h5 id=ieee-8021q帧>IEEE 802.1Q帧</h5><p><img alt=image-20 src=/images/network/image-20.png></p><p>VLAN标记的最后12个比特称为VLAN标识符VID，它唯一地标识了以太网帧属于哪一个VLAN。取值范围为1~4094（0和4095不表示）</p><p>802.1Q帧由交换机处理而非用户主机。</p><p>当交换机收到普通的以太网帧时，会将其插入四字节的VLAN标记，转变为802.1Q帧。[打标签]</p><p>当交换机转发802.1Q帧时，可能会删除VLAN标记，转变为普通帧，[去标签]</p><h5 id=交换机的端口类型>交换机的端口类型</h5><p>交换机的端口类型有三种：Access、Trunk、Hybrid</p><p>对于缺省的VLAN ID[端口上]：思科交换机上称为本征VLAN，华为交换机称为Port VLAN ID，即端口VLAN ID，简称为PVID。[默认VLAN]</p><h6 id=access端口>Access端口</h6><p>一般用于<strong>连接用户计算机</strong>、只能属于一个VLAN</p><p>Access端口的PVID值于端口所属的VLAN的ID相同，默认为1</p><p><em>对于接收的处理方法</em></p><p>一般只接受”未打标签“的普通以太网MAC帧。根据接收帧的端口的PVID给帧”打标签“，即插入四个字节的VLAN标记字段，字段中的VID取值与端口的PVID相等</p><p><em>对于发送的处理方法</em></p><p>若帧中的VID与端口的PVID相等，则”去标签“并转发该帧；否则不转发</p><h6 id=trunk端口>Trunk端口</h6><p>Trunk端口一般用于<strong>交换机之间</strong>或者交换机和路由器之间的互连。</p><p>Trunk可以属于多个VLAN</p><p>用户可以设置Trunk端口的PVID值，默认为1。</p><p><em>对于接收的处理方法</em></p><p>接收未打标签的帧，根据接收帧的端口的PVID给帧”打标签“</p><p>或者直接接收已打标签的帧</p><p><em>对于发送的处理方法</em></p><p>对于VID等于PVID的帧，”去标签“再转发。</p><p>对于VID不等于PVID的帧，直接转发。</p><h6 id=hybrid标签>Hybrid标签</h6><p>接收方面与Trunk端口一致</p><p>发送方面可以视作端口有多个PVID，查看帧的VID是否在”去标签“列表中再考虑是否进行去标签操作。</p><h3 id=55-数据中心网络>5.5 数据中心网络</h3><h4 id=1用途>1.用途</h4><p>1.他向用户提供网页、搜索结果、电子邮件或流媒体视频；</p><p>2.用于特定数据处理任务的大规模并行计算基础设施，比如搜索引擎的分布式索引计算；</p><p>3.为其它公司提供云计算服务</p><h4 id=2体系结构>2.体系结构</h4><p>数据中心的主机称为刀片（blade），一般是包括CPU、内存和磁盘存储的商用主机。</p><p>每个机架包含20~40台刀片，机架顶部有一个交换机，被称为机架顶部（Top of Rack，TOR）交换机，与主机互连。</p><p>数据中心网络支持两种类型的流量：在外部客户和内部主机之间流动的流量，主机之间流动的流量。包含多个边界路由器（border router），与公共因特网相连。</p><p>数据中心网络设计（data center network design）是互联网络和协议设计的艺术，专注于机架彼此连接和边界路由器相连。</p><h5 id=负载均衡>负载均衡</h5><p>为了支持来自外部客户的请求，每一个应用都与一个公开可见的IP地址关联。</p><p>数据中心内部，外部请求首先被定向到一个负载均衡器（load balancer），其任务是向主机分发请求，以主机当前的负载作为函数来在主机之间实现负载均衡。</p><p>一个大型的数据中心通常会有几台负载均衡器，每台服务于一组特定的云应用。</p><p>负载均衡器不仅平衡主机之间的工作负载，而且还提供类似NAT的功能，将外部IP地址转换为内部适当主机的IP地址。防止客户直接接触主机</p><h5 id=等级体系结构>等级体系结构</h5><p>数据中心通常使用路由器和交换机等级结构（hierarchy of router and switch）</p><p>三层交换机结构，边界路由器和接入路由器相连，随后连接三层交换机（TOPDOWN P332 图6-30）</p><p>每台接入路由器下的主机构成了单一子网。为了使得ARP广播流量本地化，这些子网都被进一步划分为更小的VLAN，每个VLAN包含数百个主机。</p><p>依然存在<strong>主机到主机容量受限问题</strong>。解决方法包括：1.部署更高速率的交换机和路由器；2.将相关服务和数据放在尽可能近的位置，以减少通过第二层或者第一层交换机的机架间通信。3，增强TOR交换机和第二层交换机之间以及第二层交换机和第一层交换机之间的选择[多增加一些互连通路，增大可能带宽]</p><h4 id=3发展趋势>3.发展趋势</h4><p>1.降低成本</p><p>2.集中式SDN控制和管理</p><p>3.虚拟化：虚拟机（VM）将运行应用程序的软件和物理硬件解耦</p><p>4.物理约束：数据中心的网络运行环境有极高的容量和极低的时延，拥塞控制协议会导致极低的效率，目前已经提出和部署了几种解决这个问题的方法，例如直接内存访问技术（RDMA）</p><p>5.硬件模块化和定制化：采用基于航运集装箱的模块化数据中心（Modular Data Center，MDC）。</p><h2 id=chapter6-无线网络和移动网络>Chapter6. 无线网络和移动网络</h2><h3 id=61-概述>6.1 概述</h3><h4 id=1相关要素>1.相关要素</h4><p>无线主机 wireless host</p><p>无线链路 wireless communication link 主要特性：链路速率和覆盖区域</p><p>基站base station 负责向与之关联的无限主机发送数据，并从主机那里接收数据 [例如蜂窝网络中的蜂窝塔（cell tower）和802.11无线局域网中的接入点AP]</p><p>与基站关联的主机通常被称为以基础设施模式（infrastructure mode）运行，所有的传统网络服务（地址分配、路由选择）由网络向通过基站向量的主机提供</p><p>自组织网络中（ad hoc network），无线主机没有这样的基础设施，主机本身必须提供相关服务（地址分配、路由选择、DNS等）</p><p>从一个基站转移到另一个基站，这一过程为<strong>切换</strong>（handoff或者handover）</p><h3 id=62-无线链路和网络特征>6.2 无线链路和网络特征</h3><h4 id=1相关特性>1.相关特性</h4><p>递减的信号强度、来自其它源的干扰、多路径传播（multipath propagation）</p><p>无线链路协议不仅采用有效的CRC错误检测码，还采用了链路层可靠的数据传输协议来重传受损的帧。</p><h4 id=2信号特征>2.信号特征</h4><p>SNR：信噪比 BER：比特差错率</p><p>对于给定的调制方案，SNR越高，BER越低；</p><p>对于给定的SNR，有高比特传输率的调制技术将有较高的BER；</p><p><strong>隐藏终端问题</strong>（hidden terminal problem）：由于信号的衰减（fading），导致信号强度不足以至于一些终端无法检测对方的传输。</p><h3 id=63-80211无线局域网>6.3 802.11无线局域网</h3><p>802.11n（WiFi 4） 2.4GHz、5GHz 600Mbps</p><p>802.11ac（WiFi 5）5GHz 3.47Gbps</p><p>802.11ax（WiFi 6）2.4GHz、5GHz 14Gbps</p><h4 id=1体系结构>1.体系结构</h4><p>802.11体系结构的基本构建模块是基本服务集（Basic Service Set，BSS）。</p><p>BSS包含一个或者多个无限站点以及一个接入点（Access Point，AP）[中央基站base station]</p><p>部署AP的无线局域网经常被称作基础设施无线局域网（infrastructure wireless LAN），其中的“基础设施”是指AP连通互联AP和一台路由器的有线以太网。</p><h5 id=信道和关联>信道和关联</h5><p>每个无线站点在能够发送和接收网络层数据之前，必须和一个AP相关联。</p><p>每个AP都有被分配一个单字或者双字的<strong>服务集标识符</strong>（Service Set Identifier，SSID）。还必须被分配一个<strong>信道号</strong>。</p><p>802.11定义了11个部分重叠的信道号，当且仅当两个信道由4个或者更多信道隔开时它们才无重叠。</p><p>WiFi丛林（jungle）是一个任意位置，无限站点能从两个或者多个AP中受到强信号。需要与其中一个AP相关联（associate）</p><p><em>如何进行关联？</em></p><p>每个AP周期性地发送信标帧（Beacon Frame），包括该AP的SSID和MAC地址。无线主机扫描11个信道，找到位于该区域的AP所发出的信标帧。</p><p>扫描信道和监听信标帧的过程被称为被动扫描（passive scanning）</p><p>无线主机也能完成主动扫描（active scanning），通过向位于无线主机范围内的所有AP广播探测帧[发送探测请求帧Probe Request Frame]完成的。[AP会发回探测响应帧Probe Request Frame]</p><p>选定关联的AP后，无线主机发送关联请求帧，并且AP以一个关联响应帧进行响应。</p><h4 id=280211mac协议>2.802.11MAC协议</h4><p>802.11无线局域网选择的一种随机接入协议，为带碰撞避免的CSMA（CSMA with collision avoidance），即CSMA/CA。</p><p>对于802.11，使用碰撞避免而非碰撞检测，其次，对于无线信道相对高的比特差错率，使用<strong>链路层确认/重传</strong>（ARQ）方案。</p><p>原因在于：</p><p>接收信号的强度通常远远小于发送信号的强度，构建具有检测碰撞能力的硬件代价较大。</p><p>适配器会由于隐藏终端问题和衰减问题而无法检测到所有的碰撞。</p><p>802.11不再使用碰撞检测，一旦站点开始发送一个帧，就完全发送，为了降低碰撞的可能性，采用了几种<strong>碰撞避免技术</strong>。</p><h5 id=链路层确认方案>链路层确认方案</h5><p>链路层确认（link-layer acknowledgment）</p><p>无线局域网发送帧时，会因为多种原因不能无损的到达目的站点，为了处理这种故障，使用链路层确认方案。</p><p>目的站点收到一个CRC检验的帧后，等待一个短帧间间隔（Short Inter-Frame Spacing，SIFS）后发回一个确认帧。</p><p>如果发送站点在给定的时间内未能收到确认帧，则假定出现了错误并重传该帧，使用CSMA/CA协议访问该信道。</p><h5 id=csmaca>CSMA/CA</h5><p>1.某站点最初监听到信道空闲，将在一个被称为分布式帧间间隔（Distributed Inter-frame Space，DIFS）的短时间后发送帧。</p><p>2.否则，选择一个随机回退值，并且在信道空闲时递减该值。在侦听到信道忙时反而不递减</p><p>3.计数该值若减为0，即侦听信道空闲，站点发送整个数据帧并等待确认</p><p>4.如果收到确认，则OK，如果还要发送其他帧，从第二步继续开始。若未收到确认，传输站将重新进入第二步中的回退阶段，在更大范围内选取随机值</p><p><em>为什么信道忙时也要等待？</em></p><p>考虑：如果两个站点都要发送数据帧，而此时第三个站点已经开始了传输，双方都未立即发送。</p><p>如果像CSMA/CD一般，两个站点检测到第三方发送完毕后立马则开始发送，则会导致碰撞，在CSMA/CD中会因为检测碰撞而放弃发送，因此避免帧的无用部分继续被发送，而对于802.11，它不会检测碰撞和放弃发送，受损帧会继续传输。因此对于802.11，无论如何都要进行碰撞避免。</p><h5 id=处理隐藏终端问题>处理隐藏终端问题</h5><p>802.11包含一个不错的<strong>预约方案</strong>，帮助在隐藏终端的情况下进行避免碰撞。</p><p>为了避免由于隐藏终端问题导致的互相隐藏的两个终端之间的碰撞问题，允许站点使用短**请求发送（Request to Send，RTS）<strong>控制帧和</strong>允许发送（Clear to Send，CTS）**控制帧来预约对信道的访问。</p><p><em>过程</em></p><p>当发送方要发送一个DATA帧时，首先向AP发送一个RTS帧，指示传输DATA帧和确认ACK帧的总时间。当AP受到RTS帧时，<strong>广播一个CTS</strong>作为响应，该CTS帧有两个目的：给发送方明确发送许可，指示其它站点在预约期内不要发送。完成传输后广播ACK帧。</p><p><em>优势</em></p><p>1.缓解了隐藏终端的问题</p><p>2.RTS和CTS帧很短，设计它们的碰撞将仅持续短RTS和CTS的持续续期，一旦它们被正确发送，后面DATA和ACK就能无碰撞。</p><h4 id=3ieee-80211帧>3.IEEE 802.11帧</h4><p>分为数据帧、控制帧、管理帧</p><p><img alt=image-21 src=/images/network/image-21.png></p><h5 id=帧格式>帧格式</h5><p><img alt=image-22 src=/images/network/image-22.png></p><p><strong>帧控制</strong>：</p><p>类型：区别数据帧、控制帧、管理帧</p><p>子类型：每个类型又有多个子类型</p><p><strong>持续期</strong>：</p><p>实现CSMA/CA的虚拟载波侦听和信道预约。在数据帧、RTS、CTS帧中指出信道占用时间</p><p><strong>序号控制</strong>：</p><p>用来实现802.11的可靠传输，对数据帧进行编号 [回想TCP报文段的编号]</p><p><strong>地址</strong>：</p><p><img alt=image-23 src=/images/network/image-23.png></p><p>【图中去往DS和来自DS同TopDown教材中的到AP和从AP】</p><p>[对于01 和 10 ，地址1均为当前帧的发送目标地址，地址2均为当前帧的发送源地址【单段】]</p><p>[对于以太网来说，AP透明]</p><p><img alt=image-24 src=/images/network/image-24.png></p><h4 id=4同ip子网的移动性>4.同IP子网的移动性</h4><p>在同一个子网下的不同BSS之间的移动</p><p>过程：</p><p>随着H1逐步远离AP1，H1检测到来自AP1的信号减弱，开始扫描一个更强的信号。H1收到来自AP2的信标帧，H1与AP1解除关联，并与AP2进行关联，保持其IP地址和正在进行的TCP会话。</p><p>在交换机角度来说，交换机是“自学习的”，新关联形成后，新AP会以主机为源发送以太网广播帧，同子网内的相关交换机对此进行学习。</p><h4 id=5高级特色>5.高级特色</h4><p>速率适应</p><p>功率管理：明确在睡眠和唤醒状态之间交替，通过定时器的设置保障节点在AP发送信标帧[100ms一次]前进行唤醒[唤醒只要250ns]。如果AP发送的帧[非信标帧]的目的节点在睡眠，则缓存。</p><h4 id=6蓝牙>6.蓝牙</h4><p><img alt=image-25 src=/images/network/image-25.png></p><h3 id=64--蜂窝网络>6.4 蜂窝网络</h3><p>蜂窝网络的组成：</p><p><img alt=image-26 src=/images/network/image-26.png></p><h4 id=1-4g-lte蜂窝网络>1. 4G LTE蜂窝网络</h4><h5 id=移动设备>移动设备</h5><p>具有全球唯一的64位标识符，称为国际移动用户身份（IMSI），存储在其SIM（用户身份模块）卡上。在4G LTE中，这种设备称为UE（用户设备）。</p><h5 id=基站>基站</h5><p>位于运营商网络的“边缘”，负责管理无线电资源和其覆盖区域内的移动设备。基站协助无线电接入网中的设备认证和资源分配（信道接入）。</p><h4 id=2-lte协议栈>2. LTE协议栈</h4><p>TOPDOWN375</p><h4 id=3-lte无线电接入网>3. LTE无线电接入网</h4><p>LTE在下行信道上使用FDM和TDM的组合，称为正交频分复用（OFDM）。</p><h4 id=4-lte附加功能>4. LTE附加功能</h4><h5 id=网络连接>网络连接</h5><p>三个阶段：</p><p>1.连接到基站</p><p>2.互相鉴别</p><p>3.数据路径配置</p><h5 id=功率管理睡眠模式>功率管理：睡眠模式</h5><p>又有深度睡眠，在不传输或者接收数据时进入睡眠状态</p><h4 id=5-全球蜂窝网络>5. 全球蜂窝网络</h4><p>网络的网络</p><p>有许多归属蜂窝运营商网络，它们也组成网络，通过公共因特网或者互联网协议分组交换IPX进行互连。[IPX是一种专门用于互连蜂窝运营商的被管网络]</p><h4 id=6-5g蜂窝网络>6. 5G蜂窝网络</h4><p>5G核心网络是管理所有5G移动语音、数据和因特网连接的数据网络。</p><h3 id=65-移动性管理原则>6.5 移动性管理原则</h3><p>[4.7 移动IP技术]</p><h4 id=实践中的移动性>实践中的移动性</h4><h2 id=chapter7-网络安全>Chapter7. 网络安全</h2><h3 id=71-基本概念>7.1 基本概念</h3><p>安全通信（secure communication）具有以下若干性质</p><p>保密性（confidentiality）、报文完整性（message integrity）、端点鉴别（end-point authentication）、运行安全性（operational security）</p><h3 id=72-密码学原理>7.2 密码学原理</h3><p>明文（plaintext，cleartext） 密文（ciphertext）</p><p>加密算法（encryption algorithm） 解密算法（decryption algorithm）</p><p>在对称密钥系统（symmetric key system）中，密钥相同且秘密</p><p>在公开密钥系统（public key system，也称为公钥系统）中，使用一对密钥，一个密钥公开，另一个密钥单方知晓</p><h4 id=1对称密钥密码体制>1.对称密钥密码体制</h4><h5 id=单码代替密码>单码代替密码</h5><p>单码代替密码（monoalphabetic cipher），使用字母表中国的一个字母替换另一个字母。并非按照规则的模式进行替换，而是由偏移量k决定。</p><p>即一对一，有26！种配对</p><h5 id=多码代替密码>多码代替密码</h5><p>多码代替密码（polyalphabetic encryption），使用多个单码代替密码，并按照某种次序进行交替选择。</p><h5 id=攻击类别>攻击类别</h5><h6 id=唯密文攻击>唯密文攻击</h6><p>只能截取密文，不了解明文</p><h6 id=已知明文攻击>已知明文攻击</h6><p>确定明文中存在的一些字符，确定明文和密文种的某些匹配</p><h6 id=选择明文攻击>选择明文攻击</h6><p>入侵者能够选择某一明文报文并且得到其对应的密文形式。</p><h5 id=块密码>块密码</h5><p>分块，分成大小为k的块</p><p>块和块之间通过映射表进行转换，映射表为key</p><p>通过公开置乱函数，获得加密结果</p><p>一些流行的块密码包括，<strong>DES</strong>（Data Encryption Standard，数据加密标准），<strong>3DES</strong>和<strong>AES</strong>（Advanced Encryption Standard，高级加密标准）</p><p>DES使用了具有56bit密钥的64比特块</p><p>3DES相当于三次DES，使用不同的密钥</p><p>AES使用了128比特块，能够使用128、192、256比特长的密钥进行操作。</p><h5 id=密码块链接>密码块链接</h5><p>当对报文进行分块时，可能存在一些相同的密文块，容易被识别，为了解决这个问题，可以在密文中混合一些随机性，通过产生随机的异或数即可解决。</p><p>这样的话传输方必须多传输一倍的长度用于传输该随机异或数。因此产生了一种密码块链接（Cipher Block Chaining，CBC）的技术。即第一块使用随机的异或数，后面的每一块所异或的数为前一块的结果。</p><h4 id=2公开密钥加密>2.公开密钥加密</h4><p>公钥（public key）是公开的，接收方B知道私钥（private key）。</p><p>步骤：发送方通过公开的公钥进行加密操作，接收方使用一个众所周知的解密算法，使用密钥进行解密。</p><p>公钥密码体制不仅用于加密，也可以很方便的应用于鉴别和数字签名。</p><p>由于公钥密码算法效率较低，一般用于<strong>会话密钥</strong>的建立，对称密钥密码体制被用于其它大多数情况下的加密。</p><h5 id=rsa>RSA</h5><h6 id=公钥私钥生成>公钥私钥生成</h6><p>1.选取两个大素数p,q</p><p>2.计算n=pq、z=(p-1)(q-1)</p><p>3.选取e，使得gcd(e,z)=1，e&lt;n</p><p>4.求取d ，ed mod z =1</p><p>5.公钥（n,e）私钥（n,d）</p><h6 id=加密过程>加密过程</h6><p>对于一个比特组合，表示成十进制的正数m，m&lt;n</p><p>则对于m的加密值c为 c = m^e mod n ，使用公钥</p><h6 id=解密过程>解密过程</h6><p>对c进行解密：m = c^d mod n，使用私钥</p><h5 id=会话密钥>会话密钥</h5><p>会话密钥（session key），即通过公开密钥加密对一个对称密钥进行加密，随后发送后双方获取该对称密钥，最后通过对称密钥密码体制对大量数据进行加密传输。</p><h5 id=rsa工作原理>RSA工作原理</h5><p>TOPDOWN409</p><h3 id=73-报文完整性和数字签名>7.3 报文完整性和数字签名</h3><h4 id=1-密码散列函数>1. 密码散列函数</h4><p>散列函数以m为输入，得到一个称为散列的定长字符串。checksum和CRC都满足这个定义。</p><p>密码散列函数（cryptographic hash function）具有一种性质：找到任意两个不同的报文x和y使得H(x)和H(y)相等在计算上是不可能的。</p><h5 id=md5>MD5</h5><h5 id=sha-1>SHA-1</h5><p>SHA-1输出160比特的报文摘要，但计算要比MD5慢一些，但实际安全性也没有达到设计目标，很快被SHA-2和SHA-3替代。</p><h4 id=2-报文鉴别码>2. 报文鉴别码</h4><p>1.对报文m计算散列H(m)，比如利用SHA-1</p><p>2.将H(m)附在m后面发送，形成扩展报文(m,H(m))</p><p>3.接收方收到(m,h)后，如果计算H(m)=h，则正常。</p><p>但这种方法只能检测报文是否受损，对实际的报文来源无法判断。</p><p>因此需要通信双方共享一个<strong>鉴别密钥</strong>s</p><p>1.发送方级联m+s，计算H(m+s)，形成拓展报文(m,H(m+s))，发送。 [这个H(m+s)被称为散列报文鉴别码HMAC（Message Authentication Code,MAC）]</p><p>2.接收方接收(m,h)，计算H(m+s)，如果等于h则正常。</p><h4 id=3-数字签名>3. 数字签名</h4><p>数字签名（digital signature）应当是可以鉴别的、不可伪造的。</p><p>采用公钥密码可以实现。签署方通过私钥进行加密，保障了数字签名不可伪造。</p><p>核验方通过公钥进行核实。</p><p>而一般不直接对报文进行签署，这样会带来极大的计算量，可以使用散列算法计算该报文的一个固定长度的数据”指纹“，表示为H(m)，再对散列函数进行签名操作。</p><h4 id=4公钥认证>4.公钥认证</h4><p>数字签名的一个重要应用就是公钥认证（public key certification），即证实一个公钥属于某个特定的实体。</p><p>将公钥和特定实体进行绑定通常是由认证中心（certification Authority，CA）完成的。</p><p>一旦验证，CA会生成一个将其身份和实体的公钥绑定起来的证书（certificate）</p><p>TOPDOWN 415</p><h3 id=74-端点鉴别>7.4 端点鉴别</h3><h4 id=1基本概念-2>1.基本概念</h4><p>通信双方验证另一方身份的一种技术。</p><p>最简单的方法就是使用用户名和口令。</p><p>为了避免用户名和口令在传输过程中被截获，因此要对其进行加密。但也有漏洞，攻击者可以直接截获该加密报文，之后直接发送即可使接收方误判。（重放攻击，Replay Attack，或为playback attack），需要使用不重数nonce，即不重复使用的大随机数。</p><p>不重数可以使用户把重复的实体鉴别请求和新的实体鉴别请求区分开来。</p><p>双方各会发送一个不重数，并等待对方使用对称密钥进行加密操作，随后接收到对方的报文进行解密，获取不重数，若相等即可判定对方的身份。[能够正确加密解密的只有知道对称密钥的加密双方，并且也知道对方是活跃的]</p><h3 id=75-安全电子邮件>7.5 安全电子邮件</h3><h4 id=1概述>1.概述</h4><p>需要保障机密性、完整性、以及对发送方、接收方的鉴别</p><h4 id=2pgp>2.PGP</h4><p>PGP（Pretty Good Privacy）是电子邮件加密方案的一个范例，如TOPDOWN422图8-21</p><p>PGP软件的不同版本使用MD5或SHA来计算报文摘要，使用CAST、三重DES或IDEA进行对称密钥加密，使用RSA进行公开密钥加密。</p><h3 id=76-tls>7.6 TLS</h3><p>传输层安全性（Transport Layer Security，TLS），使TCP连接安全。</p><h4 id=1宏观描述>1.宏观描述</h4><h5 id=握手>握手</h5><h6 id=创建tcp连接>创建TCP连接</h6><p>三次握手</p><h6 id=验证端点真实性>验证端点真实性</h6><p>一方发送TLS Hello报文，另一方回答证书，证书已由CA证实过</p><h6 id=发送主密钥ms>发送主密钥MS</h6><p>用于生成TLS会话所需要的对称密钥。</p><p>该主密钥通过对方的公钥进行加密得到加密后的主密钥（EMS）并发送给对方。</p><p>至此只有通信双方知道了该主密钥</p><h5 id=密钥导出>密钥导出</h5><p>双方都使用MS产生四个密钥，TOPDOWN425.</p><p>密钥导出阶段结束，双方都有了四个密钥，两个加密密钥用于数据加密 ，两个HMAC用于完整性鉴别</p><h5 id=数据传输>数据传输</h5><p>双方共享四个相同的会话密钥，能够进行TCP安全传输。</p><h4 id=2tls记录>2.TLS记录</h4><p>由类型字段、版本字段、长度字段、数据字段和HMAC字段组成。</p><h3 id=77-ipsec和虚拟专用网>7.7 IPSec和虚拟专用网</h3><p>IP安全（IP Security）协议称为IPSec，为网络层提供了安全性。</p><p>为任意两个网络层实体之间的IP数据报提供了安全。</p><p>许多机构使用IPSec创建了运行在公共因特网上的虚拟专用网（Virtual Private Network，VPN）</p><p>对于VPN，其中流量经过因特网之前进行加密。</p><p>在IPSec协议族中，由两个主要协议：鉴别首部（Authentication Header，AH）协议和封装安全性载荷（Encapsulation Security Payload，ESP）协议。</p><h3 id=78-防火墙和入侵检测系统>7.8 防火墙和入侵检测系统</h3><p>防火墙（firewall）是一个硬件和软件的结合体，它将一个机构内部网络与整个因特网隔离开，允许一些数据分组通过而阻止另一些分组。</p><p>防火墙具有三个目标：</p><p>1.从外部到内部和从内部到外部的所有流量都通过防火墙</p><p>2.仅被授权的流量（由本地安全策略定义）允许通过</p><p>3.防火墙自身免于渗透</p><p>Cisco和Check Point使当今两个领先的 防火墙厂商。</p><p>防火墙现在经常在路由器中实现并使用SDN进行远程控制</p><p>防火墙分为三类：传统分组过滤器（traditional packet filter）、状态过滤器（stateful filter）和应用程序网关（application gateway）</p><h2 id=chapter8-多媒体网络>Chapter8. 多媒体网络</h2><h3 id=81-音频>8.1 音频</h3><p><img alt=image-27 src=/images/network/image-27.png></p><p>比特率=采样频率✖量化位数</p><p>举例：</p><p>CD: 1.411 Mbps</p><p>MP3: 96, 128, 160 kbps</p><p>Internet telephony: 5.3 kbps and up</p><h3 id=82-视频>8.2 视频</h3><p><img alt=image-28 src=/images/network/image-28.png></p><p>CBR（constant bit rate）：视频编码固定速率</p><p>VBR:(可变比特率):视频编码速率随空间、时间编码量的变化而变化</p><p>例如：</p><p>MPEG 1 (CD-ROM) 1.5 Mbps</p><p>MPEG2 (DVD) 3-6 Mbps</p><p>MPEG4 (often used in Internet, &lt; 1 Mbps)</p><h3 id=83-多媒体网络>8.3 多媒体网络</h3><p>三种应用类型</p><p><strong>流媒体，存储音频、视频</strong></p><p>streaming: can begin playout before downloading entire file</p><p>流媒体:可以在下载整个文件之前开始播放</p><p>stored (at server): can transmit faster than audio/video will be rendered (implies storing/buffering at client)</p><p>存储(在服务器端):传输速度比音频/视频呈现速度快(意味着在客户端存储/缓冲)</p><p>例如：YouTube，Netflix，Hulu</p><p><strong>IP会话语音/视频</strong></p><p>人与人之间对话的互动性限制了对延迟的容忍</p><p>例如 Skype</p><p><strong>直播音频，视频</strong></p><h4 id=1流式存储视频>1.流式存储视频</h4><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style></div><div class="row items-start justify-between"><div class="lg:col-5 mb-10 flex items-center lg:mb-0"><h5 class=mr-3>标签 :</h5><ul><li class=inline-block><a class="bg-theme-light hover:bg-primary dark:bg-darkmode-theme-light dark:hover:bg-darkmode-primary dark:hover:text-dark m-1 block rounded px-3 py-1 hover:text-white" href=/en/tags/%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%bd%91%e7%bb%9c/>计算机网络</a></li></ul></div></div></article></div></div></section></main><footer class="bg-theme-light dark:bg-darkmode-theme-light"><div class=container><div class="row items-center py-10"><div class="lg:col-3 mb-8 text-center lg:mb-0 lg:text-left"><a class="navbar-brand inline-block" href=/en/><img fetchpriority=high decoding=async class="img logo-light" width=160 height=32 src=/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-1_hubf409f6fc77577ff09f7cacc73653041_8513_320x0_resize_lanczos_3.png"'>
<img fetchpriority=high decoding=async class="img logo-dark" width=160 height=32 src=/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_q80_h2_lanczos_3.webp alt=Hugoplate onerror='this.onerror=null,this.src="/images/logo-2_hu06a606f114baa5722e40403b02652855_7961_320x0_resize_lanczos_3.png"'></a></div><div class="lg:col-6 mb-8 text-center lg:mb-0"><ul><li class="m-3 inline-block"><a href=/en/about/>个人信息</a></li><li class="m-3 inline-block"><a href=/en/blog/>学习笔记</a></li><li class="m-3 inline-block"><a href=/en/privacy-policy/>相关说明</a></li></ul></div><div class="lg:col-3 mb-8 text-center lg:mb-0 lg:mt-0 lg:text-right"><ul class=social-icons><li><a target=_blank aria-label=github rel="nofollow noopener" href=https://www.github.com/COOOIKX><i class="fab fa-github"></i></a></li><li><a target=_blank aria-label=csdn rel="nofollow noopener" href="https://blog.csdn.net/m0_59701064?spm=1000.2115.3001.5343"><i class="fas fa-home-lg"></i></a></li></ul></div></div></div><div class="border-border dark:border-darkmode-border border-t py-7"><div class="text-light dark:text-darkmode-light container text-center"><p>Designed by Zeon Studio and Developed by LHF</p></div></div></footer><script crossorigin=anonymous integrity="sha256-YQerunHGeT7hXzxweSqFUXgOHHxFceSjmMy/kmnAHWU=" src=/js/script.min.6107abba71c6793ee15f3c70792a8551780e1c7c4571e4a398ccbf9269c01d65.js></script><script defer async crossorigin=anonymous integrity="sha256-w+aS42D2+B+Jix+joZ7pAua1vbu/pRK/IhoP55b8n3w=" src=/js/script-lazy.min.c3e692e360f6f81f898b1fa3a19ee902e6b5bdbbbfa512bf221a0fe796fc9f7c.js></script><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js")</script></body></html>